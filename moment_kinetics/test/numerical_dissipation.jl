module NumericalDissipationTests

include("setup.jl")

using Base.Filesystem: tempname

using moment_kinetics.interpolation: interpolate_to_grid_z, interpolate_to_grid_vpa
using moment_kinetics.load_data: get_run_info_no_setup, close_run_info,
                                 postproc_load_variable
using moment_kinetics.type_definitions: mk_float
using moment_kinetics.utils: merge_dict_with_kwargs!

# Useful parameters
const z_L = 1.0 # always 1 in normalized units?
const vpa_L = sqrt(2) * 8.0

# Use very small number of points in vpa_expected to reduce the amount of entries we
# need to store. First and last entries are within the grid (rather than at the ends) in
# order to get non-zero values.
# Note: in the arrays of numbers for expected data, space-separated entries have to stay
# on the same line.
const expected_base =
  (
   z=[z for z in range(-0.5 * z_L, 0.5 * z_L, length=11)],
   vpa=[vpa for vpa in range(-0.2 * vpa_L, 0.2 * vpa_L, length=3)],
   phi=[-1.3862945103834021 -1.2381930549024087; -1.2115184437701383 -1.1305749330849024; -0.8609863297378383 -0.8726047055664554; -0.5494724739047893 -0.5903605405746124; -0.3534597636915619 -0.3755621917538126; -0.2876820724517817 -0.2922033533727333; -0.3534597636915623 -0.37556219175381184; -0.5494724739047894 -0.5903605405746118; -0.8609863297378387 -0.8726047055664548; -1.2115184437701383 -1.1305749330849018; -1.3862945103834021 -1.2381930549024085],
   n_ion=[0.24999996268412486 0.2899075920447096; 0.2977457295906025 0.32284744085352596; 0.4227457487793365 0.417861633367743; 0.5772542482407849 0.5541276844715511; 0.7022542481827599 0.6869033098908922; 0.7499999999999996 0.7466166935122772; 0.7022542481827599 0.6869033098908928; 0.577254248240785 0.5541276844715514; 0.4227457487793365 0.41786163336774323; 0.2977457295906025 0.32284744085352607; 0.2499999626841249 0.2899075920447096],
   n_neutral=[0.7500000000000004 0.7736270906614504; 0.7022542481827604 0.7056606322357771; 0.5772542482407852 0.5582984547455504; 0.42274574877933696 0.40970684686766695; 0.2977457295906026 0.3054171439480648; 0.24999996268412514 0.26822062705191607; 0.2977457295906026 0.3054171439480648; 0.4227457487793371 0.4097068468676669; 0.5772542482407849 0.5582984547455506; 0.7022542481827602 0.7056606322357774; 0.7500000000000003 0.7736270906614503],
   upar_ion=sqrt(2) .* [-5.322469103131685e-18 3.9302328752599536e-18; 5.5962692628312325e-18 -0.18253502019686593; 5.3303105326277203e-17 -0.19682106406428274; 2.7741812322614154e-17 -0.11164490185709657; 7.916343035553234e-18 -0.033864620007744976; -6.745572440641438e-18 -1.3694828691207528e-17; -3.29493523676649e-17 0.03386462000774488; 1.6828473693140143e-17 0.11164490185709654; 3.3858228104962423e-17 0.1968210640642827; 5.889599659406931e-19 0.1825350201968663; -5.322469103131687e-18 1.2614247781750476e-17],
   upar_neutral=sqrt(2) .* [1.4151986223278988e-17 -3.0029012046059456e-17; -3.230397891897036e-18 -0.03601181630069792; -1.1115739998467628e-17 -0.008873956248425146; -1.506397581779682e-17 0.05481155489749537; 1.984016341010256e-17 0.07626828239103677; 3.058448961557067e-17 1.3010426069826053e-17; -4.425137311650691e-18 -0.07626828239103649; 4.289090369393511e-17 -0.05481155489749538; 8.8667200302095e-18 0.008873956248425057; -2.2523670590889133e-17 0.03601181630069798; 1.415198622327899e-17 -3.0146922868216235e-17],
   ppar_ion=2 .* [0.18749940294600148 0.23350116465548806; 0.2090928995170605 0.21982435628956448; 0.2440317605058449 0.20902035851036244; 0.24403180724085652 0.216087623674145; 0.20909325514775876 0.22229703936727682; 0.1874999999999984 0.22269000715638299; 0.2090932551477587 0.2222970393672767; 0.24403180724085652 0.21608762367414489; 0.24403176050584488 0.20902035851036252; 0.20909289951706053 0.21982435628956445; 0.18749940294600148 0.23350116465548812],
   ppar_neutral=2 .* [0.18749999999999836 0.24965070839654366; 0.2090932551477588 0.24542360857651924; 0.24403180724085685 0.22966516684202568; 0.2440317605058452 0.20666615095565452; 0.20909289951706064 0.1932680493473396; 0.18749940294600134 0.19151182470038583; 0.20909289951706053 0.19326804934733974; 0.24403176050584513 0.20666615095565455; 0.24403180724085685 0.2296651668420256; 0.20909325514775878 0.2454236085765192; 0.18749999999999833 0.24965070839654363],
   f_ion=1 ./ sqrt(2 * π) .* [0.03704633061368152 0.040599341664432284 0.042843149717574434 0.03039826712127894 0.012360459051458755 0.006338529257094846 0.01236045905145876 0.030398267121278934 0.042843149717574414 0.04059934166443226 0.037046330613681525; 0.2041161581761397 0.2512319184948211 0.39344122410888177 0.6277900647663589 0.9100364506644042 1.060660171779779 0.910036450664404 0.627790064766359 0.3934412241088816 0.2512319184948211 0.20411615817613968; 0.03704633061368151 0.04059934166443228 0.042843149717574434 0.03039826712127895 0.012360459051458753 0.006338529257094848 0.01236045905145876 0.03039826712127895 0.042843149717574414 0.04059934166443226 0.037046330613681525;;; 0.05409113750217345 0.060942118846170096 0.037355782742174805 0.014156853128452607 0.01104658584038974 0.019606935644145854 0.028227490929074943 0.027774698308480894 0.02679659389228075 0.0357627720666755 0.054091137502173446; 0.21149092307759615 0.24871017738931914 0.3724222925193106 0.5951062370523684 0.884254578364253 1.0490134562986957 0.884254578364253 0.5951062370523682 0.37242229251931064 0.24871017738931928 0.21149092307759615; 0.05409113750217343 0.0357627720666755 0.026796593892280774 0.0277746983084809 0.028227490929074967 0.019606935644145885 0.011046585840389757 0.014156853128452605 0.037355782742174846 0.06094211884617011 0.05409113750217343;;;;],
   f_neutral=1 ./ sqrt(2 * π) .* [0.006338529257094838 0.012360459051458746 0.030398267121279018 0.042843149717574455 0.04059934166443227 0.037046330613681476 0.04059934166443226 0.042843149717574455 0.030398267121279004 0.01236045905145874 0.006338529257094838; 1.0606601717797797 0.9100364506644045 0.6277900647663588 0.39344122410888205 0.25123191849482107 0.20411615817613982 0.25123191849482107 0.393441224108882 0.6277900647663588 0.9100364506644049 1.0606601717797794; 0.006338529257094839 0.012360459051458744 0.030398267121279028 0.04284314971757445 0.04059934166443228 0.03704633061368148 0.04059934166443227 0.04284314971757446 0.030398267121279004 0.012360459051458739 0.006338529257094839;;; 0.02460691323631649 0.041022700076584095 0.042124298266096774 0.03651400962451538 0.03703847070479192 0.04182304082868671 0.03705068809372411 0.01969267434431182 0.008701349527678462 0.010255967550373625 0.02460691323631649; 1.0487290573033359 0.9006415740400324 0.6236602584705063 0.3948639948118976 0.2567421073011552 0.21109313560633794 0.25674210730115526 0.39486399481189755 0.6236602584705063 0.9006415740400329 1.0487290573033357; 0.024606913236316523 0.010255967550373621 0.00870134952767847 0.01969267434431181 0.0370506880937241 0.041823040828686674 0.03703847070479192 0.0365140096245154 0.04212429826609675 0.041022700076584054 0.02460691323631652;;;;])

const expected_split_1 =
  (
   z=[z for z in range(-0.5 * z_L, 0.5 * z_L, length=11)],
   vpa=[vpa for vpa in range(-0.2 * vpa_L, 0.2 * vpa_L, length=3)],
   phi=[-1.3862943611198904 -1.238180625489492; -1.2115183691070182 -1.13057615902551; -0.8609863227503217 -0.872603536898021; -0.5494724738535587 -0.590357978134456; -0.35345976369155996 -0.3755616641479863; -0.28768207245178096 -0.2922007439239164; -0.35345976369155996 -0.3755616641479877; -0.5494724738535587 -0.5903579781344562; -0.8609863227503217 -0.8726035368980204; -1.2115183691070182 -1.13057615902551; -1.3862943611198906 -1.2381806254894923],
   n_ion=[0.25 0.2899111954482727; 0.2977457518173807 0.322847534762928; 0.4227457517297449 0.41786263774455534; 0.577254248270255 0.5541288837642595; 0.7022542481826192 0.6869034153137056; 0.7500000000000001 0.7466186417728669; 0.7022542481826192 0.6869034153137046; 0.577254248270255 0.5541288837642594; 0.4227457517297449 0.41786263774455545; 0.2977457518173807 0.3228475347629278; 0.25 0.2899111954482727],
   n_neutral=[0.7500000000000001 0.7736225137539305; 0.7022542481826193 0.7056608827990463; 0.577254248270255 0.558298733944617; 0.4227457517297449 0.4097073070742386; 0.2977457518173807 0.305416887556487; 0.25 0.26822367956929494; 0.2977457518173807 0.30541688755648705; 0.422745751729745 0.4097073070742387; 0.5772542482702551 0.5582987339446172; 0.7022542481826193 0.7056608827990465; 0.75 0.7736225137539307],
   upar_ion=sqrt(2) .* [2.338994838466916e-17 -4.675486343572177e-16; -5.703062170682306e-17 -0.18253837538520337; 3.590133812548222e-17 -0.19682242326269306; -6.124907692879937e-18 -0.11164636926420228; -6.045193458438667e-18 -0.033866451810154845; 3.157994482588082e-17 2.39220739029454e-16; -1.4574121535622858e-17 0.033866451810155865; 1.4526377132094358e-17 0.1116463692642019; -2.838259781712915e-17 0.1968224232626933; -7.217635564312387e-17 0.18253837538520312; 2.338994838466916e-17 -4.991021077831635e-16],
   upar_neutral=sqrt(2) .* [1.0414877805748774e-17 1.7558315370223843e-16; -2.1695337624225053e-17 -0.036010551291546206; -1.2706927603542093e-17 -0.008872851795435335; -2.9614930101475584e-18 0.05481196455572733; 4.268856815479238e-17 0.07626993604851698; -2.39841627270474e-17 1.2243014219613657e-16; 4.268856815479238e-17 -0.07626993604851655; -2.9614930101475584e-18 -0.05481196455572715; -1.2706927603542093e-17 0.008872851795435665; -2.1695337624225053e-17 0.03601055129154609; 1.0414877805748774e-17 1.7705748725882887e-16],
   ppar_ion=2 .* [0.18749943093282284 0.23350301940406093; 0.20909291512561226 0.21982447766832633; 0.2440317622089254 0.209021562800747; 0.24403180725332627 0.21608771531333332; 0.2090932551477392 0.22229678022925947; 0.18749999999999836 0.22269103917130412; 0.20909325514773922 0.22229678022925925; 0.24403180725332624 0.21608771531333326; 0.24403176220892547 0.209021562800747; 0.2090929151256123 0.2198244776683263; 0.18749943093282284 0.2335030194040609],
   ppar_neutral=2 .* [0.18749999999999817 0.24965000905238305; 0.20909325514773897 0.24542310128152242; 0.2440318072533265 0.22966456824824086; 0.2440317622089255 0.20666663140895455; 0.20909291512561218 0.19326737586368212; 0.18749943093282273 0.19151348906298848; 0.20909291512561215 0.19326737586368217; 0.24403176220892547 0.20666663140895453; 0.24403180725332657 0.22966456824824033; 0.20909325514773894 0.2454231012815224; 0.18749999999999822 0.24965000905238305],
   f_ion=1 ./ sqrt(2 * π) .* [0.037046336143347326 0.04059934469504523 0.04284315001650318 0.03039826712283314 0.012360459051463546 0.006338529257094833 0.012360459051463542 0.030398267122833115 0.04284315001650319 0.04059934469504524 0.037046336143347326; 0.20411618864323644 0.2512319372496666 0.39344122685499894 0.6277900647984213 0.9100364506642306 1.0606601717797788 0.9100364506642304 0.6277900647984217 0.39344122685499905 0.2512319372496667 0.20411618864323647; 0.037046336143347326 0.040599344695045246 0.042843150016503184 0.03039826712283314 0.012360459051463548 0.006338529257094834 0.01236045905146354 0.03039826712283312 0.04284315001650319 0.04059934469504525 0.037046336143347326;;; 0.05409145940947649 0.060943941669386506 0.03735761263270581 0.014156586621401781 0.011045852781034392 0.019607061456321972 0.02822706079898684 0.027774488203250222 0.026796500032547958 0.035762355775361666 0.05409145940947649; 0.21149605745985914 0.24870969888628217 0.37242214770522797 0.5951066874748036 0.8842546848469796 1.049015435868931 0.8842546848469771 0.5951066874748059 0.37242214770522847 0.2487096988862821 0.2114960574598592; 0.054091459409476565 0.03576235577536164 0.026796500032547955 0.027774488203250233 0.028227060798986806 0.019607061456322007 0.011045852781034409 0.014156586621401705 0.0373576126327059 0.06094394166938644 0.05409145940947656;;;;],
   f_neutral=1 ./ sqrt(2 * π) .* [0.006338529257094832 0.012360459051463532 0.030398267122833188 0.042843150016503156 0.040599344695045246 0.037046336143347264 0.04059934469504524 0.04284315001650315 0.030398267122833195 0.012360459051463525 0.006338529257094833; 1.060660171779779 0.9100364506642311 0.6277900647984211 0.39344122685499894 0.2512319372496666 0.20411618864323658 0.25123193724966664 0.3934412268549989 0.6277900647984211 0.910036450664231 1.0606601717797788; 0.006338529257094833 0.012360459051463536 0.030398267122833195 0.042843150016503156 0.04059934469504525 0.03704633614334726 0.04059934469504525 0.04284315001650315 0.030398267122833188 0.012360459051463529 0.006338529257094835;;; 0.024606929830002813 0.041022030670607904 0.042123928220688424 0.036513873288623495 0.03703801819048903 0.04182331769147937 0.03705113850889755 0.019693299054008098 0.008701498945582899 0.010255566549717545 0.024606929830002813; 1.0487202680564205 0.9006422142250379 0.6236603860005226 0.39486373427610055 0.2567416532346824 0.21109902137130615 0.25674165323468234 0.3948637342760998 0.6236603860005219 0.9006422142250398 1.0487202680564205; 0.024606929830002837 0.010255566549717541 0.008701498945582925 0.01969329905400806 0.037051138508897574 0.04182331769147937 0.03703801819048906 0.03651387328862351 0.04212392822068844 0.04102203067060788 0.024606929830002837;;;;])

const expected_split_2 =
  (
   z=[z for z in range(-0.5 * z_L, 0.5 * z_L, length=11)],
   vpa=[vpa for vpa in range(-0.2 * vpa_L, 0.2 * vpa_L, length=3)],
   phi=[-1.3862943611198904 -1.2382494991522677; -1.2115183691070182 -1.130562742769802; -0.8609863227503217 -0.8725656226405772; -0.5494724738535587 -0.5903630080535703; -0.35345976369155996 -0.3755683564715657; -0.28768207245178096 -0.2922024177546436; -0.35345976369155996 -0.3755683564715652; -0.5494724738535587 -0.5903630080535714; -0.8609863227503217 -0.872565622640577; -1.2115183691070182 -1.1305627427698017; -1.3862943611198906 -1.2382494991522677],
   n_ion=[0.25 0.28989122888995544; 0.2977457518173807 0.3228518641385622; 0.4227457517297449 0.41787846020815034; 0.577254248270255 0.5541260404788704; 0.7022542481826192 0.6868987445562768; 0.7500000000000001 0.7466173920606887; 0.7022542481826192 0.6868987445562766; 0.577254248270255 0.5541260404788696; 0.4227457517297449 0.4178784602081504; 0.2977457518173807 0.3228518641385623; 0.25 0.2898912288899555],
   n_neutral=[0.7500000000000001 0.7736195438623932; 0.7022542481826193 0.7056642279551343; 0.577254248270255 0.558297936952642; 0.4227457517297449 0.4097097931830055; 0.2977457518173807 0.3054201608536712; 0.25 0.26821938844842186; 0.2977457518173807 0.30542016085367096; 0.422745751729745 0.4097097931830053; 0.5772542482702551 0.5582979369526416; 0.7022542481826193 0.7056642279551346; 0.75 0.7736195438623932],
   upar_ion=sqrt(2) .* [0.0 -5.175710120902677e-16; 0.0 -0.18249717913543187; 0.0 -0.19681885842008132; 0.0 -0.11168640644516459; 0.0 -0.03388221058493795; 0.0 -4.818601030340264e-17; 0.0 0.03388221058493834; 0.0 0.11168640644516489; 0.0 0.19681885842008107; 0.0 0.1824971791354317; -0.0 -5.27350375548761e-16],
   upar_neutral=sqrt(2) .* [0.0 6.148103944350614e-17; 0.0 -0.0360092383464998; 0.0 -0.008867277148067362; 0.0 0.05481746377254148; 0.0 0.07626599487340505; 0.0 7.899666435318836e-16; 0.0 -0.07626599487340545; 0.0 -0.05481746377254165; 0.0 0.008867277148067204; 0.0 0.0360092383464995; -0.0 6.03784524628426e-17],
   ppar_ion=2 .* [0.1874994309328228 0.2334682478836411; 0.2090929151256122 0.21982176586308982; 0.24403176220892536 0.2090396306587747; 0.24403180725332618 0.21608121734167476; 0.20909325514773913 0.2222883951812621; 0.1874999999999984 0.22268864178782843; 0.20909325514773922 0.22228839518126203; 0.24403180725332613 0.2160812173416748; 0.24403176220892536 0.20903963065877473; 0.20909291512561226 0.21982176586309007; 0.18749943093282284 0.23346824788364107],
   ppar_neutral=2 .* [0.18749999999999817 0.249646324476199; 0.20909325514773897 0.24542392485865092; 0.2440318072533265 0.22966109631282366; 0.24403176220892553 0.2066686464013989; 0.20909291512561218 0.19326911907791047; 0.1874994309328227 0.19150729331355057; 0.20909291512561218 0.1932691190779105; 0.2440317622089255 0.2066686464013988; 0.24403180725332657 0.22966109631282353; 0.20909325514773894 0.24542392485865105; 0.18749999999999822 0.24964632447619903],
   f_ion=1 ./ sqrt(2 * π) .* [0.03704633614334732 0.040599344695045246 0.042843150016503184 0.030398267122833132 0.01236045905146355 0.006338529257094844 0.012360459051463546 0.030398267122833115 0.04284315001650319 0.04059934469504525 0.037046336143347326; 0.20411618864323644 0.2512319372496666 0.39344122685499894 0.6277900647984213 0.9100364506642306 1.0606601717797788 0.9100364506642304 0.6277900647984217 0.39344122685499905 0.2512319372496667 0.20411618864323647; 0.03704633614334731 0.040599344695045246 0.042843150016503184 0.03039826712283313 0.012360459051463546 0.006338529257094835 0.01236045905146354 0.03039826712283312 0.04284315001650319 0.040599344695045246 0.037046336143347326;;; 0.0540816114896888 0.060934605961342654 0.03735861636133073 0.014159296028219515 0.01104687169487968 0.019606859746230713 0.028224235787460937 0.027771594206144244 0.0268022131617903 0.03576356996640618 0.0540816114896888; 0.2115092188695118 0.2487197997372121 0.37241835684661745 0.5950862057435488 0.8842499772975275 1.0490202561606392 0.8842499772975279 0.5950862057435466 0.37241835684661756 0.2487197997372115 0.21150921886951182; 0.05408161148968862 0.03576356996640618 0.026802213161790253 0.027771594206144175 0.028224235787461065 0.01960685974623076 0.011046871694879718 0.014159296028219567 0.03735861636133073 0.06093460596134263 0.054081611489688604;;;;],
   f_neutral=1 ./ sqrt(2 * π) .* [0.006338529257094825 0.01236045905146353 0.0303982671228332 0.04284315001650314 0.04059934469504523 0.03704633614334727 0.040599344695045246 0.04284315001650314 0.03039826712283319 0.012360459051463527 0.006338529257094832; 1.060660171779779 0.9100364506642311 0.6277900647984211 0.39344122685499894 0.2512319372496666 0.20411618864323658 0.25123193724966664 0.3934412268549989 0.6277900647984211 0.910036450664231 1.0606601717797788; 0.006338529257094838 0.012360459051463536 0.03039826712283321 0.04284315001650318 0.04059934469504525 0.03704633614334726 0.04059934469504525 0.04284315001650317 0.030398267122833195 0.012360459051463536 0.006338529257094835;;; 0.024606358680751818 0.04102279922695332 0.042122660090204114 0.03651455863926972 0.037038388082486946 0.04182167904282616 0.037050179263223564 0.019692638464189446 0.008701805173294618 0.010256635199256663 0.024606358680751825; 1.0487295466195101 0.9006499700483019 0.6236616589268252 0.39486120293610183 0.25674243403750296 0.2111040490879551 0.25674243403750274 0.394861202936102 0.6236616589268231 0.9006499700483025 1.0487295466195103; 0.024606358680751766 0.010256635199256648 0.008701805173294585 0.01969263846418945 0.03705017926322349 0.041821679042826236 0.03703838808248692 0.03651455863926968 0.042122660090203996 0.0410227992269533 0.02460635868075177;;;;])

const expected_split_3 =
  (
   z=[z for z in range(-0.5 * z_L, 0.5 * z_L, length=11)],
   vpa=[vpa for vpa in range(-0.2 * vpa_L, 0.2 * vpa_L, length=3)],
   phi=[-1.3862943611198904 -1.3410604159928767; -1.2115183691070182 -1.1891033501768347; -0.8609863227503217 -0.8667622960862232; -0.5494724738535587 -0.5611428362961878; -0.35345976369155996 -0.3582216057775794; -0.28768207245178096 -0.2878511626759006; -0.35345976369155996 -0.35822160577757967; -0.5494724738535587 -0.5611428362961881; -0.8609863227503217 -0.8667622960862233; -1.2115183691070182 -1.1891033501768347; -1.3862943611198906 -1.3410604159928763],
   n_ion=[0.25 0.26156815041405423; 0.2977457518173807 0.304494585100724; 0.4227457517297449 0.4203106294484473; 0.577254248270255 0.5705565656493798; 0.7022542481826192 0.6989180982209259; 0.7500000000000001 0.7498731930531198; 0.7022542481826192 0.6989180982209257; 0.577254248270255 0.5705565656493797; 0.4227457517297449 0.4203106294484474; 0.2977457518173807 0.30449458510072414; 0.25 0.2615681504140543],
   n_neutral=[0.7500000000000001 0.7562236855920123; 0.7022542481826193 0.7038678239804391; 0.577254248270255 0.5721816543686578; 0.4227457517297449 0.4183210332732288; 0.2977457518173807 0.29971730807243047; 0.25 0.2556005572158133; 0.2977457518173807 0.29971730807243074; 0.422745751729745 0.4183210332732289; 0.5772542482702551 0.572181654368658; 0.7022542481826193 0.7038678239804391; 0.75 0.7562236855920125],
   upar_ion=sqrt(2) .* [0.0 1.5448525705202831e-16; 0.0 -0.12344561643556345; 0.0 -0.11183610843013142; 0.0 -0.04890449447335265; 0.0 -0.008550576834215333; 0.0 -3.3993189766680625e-16; 0.0 0.00855057683421543; 0.0 0.048904494473352794; 0.0 0.11183610843013098; 0.0 0.12344561643556345; -0.0 1.568218326303893e-16],
   upar_neutral=sqrt(2) .* [0.0 4.1112438160881976e-17; 0.0 -0.025330511475139383; 0.0 -0.015155985492965745; 0.0 0.028676872116278077; 0.0 0.053872239119132706; 0.0 -3.9326045675122656e-17; 0.0 -0.053872239119132866; 0.0 -0.028676872116277792; 0.0 0.01515598549296564; 0.0 0.02533051147513927; -0.0 3.7314886481678394e-17],
   ppar_ion=2.0 .* [0.18749999999999994 0.2024096966161706; 0.20909325514551122 0.20917973335862214; 0.24403180771238278 0.22940953972618822; 0.24403180771238273 0.237259720573313; 0.20909325514551122 0.21547295138054193; 0.18750000000000003 0.19751277226413; 0.2090932551455111 0.21547295138054173; 0.24403180771238273 0.23725972057331293; 0.24403180771238267 0.22940953972618813; 0.20909325514551125 0.2091797333586223; 0.18749999999999997 0.2024096966161706],
   ppar_neutral=2.0 .* [0.1875 0.20275838309775968; 0.20909325514551122 0.22120227413520097; 0.24403180771238273 0.2423738014042952; 0.24403180771238278 0.23029249211046218; 0.20909325514551122 0.20202587578677236; 0.18750000000000003 0.18958480336423889; 0.20909325514551116 0.2020258757867725; 0.24403180771238273 0.23029249211046218; 0.24403180771238273 0.24237380140429515; 0.2090932551455112 0.22120227413520077; 0.18750000000000006 0.20275838309775968],
   f_ion=1 ./ sqrt(2 * π) .* [0.037042345614447574 0.0405970271888346 0.04284290360293411 0.030398143252017087 0.012360617317829854 0.006338529163807182 0.012360617317829838 0.03039814325201708 0.042842903602934045 0.040597027188834595 0.03704234561444758; 0.20412414523193134 0.2512368646175053 0.3934419598036804 0.6277900735244583 0.9100364506161074 1.06066017177982 0.9100364506161075 0.6277900735244585 0.39344195980368063 0.2512368646175052 0.20412414523193137; 0.03704234561444755 0.04059702718883457 0.04284290360293412 0.030398143252017094 0.012360617317829862 0.006338529163807179 0.012360617317829833 0.030398143252017087 0.042842903602934065 0.040597027188834595 0.03704234561444755;;; 0.04176482887372716 0.052954695953583146 0.04522290967713109 0.020752350969539583 0.008279295857789495 0.010160857937883598 0.022577155288435104 0.033333808371896236 0.033174649610147884 0.03273396787748028 0.04176482887372716; 0.20770962236443427 0.2515976254129971 0.38816172951818584 0.6191710112157621 0.9031560897223709 1.0570581516424837 0.9031560897223725 0.6191710112157628 0.3881617295181868 0.251597625412997 0.20770962236443424; 0.041764828873727185 0.03273396787748027 0.03317464961014801 0.03333380837189635 0.022577155288435204 0.010160857937883575 0.008279295857789469 0.02075235096953956 0.045222909677130864 0.05295469595358309 0.04176482887372717;;;;],
   f_neutral=1 ./ sqrt(2 * π) .* [0.00633852916380715 0.012360617317829867 0.03039814325201707 0.042842903602934065 0.040597027188834574 0.03704234561444762 0.04059702718883456 0.04284290360293402 0.030398143252017056 0.012360617317829845 0.006338529163807165; 1.0606601717798207 0.910036450616107 0.6277900735244584 0.3934419598036806 0.2512368646175055 0.2041241452319313 0.2512368646175054 0.3934419598036805 0.6277900735244586 0.910036450616107 1.060660171779821; 0.006338529163807149 0.012360617317829873 0.030398143252017056 0.04284290360293409 0.04059702718883454 0.037042345614447615 0.04059702718883454 0.04284290360293403 0.030398143252017035 0.012360617317829848 0.006338529163807161;;; 0.010932355179185666 0.027121861760355546 0.04169305638577648 0.041043121512992144 0.036429365890077586 0.03867252777691384 0.04267831203051185 0.034130814906680115 0.01583812551124039 0.00731425907658881 0.010932355179185657; 1.0570042458076736 0.9069771295495517 0.6265516576166398 0.3946001364964859 0.25418208827778926 0.20765673845079288 0.25418208827778965 0.3946001364964865 0.6265516576166412 0.906977129549551 1.0570042458076743; 0.010932355179185657 0.00731425907658882 0.015838125511240368 0.03413081490668013 0.04267831203051179 0.03867252777691371 0.03642936589007753 0.04104312151299221 0.04169305638577652 0.027121861760355408 0.010932355179185643;;;;])

# default inputs for tests
test_input = OptionsDict("composition" => OptionsDict("n_ion_species" => 1,
                                                      "n_neutral_species" => 1,
                                                      "electron_physics" => "boltzmann_electron_response",
                                                      "T_e" => 1.0),
                         "ion_species_1" => OptionsDict("initial_density" => 0.5,
                                                        "initial_temperature" => 0.3333333333333333),
                         "z_IC_ion_species_1" => OptionsDict("initialization_option" => "sinusoid",
                                                             "density_amplitude" => 0.5,
                                                             "density_phase" => 0.0,
                                                             "upar_amplitude" => 0.0,
                                                             "upar_phase" => 0.0,
                                                             "temperature_amplitude" => 0.5,
                                                             "temperature_phase" => mk_float(π)),
                         "neutral_species_1" => OptionsDict("initial_density" => 0.5,
                                                            "initial_temperature" => 0.3333333333333333),
                         "z_IC_neutral_species_1" => OptionsDict("initialization_option" => "sinusoid",
                                                                 "density_amplitude" => 0.5,
                                                                 "density_phase" => mk_float(π),
                                                                 "upar_amplitude" => 0.0,
                                                                 "upar_phase" => 0.0,
                                                                 "temperature_amplitude" => 0.5,
                                                                 "temperature_phase" => 0.0),
                         "output" => OptionsDict("run_name" => "numerical_dissipation"),
                         "evolve_moments" => OptionsDict("density" => false,
                                                         "parallel_flow" => false,
                                                         "moments_conservation" => true,
                                                         "pressure" => false),
                         "reactions" => OptionsDict("charge_exchange_frequency" => 0.8885765876316732,
                                                    "ionization_frequency" => 0.0),
                         "timestepping" => OptionsDict("nstep" => 100,
                                                       "dt" => 0.0007071067811865475,
                                                       "nwrite" => 100,
                                                       "nwrite_dfns" => 100,
                                                       "split_operators" => false),
                         "r" => OptionsDict("ngrid" => 1,
                                            "nelement" => 1,
                                            "bc" => "periodic",
                                            "discretization" => "chebyshev_pseudospectral"),
                         "z" => OptionsDict("ngrid" => 9,
                                            "nelement" => 4,
                                            "discretization" => "chebyshev_pseudospectral",
                                            "bc" => "periodic"),
                         "vpa" => OptionsDict("ngrid" => 9,
                                              "nelement" => 16,
                                              "L" => vpa_L,
                                              "discretization" => "gausslegendre_pseudospectral",
                                              "bc" => "zero"),
                         "vz" => OptionsDict("ngrid" => 9,
                                             "nelement" => 16,
                                             "L" => vpa_L,
                                             "discretization" => "gausslegendre_pseudospectral",
                                             "bc" => "zero"),
                         "ion_numerical_dissipation" => OptionsDict("vpa_dissipation_coefficient" => 0.028284271247461905),
                         "neutral_numerical_dissipation" => OptionsDict("vz_dissipation_coefficient" => 0.028284271247461905))

if global_size[] > 2 && global_size[] % 2 == 0
    # Test using distributed-memory
    test_input["z"]["nelement_local"] = test_input["z"]["nelement"] ÷ 2
end

test_input_split_1_moment =
    recursive_merge(test_input,
                    OptionsDict("output" => OptionsDict("run_name" => "numerical_dissipation_split_1_moment"),
                                "evolve_moments" => OptionsDict("density" => true)))

test_input_split_2_moments =
    recursive_merge(test_input_split_1_moment,
                    OptionsDict("output" => OptionsDict("run_name" => "numerical_dissipation_split_2_moments"),
                                "evolve_moments" => OptionsDict("parallel_flow" => true)))

test_input_split_3_moments =
    recursive_merge(test_input_split_2_moments,
                    OptionsDict("output" => OptionsDict("run_name" => "numerical_dissipation_split_3_moments"),
                                "evolve_moments" => OptionsDict("pressure" => true),
                                "timestepping" => OptionsDict("dt" => 0.00035355339059327376),
                                "vpa" => OptionsDict("L" => 20.784609690826528),
                                "vz" => OptionsDict("L" => 20.784609690826528),
                                "ion_numerical_dissipation" => OptionsDict("vpa_dissipation_coefficient" => 0.042426406871192854),
                                "neutral_numerical_dissipation" => OptionsDict("vz_dissipation_coefficient" => 0.042426406871192854),
                               ))

"""
Run a sound-wave test for a single set of parameters
"""
# Note 'name' should not be shared by any two tests in this file
function run_test(test_input, expected, rtol, atol, upar_rtol=nothing; args...)
    # by passing keyword arguments to run_test, args becomes a Dict which can be used to
    # update the default inputs

    # Make a copy to make sure nothing modifies the input Dicts defined in this test
    # script.
    input = deepcopy(test_input)

    if upar_rtol === nothing
        upar_rtol = rtol
    end

    # Convert keyword arguments to a unique name
    name = input["output"]["run_name"]
    if length(args) > 0
        name = string(name, "_", (string(k, "-", v, "_") for (k, v) in args)...)

        # Remove trailing "_"
        name = chop(name)
    end

    # Provide some progress info
    println("    - testing ", name)

    # Update default inputs with values to be changed
    merge_dict_with_kwargs!(input; args...)
    input["output"]["run_name"] = name

    # Suppress console output while running
    quietoutput() do
        # run simulation
        run_moment_kinetics(input)
    end

    phi = nothing
    n_ion = nothing
    upar_ion = nothing
    ppar_ion = nothing
    f_ion = nothing
    n_neutral = nothing
    upar_neutral = nothing
    ppar_neutral = nothing
    f_neutral = nothing
    z, z_spectral = nothing, nothing
    vpa, vpa_spectral = nothing, nothing

    if global_rank[] == 0
        quietoutput() do

            # Load and analyse output
            #########################

            path = joinpath(realpath(input["output"]["base_directory"]), name)

            # open the output file(s)
            run_info = get_run_info_no_setup(path; dfns=true)

            # load species, time coordinate data
            n_ion_species = run_info.composition.n_ion_species
            n_neutral_species = run_info.composition.n_neutral_species
            ntime = run_info.nt
            time = run_info.time
            
            # load fields data
            phi_zrt = postproc_load_variable(run_info, "phi")
            Er_zrt = postproc_load_variable(run_info, "Er")
            Ez_zrt = postproc_load_variable(run_info, "Ez")

            # load velocity moments data
            n_ion_zrst = postproc_load_variable(run_info, "density")
            upar_ion_zrst = postproc_load_variable(run_info, "parallel_flow")
            ppar_ion_zrst = postproc_load_variable(run_info, "parallel_pressure")
            qpar_ion_zrst = postproc_load_variable(run_info, "parallel_heat_flux")
            v_t_ion_zrst = postproc_load_variable(run_info, "thermal_speed")
            n_neutral_zrst = postproc_load_variable(run_info, "density_neutral")
            upar_neutral_zrst = postproc_load_variable(run_info, "uz_neutral")
            ppar_neutral_zrst = postproc_load_variable(run_info, "pz_neutral")
            qpar_neutral_zrst = postproc_load_variable(run_info, "qz_neutral")
            v_t_neutral_zrst = postproc_load_variable(run_info, "thermal_speed_neutral")
            z = run_info.z
            z_spectral = run_info.z_spectral

            # load particle distribution function (pdf) data
            f_ion_vpavperpzrst = postproc_load_variable(run_info, "f")
            f_neutral_vzvrvzetazrst = postproc_load_variable(run_info, "f_neutral")
            vpa = run_info.vpa
            vpa_spectral = run_info.vpa_spectral

            close_run_info(run_info)
            
            phi = phi_zrt[:,1,:]
            n_ion = n_ion_zrst[:,1,:,:]
            upar_ion = upar_ion_zrst[:,1,:,:]
            ppar_ion = ppar_ion_zrst[:,1,:,:]
            qpar_ion = qpar_ion_zrst[:,1,:,:]
            v_t_ion = v_t_ion_zrst[:,1,:,:]
            f_ion = f_ion_vpavperpzrst[:,1,:,1,:,:]
            n_neutral = n_neutral_zrst[:,1,:,:]
            upar_neutral = upar_neutral_zrst[:,1,:,:]
            ppar_neutral = ppar_neutral_zrst[:,1,:,:]
            qpar_neutral = qpar_neutral_zrst[:,1,:,:]
            v_t_neutral = v_t_neutral_zrst[:,1,:,:]
            f_neutral = f_neutral_vzvrvzetazrst[:,1,1,:,1,:,:]

            # Unnormalize f
            if input["evolve_moments"]["density"]
                for it ∈ 1:length(time), is ∈ 1:n_ion_species, iz ∈ 1:z.n
                    f_ion[:,iz,is,it] .*= n_ion[iz,is,it]
                end
                for it ∈ 1:length(time), isn ∈ 1:n_neutral_species, iz ∈ 1:z.n
                    f_neutral[:,iz,isn,it] .*= n_neutral[iz,isn,it]
                end
            end
            if input["evolve_moments"]["pressure"]
                for it ∈ 1:length(time), is ∈ 1:n_ion_species, iz ∈ 1:z.n
                    f_ion[:,iz,is,it] ./= v_t_ion[iz,is,it]
                end
                for it ∈ 1:length(time), isn ∈ 1:n_neutral_species, iz ∈ 1:z.n
                    f_neutral[:,iz,isn,it] ./= v_t_neutral[iz,isn,it]
                end
            end
        end

        # Test against values interpolated onto 'expected' grid which is fairly coarse no we
        # do not have to save too much data in this file

        # Use commented-out lines to get the test data to put in `expected`
        #newgrid_phi = cat(interpolate_to_grid_z(expected.z, phi[:, 1], z, z_spectral),
        #                   interpolate_to_grid_z(expected.z, phi[:, 2], z, z_spectral);
        #                   dims=2)
        #println("phi ", size(newgrid_phi))
        #println(newgrid_phi)
        #println()
        #newgrid_n_ion = cat(interpolate_to_grid_z(expected.z, n_ion[:, :, 1], z, z_spectral)[:,1],
        #                        interpolate_to_grid_z(expected.z, n_ion[:, :, 2], z, z_spectral)[:,1];
        #                        dims=2)
        #println("n_ion ", size(newgrid_n_ion))
        #println(newgrid_n_ion)
        #println()
        #newgrid_n_neutral = cat(interpolate_to_grid_z(expected.z, n_neutral[:, :, 1], z, z_spectral)[:,1],
        #                        interpolate_to_grid_z(expected.z, n_neutral[:, :, 2], z, z_spectral)[:,1];
        #                        dims=2)
        #println("n_neutral ", size(newgrid_n_neutral))
        #println(newgrid_n_neutral)
        #println()
        #newgrid_upar_ion = cat(interpolate_to_grid_z(expected.z, upar_ion[:, :, 1], z, z_spectral)[:,1],
        #                           interpolate_to_grid_z(expected.z, upar_ion[:, :, 2], z, z_spectral)[:,1];
        #                           dims=2)
        #println("upar_ion ", size(newgrid_upar_ion))
        #println(newgrid_upar_ion)
        #println()
        #newgrid_upar_neutral = cat(interpolate_to_grid_z(expected.z, upar_neutral[:, :, 1], z, z_spectral)[:,1],
        #                           interpolate_to_grid_z(expected.z, upar_neutral[:, :, 2], z, z_spectral)[:,1];
        #                           dims=2)
        #println("upar_neutral ", size(newgrid_upar_neutral))
        #println(newgrid_upar_neutral)
        #println()
        #newgrid_ppar_ion = cat(interpolate_to_grid_z(expected.z, ppar_ion[:, :, 1], z, z_spectral)[:,1],
        #                           interpolate_to_grid_z(expected.z, ppar_ion[:, :, 2], z, z_spectral)[:,1];
        #                           dims=2)
        #println("ppar_ion ", size(newgrid_ppar_ion))
        #println(newgrid_ppar_ion)
        #println()
        #newgrid_ppar_neutral = cat(interpolate_to_grid_z(expected.z, ppar_neutral[:, :, 1], z, z_spectral)[:,1],
        #                           interpolate_to_grid_z(expected.z, ppar_neutral[:, :, 2], z, z_spectral)[:,1];
        #                           dims=2)
        #println("ppar_neutral ", size(newgrid_ppar_neutral))
        #println(newgrid_ppar_neutral)
        #println()
        #newgrid_vth_ion = @. sqrt(2.0/3.0*newgrid_ppar_ion/newgrid_n_ion)
        #f1 = interpolate_to_grid_z(expected.z, f_ion[:, :, :, 1], z, z_spectral)
        #f2 = interpolate_to_grid_z(expected.z, f_ion[:, :, :, 2], z, z_spectral)
        #newgrid_f_ion1 = fill(NaN, length(expected.vpa), size(f1, 2), size(f1, 3),
        #                      size(f1, 4))
        #for iz ∈ 1:length(expected.z)
        #    wpa = copy(expected.vpa)
        #    if input["evolve_moments"]["parallel_flow"]
        #        wpa .-= newgrid_upar_ion[iz,1]
        #    end
        #    if input["evolve_moments"]["pressure"]
        #        wpa ./= newgrid_vth_ion[iz,1]
        #    end
        #    newgrid_f_ion1[:,iz,1] = interpolate_to_grid_vpa(wpa, f1[:,iz,1], vpa, vpa_spectral)
        #end
        #newgrid_f_ion2 = fill(NaN, length(expected.vpa), size(f2, 2), size(f2, 3),
        #                      size(f2, 4))
        #for iz ∈ 1:length(expected.z)
        #    wpa = copy(expected.vpa)
        #    if input["evolve_moments"]["parallel_flow"]
        #        wpa .-= newgrid_upar_ion[iz,2]
        #    end
        #    if input["evolve_moments"]["pressure"]
        #        wpa ./= newgrid_vth_ion[iz,2]
        #    end
        #    newgrid_f_ion2[:,iz,1] = interpolate_to_grid_vpa(wpa, f2[:,iz,1], vpa, vpa_spectral)
        #end
        #newgrid_f_ion = cat(newgrid_f_ion1, newgrid_f_ion2; dims=3)
        #println("f_ion ", size(newgrid_f_ion))
        #println(newgrid_f_ion)
        #println()
        #newgrid_vth_neutral = @. sqrt(2.0/3.0*newgrid_ppar_neutral/newgrid_n_neutral)
        #fn1 = interpolate_to_grid_z(expected.z, f_neutral[:, :, :, 1], z, z_spectral)
        #fn2 = interpolate_to_grid_z(expected.z, f_neutral[:, :, :, 2], z, z_spectral)
        #newgrid_f_neutral1 = fill(NaN, length(expected.vpa), size(fn1, 2), size(fn1, 3),
        #                          size(fn1, 4))
        #for iz ∈ 1:length(expected.z)
        #    wpa = copy(expected.vpa)
        #    if input["evolve_moments"]["parallel_flow"]
        #        wpa .-= newgrid_upar_neutral[iz,1]
        #    end
        #    if input["evolve_moments"]["pressure"]
        #        wpa ./= newgrid_vth_neutral[iz,1]
        #    end
        #    newgrid_f_neutral1[:,iz,1] = interpolate_to_grid_vpa(wpa, fn1[:,iz,1], vpa,
        #                                                         vpa_spectral)
        #end
        #newgrid_f_neutral2 = fill(NaN, length(expected.vpa), size(fn2, 2), size(fn2, 3),
        #                          size(fn2, 4))
        #for iz ∈ 1:length(expected.z)
        #    wpa = copy(expected.vpa)
        #    if input["evolve_moments"]["parallel_flow"]
        #        wpa .-= newgrid_upar_neutral[iz,2]
        #    end
        #    if input["evolve_moments"]["pressure"]
        #        wpa ./= newgrid_vth_neutral[iz,2]
        #    end
        #    newgrid_f_neutral2[:,iz,1] = interpolate_to_grid_vpa(wpa, fn2[:,iz,1], vpa, vpa_spectral)
        #end
        #newgrid_f_neutral = cat(newgrid_f_neutral1, newgrid_f_neutral2; dims=3)
        #println("f_neutral ", size(newgrid_f_neutral))
        #println(newgrid_f_neutral)
        #println()
        function test_values(tind)
            @testset "tind=$tind" begin
                newgrid_phi = interpolate_to_grid_z(expected.z, phi[:, tind], z, z_spectral)
                @test elementwise_isapprox(expected.phi[:, tind], newgrid_phi, rtol=rtol)

                # Check ion particle moments and f
                ######################################

                newgrid_n_ion = interpolate_to_grid_z(expected.z, n_ion[:, :, tind], z, z_spectral)
                @test elementwise_isapprox(expected.n_ion[:, tind], newgrid_n_ion[:,1], rtol=rtol)

                newgrid_upar_ion = interpolate_to_grid_z(expected.z, upar_ion[:, :, tind], z, z_spectral)
                @test elementwise_isapprox(expected.upar_ion[:, tind], newgrid_upar_ion[:,1], rtol=upar_rtol, atol=atol)

                newgrid_ppar_ion = interpolate_to_grid_z(expected.z, ppar_ion[:, :, tind], z, z_spectral)
                @test elementwise_isapprox(expected.ppar_ion[:, tind], newgrid_ppar_ion[:,1], rtol=rtol)

                newgrid_vth_ion = @. sqrt(2.0/3.0*newgrid_ppar_ion/newgrid_n_ion)
                newgrid_f_ion = interpolate_to_grid_z(expected.z, f_ion[:, :, :, tind], z, z_spectral)
                temp = newgrid_f_ion
                newgrid_f_ion = fill(NaN, length(expected.vpa),
                                     size(newgrid_f_ion, 2),
                                     size(newgrid_f_ion, 3),
                                     size(newgrid_f_ion, 4))
                for iz ∈ 1:length(expected.z)
                    wpa = copy(expected.vpa)
                    if input["evolve_moments"]["parallel_flow"]
                        wpa .-= newgrid_upar_ion[iz,1]
                    end
                    if input["evolve_moments"]["pressure"]
                        wpa ./= newgrid_vth_ion[iz,1]
                    end
                    newgrid_f_ion[:,iz,1] = interpolate_to_grid_vpa(wpa, temp[:,iz,1], vpa, vpa_spectral)
                end
                @test elementwise_isapprox(expected.f_ion[:, :, tind], newgrid_f_ion[:,:,1], rtol=rtol)

                # Check neutral particle moments and f
                ######################################

                newgrid_n_neutral = interpolate_to_grid_z(expected.z, n_neutral[:, :, tind], z, z_spectral)
                @test elementwise_isapprox(expected.n_neutral[:, tind], newgrid_n_neutral[:,:,1], rtol=rtol)

                newgrid_upar_neutral = interpolate_to_grid_z(expected.z, upar_neutral[:, :, tind], z, z_spectral)
                @test elementwise_isapprox(expected.upar_neutral[:, tind], newgrid_upar_neutral[:,:,1], rtol=upar_rtol, atol=atol)

                newgrid_ppar_neutral = interpolate_to_grid_z(expected.z, ppar_neutral[:, :, tind], z, z_spectral)
                @test elementwise_isapprox(expected.ppar_neutral[:, tind], newgrid_ppar_neutral[:,:,1], rtol=rtol)

                newgrid_vth_neutral = @. sqrt(2.0/3.0*newgrid_ppar_neutral/newgrid_n_neutral)
                newgrid_f_neutral = interpolate_to_grid_z(expected.z, f_neutral[:, :, :, tind], z, z_spectral)
                temp = newgrid_f_neutral
                newgrid_f_neutral = fill(NaN, length(expected.vpa),
                                         size(newgrid_f_neutral, 2),
                                         size(newgrid_f_neutral, 3),
                                         size(newgrid_f_neutral, 4))
                for iz ∈ 1:length(expected.z)
                    wpa = copy(expected.vpa)
                    if input["evolve_moments"]["parallel_flow"]
                        wpa .-= newgrid_upar_neutral[iz,1]
                    end
                    if input["evolve_moments"]["pressure"]
                        wpa ./= newgrid_vth_neutral[iz,1]
                    end
                    newgrid_f_neutral[:,iz,1] = interpolate_to_grid_vpa(wpa, temp[:,iz,1], vpa, vpa_spectral)
                end
                @test elementwise_isapprox(expected.f_neutral[:, :, tind], newgrid_f_neutral[:,:,1], rtol=rtol)
            end
        end

        # Test initial values
        test_values(1)

        # Test final values
        test_values(2)
    end
end


function runtests()
    # Create a temporary directory for test output
    test_output_directory = get_MPI_tempdir()

    @testset "numerical dissipation" verbose=use_verbose begin
        println("numerical dissipation tests")

        # Chebyshev pseudospectral
        # Benchmark data is taken from this run (Chebyshev with no splitting)
        @testset "base" begin
            test_input["output"]["base_directory"] = test_output_directory
            run_test(test_input, expected_base, 1.e-10, 1.0e-15)
        end
        @testset "split 1" begin
            test_input_split_1_moment["output"]["base_directory"] = test_output_directory
            run_test(test_input_split_1_moment, expected_split_1, 1.e-10, 1.0e-15)
        end
        @testset "split 2" begin
            test_input_split_2_moments["output"]["base_directory"] = test_output_directory
            run_test(test_input_split_2_moments, expected_split_2, 1.e-10, 1.0e-15)
        end
        @testset "split 3" begin
            test_input_split_3_moments["output"]["base_directory"] = test_output_directory
            run_test(test_input_split_3_moments, expected_split_3, 1.e-10, 1.0e-15)
        end
    end

    if global_rank[] == 0
        # Delete output directory to avoid using too much disk space
        rm(realpath(test_output_directory); recursive=true)
    end
end

end # NumericalDissipationTests


using .NumericalDissipationTests

NumericalDissipationTests.runtests()
