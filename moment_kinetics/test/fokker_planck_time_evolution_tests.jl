module FokkerPlanckTimeEvolutionTests
include("setup.jl")

export print_output_data_for_test_update

using Base.Filesystem: tempname
using MPI
using Printf
using moment_kinetics.load_data: open_readonly_output_file, load_coordinate_data,
                                 load_species_data, load_fields_data,
                                 load_ion_moments_data, load_pdf_data,
                                 load_time_data, load_species_data,
                                 load_input
using moment_kinetics.type_definitions: mk_float
using moment_kinetics.utils: merge_dict_with_kwargs!
using moment_kinetics.input_structs: options_to_TOML
using moment_kinetics.fokker_planck_test: F_Maxwellian, print_test_data
using moment_kinetics.velocity_moments: get_density, get_upar, get_p

const analytical_rtol = 3.e-2
const regression_rtol = 2.e-8

# Create a temporary directory for test output
test_output_directory = tempname()
mkpath(test_output_directory)

# The expected output
struct expected_data
    vpa::Array{mk_float, 1}
    vperp::Array{mk_float, 1}
    phi::Array{mk_float, 1} #time
    n_ion::Array{mk_float, 1} #time
    upar_ion::Array{mk_float, 1} # time
    ppar_ion::Array{mk_float, 1} # time
    pperp_ion::Array{mk_float, 1} # time
    qpar_ion::Array{mk_float, 1} # time
    v_t_ion::Array{mk_float, 1} # time
    dSdt::Array{mk_float, 1} # time
    maxnorm_ion::Array{mk_float, 1} # time
    L2norm_ion::Array{mk_float, 1} # time
    f_ion::Array{mk_float, 3} # vpa, vperp, time
end

const expected_zero_impose_regularity =
expected_data(
    # Expected vpa
    [-4.242640687119286, -3.535533905932738, -2.828427124746191, -2.121320343559643, -1.414213562373095, -0.707106781186548, 0.000000000000000, 0.707106781186547, 1.414213562373095, 2.121320343559643, 2.828427124746191, 3.535533905932738, 4.242640687119286],
    # Expected vperp
    [0.219275263435463, 0.912095586463014, 1.414213562373095, 2.121320343559643, 2.828427124746190, 3.535533905932738, 4.242640687119286],
    # Expected phi
    [0.018846102257926, 0.015330987045992, 0.011157118440358, 0.007077211631787, 0.003088188844697, -0.000813812649058, -0.004632414198854, -0.008371017077709, -0.012032819805267, -0.015620833794229, -0.019137897530443],
    # Expected n_ion
    [1.019024810931715, 1.015449109500508, 1.011219591208816, 1.007102314277999, 1.003092962212289, 0.999186518406644, 0.995378298882939, 0.991663922324998, 0.988039285072864, 0.984500538628690, 0.981044069360323],
    # Expected upar_ion
    [0.179871043200945, 0.179868638753922, 0.179858430648241, 0.179848364497194, 0.179838459800162, 0.179828714897528, 0.179819126035370, 0.179809689447650, 0.179800401446629, 0.179791258428335, 0.179782256874725],
    # Expected ppar_ion
    [0.313337282506599, 1.014041842405650, 1.013219548778453, 1.011943733932148, 1.010690997278342, 1.009464535565222, 1.008263403156728, 1.007086637903531, 1.005933330217613, 1.004802620296468, 1.003693694557341],
    # Expected pperp_ion
    [1.439099182314380, 1.086918668839524, 1.084853326756398, 1.083074421806693, 1.081341110174929, 1.079649290421457, 1.077997096991071, 1.076382817245275, 1.074804845330750, 1.073261673158455, 1.071751882765307],
    # Expected qpar_ion
    [-0.027144648351961, -0.013124859007503, -0.013017513651687, -0.013017996834144, -0.013008358372191, -0.012996346251024, -0.012982443055970, -0.012966840205188, -0.012949705573969, -0.012931192185113, -0.012911439763211],
    # Expected v_t_ion
    [1.444980016911830, 1.446692452156497, 1.448588114988636, 1.450443598076709, 1.452259930448745, 1.454038730690151, 1.455781520412614, 1.457489730307671, 1.459164707185178, 1.460807720361081, 1.462419967453773],
    # Expected dSdt_ion
    [0.000000000000000, 0.000528220093143, 0.000252452192278, 0.000246455134008, 0.000242211573655, 0.000238403313000, 0.000235052492237, 0.000232235490421, 0.000230131865096, 0.000229257301749, 0.000232554141670],
    # Expected maxnorm_ion
    [0.051324838503508, 0.012355815713943, 0.012191168317895, 0.012085512421680, 0.011983449580458, 0.011884274080210, 0.011787843613286, 0.011694030589444, 0.011602715841028, 0.011513787863091, 0.011427142179126],
    # Expected L2norm_ion
    [0.005565972430777, 0.000768091922393, 0.000758048170275, 0.000752969877188, 0.000748068895302, 0.000743294056580, 0.000738639156744, 0.000734098871433, 0.000729668229117, 0.000725342575238, 0.000721117545461],
    # Expected f_ion
    [0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000000000000047 0.000000000000084 0.000000000000140 0.000000000000051 0.000000000000003 0.000000000000000 0.000000000000000 ;
     0.000000000570477 0.000000001018760 0.000000001686796 0.000000000620538 0.000000000030895 0.000000000000208 0.000000000000000 ;
     0.000000933291015 0.000001666675496 0.000002759572688 0.000001015190058 0.000000050543337 0.000000000340558 0.000000000000000 ;
     0.000206636618832 0.000369012648462 0.000610987099129 0.000224769592590 0.000011190619073 0.000000075401798 0.000000000000000 ;
     0.006191680320129 0.011057131917284 0.018307678565963 0.006735018559993 0.000335316829505 0.000002259347025 0.000000000000000 ;
     0.025108501828898 0.044838880984366 0.074241297513697 0.027311847041181 0.001359776795892 0.000009162103981 0.000000000000000 ;
     0.013779837968588 0.024608099633655 0.040744487954235 0.014989059459421 0.000746261328076 0.000005028269276 0.000000000000000 ;
     0.001023477873141 0.001827731612846 0.003026238912872 0.001113291080119 0.000055427499119 0.000000373467551 0.000000000000000 ;
     0.000010287831469 0.000018372057958 0.000030419256476 0.000011190619073 0.000000557148117 0.000000003754034 0.000000000000000 ;
     0.000000013995237 0.000000024992760 0.000000041381384 0.000000015223361 0.000000000757926 0.000000000005107 0.000000000000000 ;
     0.000000000002577 0.000000000004601 0.000000000007619 0.000000000002803 0.000000000000140 0.000000000000001 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000010617243484 -0.000018402051343 -0.000030003053102 -0.000028058174893 -0.000013161131958 -0.000004062767947 0.000000000000000 ;
     0.000783298386335 0.000620398070421 0.000377642322874 0.000104631601874 0.000002815820997 -0.000012124986278 0.000000000000000 ;
     0.004042043646926 0.003185179624653 0.001908271933556 0.000543749507342 0.000057361171342 -0.000044894997771 0.000000000000000 ;
     0.014922530279830 0.011913943384930 0.007430515856674 0.002391033625912 0.000394923174176 -0.000073037681809 0.000000000000000 ;
     0.033117052054718 0.026685491123867 0.017101112033502 0.005864414944459 0.001096417183274 -0.000050390943118 0.000000000000000 ;
     0.045602271786764 0.036846267572657 0.023797978890156 0.008308898151846 0.001602668883083 -0.000018953086532 0.000000000000000 ;
     0.041039879454062 0.033121356157219 0.021321090260836 0.007389384285637 0.001410220771042 -0.000034005793094 0.000000000000000 ;
     0.023946561869114 0.019213562744861 0.012160398150926 0.004058799276634 0.000725862239908 -0.000071002679716 0.000000000000000 ;
     0.008778053630572 0.006984242058553 0.004311085369569 0.001340763649656 0.000194817784859 -0.000063069567809 0.000000000000000 ;
     0.001813493421565 0.001421464019364 0.000837257720821 0.000213667373162 0.000001933804416 -0.000028987901947 0.000000000000000 ;
     0.000043621828238 0.000013867733763 -0.000030472127742 -0.000047492669370 -0.000024457266469 -0.000008816830102 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000008721875396 -0.000016827543145 -0.000028906693652 -0.000027681714997 -0.000013206361441 -0.000004145422763 0.000000000000000 ;
     0.000786641041683 0.000623473294147 0.000380319017213 0.000106340040481 0.000003410529415 -0.000012074975854 0.000000000000000 ;
     0.004039580118988 0.003184934910046 0.001911333717686 0.000548132426493 0.000059805189875 -0.000044003504975 0.000000000000000 ;
     0.014856797085619 0.011864801847060 0.007406099377902 0.002389527715665 0.000397773015134 -0.000071006137408 0.000000000000000 ;
     0.032917292512517 0.026529806174155 0.017011107500599 0.005843275211571 0.001096617779493 -0.000047654996574 0.000000000000000 ;
     0.045305101119470 0.036612702800676 0.023659200285891 0.008272321989617 0.001600325937857 -0.000016047298850 0.000000000000000 ;
     0.040781101040016 0.032918514605798 0.021201606404736 0.007358809535786 0.001408704879118 -0.000031207635981 0.000000000000000 ;
     0.023819875832221 0.019116089896489 0.012106459100374 0.004048359959125 0.000727325774234 -0.000068623999857 0.000000000000000 ;
     0.008751061150350 0.006964949525443 0.004303267377848 0.001342646127099 0.000197439634242 -0.000061625215670 0.000000000000000 ;
     0.001816274318130 0.001424539338355 0.000840771791177 0.000216680935252 0.000003483876653 -0.000028517161420 0.000000000000000 ;
     0.000047527219554 0.000017267982285 -0.000027824648275 -0.000046093522731 -0.000024011693047 -0.000008767189997 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000008061804504 -0.000016300545856 -0.000028578004034 -0.000027622048358 -0.000013253026001 -0.000004173204266 0.000000000000000 ;
     0.000787924741303 0.000624589780699 0.000381186321108 0.000106724234141 0.000003388572302 -0.000012145280414 0.000000000000000 ;
     0.004040548933634 0.003187616679505 0.001916568150250 0.000552590717420 0.000060797509611 -0.000043919117824 0.000000000000000 ;
     0.014792132144607 0.011818835485819 0.007387997835003 0.002393063082292 0.000400210599294 -0.000070304165783 0.000000000000000 ;
     0.032695050620817 0.026361460577613 0.016923078724486 0.005832097925788 0.001099357196947 -0.000046107570525 0.000000000000000 ;
     0.044962867055207 0.036350329741252 0.023515836927709 0.008247847070947 0.001602642289305 -0.000014008864027 0.000000000000000 ;
     0.040484436168952 0.032692059952882 0.021079779750216 0.007339815709407 0.001411239255802 -0.000029339935958 0.000000000000000 ;
     0.023682872578259 0.019014502464405 0.012057648694945 0.004046275460577 0.000730119820449 -0.000067476150730 0.000000000000000 ;
     0.008727746217659 0.006949862446252 0.004300441531645 0.001347353806164 0.000199150745506 -0.000061284004024 0.000000000000000 ;
     0.001819411179919 0.001427679414816 0.000843916658178 0.000218574070477 0.000003758248137 -0.000028582030824 0.000000000000000 ;
     0.000049911042673 0.000019217573835 -0.000026522153129 -0.000045720691210 -0.000024080696911 -0.000008831102353 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000007432692148 -0.000015800334976 -0.000028269883476 -0.000027572653663 -0.000013302567445 -0.000004201153451 0.000000000000000 ;
     0.000789184626367 0.000625683808199 0.000382033185939 0.000107092864177 0.000003359481037 -0.000012216912135 0.000000000000000 ;
     0.004041421424741 0.003190173099727 0.001921633979179 0.000556930303510 0.000061767052488 -0.000043839080244 0.000000000000000 ;
     0.014729103964332 0.011774005295629 0.007370286479187 0.002396469027757 0.000402601228680 -0.000069615769006 0.000000000000000 ;
     0.032479021754194 0.026197763728792 0.016837367593683 0.005821133447699 0.001102042344268 -0.000044587445838 0.000000000000000 ;
     0.044630390230541 0.036095351705602 0.023376348394680 0.008223909088458 0.001604910638107 -0.000012006089077 0.000000000000000 ;
     0.040196089206369 0.032471876290902 0.020961173748785 0.007321209498299 0.001413721578040 -0.000027504443613 0.000000000000000 ;
     0.023549435708998 0.018915511164732 0.012009988541856 0.004044165273215 0.000732860010935 -0.000066347750606 0.000000000000000 ;
     0.008704879930586 0.006935037195533 0.004297599117056 0.001351919413143 0.000200830016682 -0.000060949163099 0.000000000000000 ;
     0.001822463522469 0.001430740245073 0.000846990136904 0.000220427996282 0.000004025862599 -0.000028647309471 0.000000000000000 ;
     0.000052246042738 0.000021127231494 -0.000025246345156 -0.000045356742493 -0.000024150571530 -0.000008894804474 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000006808902011 -0.000015303821867 -0.000027963039918 -0.000027521906320 -0.000013350788020 -0.000004228690274 0.000000000000000 ;
     0.000790432391784 0.000626770254607 0.000382879233079 0.000107466362102 0.000003335720923 -0.000012286158963 0.000000000000000 ;
     0.004042112355920 0.003192536462067 0.001926489615855 0.000561147170731 0.000062728047790 -0.000043754693426 0.000000000000000 ;
     0.014667559786520 0.011730176046331 0.007352856200878 0.002399693731596 0.000404945287950 -0.000068930788641 0.000000000000000 ;
     0.032269120581798 0.026038619127131 0.016753860962412 0.005810293476595 0.001104651572046 -0.000043087752887 0.000000000000000 ;
     0.044307707605575 0.035847761575911 0.023240661883613 0.008200411805436 0.001607096959176 -0.000010035132781 0.000000000000000 ;
     0.039916114800697 0.032257973205035 0.020845730831889 0.007302905870227 0.001416123122097 -0.000025696519168 0.000000000000000 ;
     0.023419529881258 0.018819065135099 0.011963404651880 0.004041967472093 0.000735535694796 -0.000065230943056 0.000000000000000 ;
     0.008682385577076 0.006920404940631 0.004294683043391 0.001356318401606 0.000202483936612 -0.000060612142976 0.000000000000000 ;
     0.001825404613662 0.001433702933973 0.000849985010933 0.000222250718119 0.000004298656858 -0.000028707696597 0.000000000000000 ;
     0.000054540642119 0.000023006347196 -0.000023986387558 -0.000044991419089 -0.000024215503607 -0.000008956756561 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000006189961526 -0.000014810603385 -0.000027657173675 -0.000027469667347 -0.000013397645216 -0.000004255809882 0.000000000000000 ;
     0.000791667905628 0.000627848905179 0.000383724124368 0.000107844488919 0.000003317218520 -0.000012353046522 0.000000000000000 ;
     0.004042633234683 0.003194718046996 0.001931146002410 0.000565246891080 0.000063680619283 -0.000043666132935 0.000000000000000 ;
     0.014607435116598 0.011687305591129 0.007335698156172 0.002402747166112 0.000407244173846 -0.000068249304362 0.000000000000000 ;
     0.032065051646231 0.025883809637666 0.016672458412616 0.005799576133463 0.001107187700824 -0.000041608093532 0.000000000000000 ;
     0.043994339160329 0.035607200694902 0.023108599593194 0.008177340081474 0.001609204587281 -0.000008095243242 0.000000000000000 ;
     0.039644108584197 0.032050050569889 0.020733306217173 0.007284896139209 0.001418447036266 -0.000023915589862 0.000000000000000 ;
     0.023292996101258 0.018725051935948 0.011917853961046 0.004039689616842 0.000738148945316 -0.000064125685605 0.000000000000000 ;
     0.008660253531478 0.006905962842863 0.004291700585978 0.001360559027552 0.000204112958957 -0.000060273227379 0.000000000000000 ;
     0.001828239340614 0.001436571542174 0.000852904109321 0.000224042964501 0.000004576209970 -0.000028763389752 0.000000000000000 ;
     0.000056795858756 0.000024855611718 -0.000022742077108 -0.000044624972633 -0.000024275687187 -0.000009017000699 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000005575843960 -0.000014320673142 -0.000027352308675 -0.000027415985060 -0.000013443162517 -0.000004282516464 0.000000000000000 ;
     0.000792890756160 0.000628919243648 0.000384567187774 0.000108226695030 0.000003303719198 -0.000012417651957 0.000000000000000 ;
     0.004042995813102 0.003196729178244 0.001935613824257 0.000569234677211 0.000064624680085 -0.000043573681237 0.000000000000000 ;
     0.014548671343311 0.011645356023943 0.007318805294056 0.002405639252016 0.000409499200474 -0.000067571511204 0.000000000000000 ;
     0.031866538577099 0.025733132451032 0.016593066756340 0.005788980519422 0.001109653676658 -0.000040148140801 0.000000000000000 ;
     0.043689832562690 0.035373331292424 0.022979994474701 0.008154680392409 0.001611237105799 -0.000006185690185 0.000000000000000 ;
     0.039379687425962 0.031847824118631 0.020623762966073 0.007267172573159 0.001420696687748 -0.000022161082575 0.000000000000000 ;
     0.023169682536782 0.018633364224780 0.011873295425893 0.004037339189107 0.000740701956711 -0.000063031944479 0.000000000000000 ;
     0.008638474284308 0.006891708017190 0.004288658731594 0.001364649355705 0.000205717566665 -0.000059932725803 0.000000000000000 ;
     0.001830972644990 0.001439350190820 0.000855750330474 0.000225805491361 0.000004858067646 -0.000028814615557 0.000000000000000 ;
     0.000059012742921 0.000026675735799 -0.000021513209037 -0.000044257681207 -0.000024331348663 -0.000009075591627 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000004966528449 -0.000013834030464 -0.000027048474331 -0.000027360911600 -0.000013487365472 -0.000004308814683 0.000000000000000 ;
     0.000794100609418 0.000629980829383 0.000385407823702 0.000108612472192 0.000003294978376 -0.000012480050884 0.000000000000000 ;
     0.004043210945962 0.003198580349293 0.001939903036455 0.000573115423982 0.000065560164533 -0.000043477604346 0.000000000000000 ;
     0.014491213360954 0.011604291631653 0.007302170800438 0.002408379204745 0.000411711638986 -0.000066897582308 0.000000000000000 ;
     0.031673323255866 0.025586398035278 0.016515598670077 0.005778505599167 0.001112052297620 -0.000038707565542 0.000000000000000 ;
     0.043393765811132 0.035145838079785 0.022854690264022 0.008132419816839 0.001613197900007 -0.000004305759410 0.000000000000000 ;
     0.039122493641600 0.031651028310047 0.020516972850098 0.007249727678891 0.001422875265567 -0.000020432431572 0.000000000000000 ;
     0.023049446909526 0.018543901308732 0.011829690324615 0.004034923033680 0.000743196831988 -0.000061949668870 0.000000000000000 ;
     0.008617038595804 0.006877637493547 0.004285563853342 0.001368596918908 0.000207298246076 -0.000059590922446 0.000000000000000 ;
     0.001833609186703 0.001442042777749 0.000858526436565 0.000227539041659 0.000005143810794 -0.000028861588691 0.000000000000000 ;
     0.000061192317835 0.000028467418039 -0.000020299568499 -0.000043889798389 -0.000024382702500 -0.000009132582454 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000004361991832 -0.000013350673064 -0.000026745699463 -0.000027304499357 -0.000013530280426 -0.000004334709514 0.000000000000000 ;
     0.000795297206662 0.000631033295722 0.000386245504664 0.000109001355770 0.000003290764075 -0.000012540316557 0.000000000000000 ;
     0.004043288655213 0.003200281284433 0.001944022919722 0.000576893735097 0.000066487029585 -0.000043378151049 0.000000000000000 ;
     0.014435009256479 0.011564078694396 0.007285788067134 0.002410975587201 0.000413882719807 -0.000066227668823 0.000000000000000 ;
     0.031485164270185 0.025443429012441 0.016439972200568 0.005768150208537 0.001114386219528 -0.000037286036556 0.000000000000000 ;
     0.043105744719737 0.034924426392073 0.022732540603485 0.008110545991957 0.001615090164545 -0.000002454753242 0.000000000000000 ;
     0.038872192951978 0.031459414835149 0.020412815673870 0.007232554193597 0.001424985786333 -0.000018729080208 0.000000000000000 ;
     0.022932155795914 0.018456568666108 0.011787002107505 0.004032447415258 0.000745635582906 -0.000060878793802 0.000000000000000 ;
     0.008595937512514 0.006863748251106 0.004282421771252 0.001372408756487 0.000208855482496 -0.000059248078508 0.000000000000000 ;
     0.001836153357909 0.001444652986733 0.000861235055734 0.000229244341141 0.000005433052051 -0.000028904512450 0.000000000000000 ;
     0.000063335575591 0.000030231340748 -0.000019100934829 -0.000043521556150 -0.000024429951862 -0.000009188024561 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000003762208635 -0.000012870596891 -0.000026444011943 -0.000027246800561 -0.000013571934276 -0.000004360206184 0.000000000000000 ;
     0.000796480354439 0.000632076340848 0.000387079767360 0.000109392920818 0.000003290856306 -0.000012598519852 0.000000000000000 ;
     0.004043238204263 0.003201841005561 0.001947982136053 0.000580573944781 0.000067405252077 -0.000043275554070 0.000000000000000 ;
     0.014380010070975 0.011524685341412 0.007269650688322 0.002413436365278 0.000416013633128 -0.000065561902020 0.000000000000000 ;
     0.031301835546234 0.025304059170563 0.016366110342630 0.005757913076159 0.001116657964199 -0.000035883221908 0.000000000000000 ;
     0.042825400609209 0.034708820486255 0.022613408244637 0.008089047084575 0.001616916915855 -0.000000631990783 0.000000000000000 ;
     0.038628472552583 0.031272751204889 0.020311178635279 0.007215645081174 0.001427031104947 -0.000017050481636 0.000000000000000 ;
     0.022817683926791 0.018371277464348 0.011745196240195 0.004029918073150 0.000748020133911 -0.000059819242067 0.000000000000000 ;
     0.008575162362695 0.006850037236655 0.004279237804907 0.001376091453850 0.000210389758331 -0.000058904434079 0.000000000000000 ;
     0.001838609300930 0.001447184301111 0.000863878689295 0.000230922097697 0.000005725433168 -0.000028943579399 0.000000000000000 ;
     0.000065443477503 0.000031968169537 -0.000017917083072 -0.000043153166717 -0.000024473289252 -0.000009241967613 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ]
   )
const expected_zero = 
expected_data(
    # Expected vpa
    [-4.242640687119286, -3.535533905932738, -2.828427124746191, -2.121320343559643, -1.414213562373095, -0.707106781186548, 0.000000000000000, 0.707106781186547, 1.414213562373095, 2.121320343559643, 2.828427124746191, 3.535533905932738, 4.242640687119286],
    # Expected vperp
    [0.219275263435463, 0.912095586463014, 1.414213562373095, 2.121320343559643, 2.828427124746190, 3.535533905932738, 4.242640687119286],
    # Expected phi
    [-0.000000065347220, -0.000000065347247, -0.000000065347273, -0.000000065347300, -0.000000065347327, -0.000000065347353, -0.000000065347380, -0.000000065347407, -0.000000065347435, -0.000000065347464, -0.000000065347493],
    # Expected n_ion
    [0.999999934652782, 0.999999934652755, 0.999999934652729, 0.999999934652702, 0.999999934652675, 0.999999934652650, 0.999999934652622, 0.999999934652595, 0.999999934652567, 0.999999934652538, 0.999999934652509],
    # Expected upar_ion
    [0.179871043200945, 0.179871043200946, 0.179871043200945, 0.179871043200946, 0.179871043200946, 0.179871043200947, 0.179871043200947, 0.179871043200947, 0.179871043200947, 0.179871043200946, 0.179871043200945],
    # Expected ppar_ion
    [0.307487372897612, 1.061211143680743, 1.060720965706892, 1.060793983680455, 1.060810095572847, 1.060812103996521, 1.060812355338677, 1.060812389983850, 1.060812395203282, 1.060812396036477, 1.060812396173803],
    # Expected pperp_ion
    [1.438641808677253, 1.061779923285643, 1.062025012272527, 1.061988503285703, 1.061980447339464, 1.061979443127586, 1.061979317456463, 1.061979300133835, 1.061979297524075, 1.061979297107431, 1.061979297038722],
    # Expected qpar_ion
    [-0.026637866209867, -0.012633037121369, -0.006236687589191, -0.005804688696857, -0.005796014105579, -0.005799944092012, -0.005801052470231, -0.005801276595098, -0.005801317598485, -0.005801324807069, -0.005801326052421],
    # Expected v_t_ion
    [1.457113859282121, 1.457113859282120, 1.457113859282120, 1.457113859282120, 1.457113859282120, 1.457113859282120, 1.457113859282120, 1.457113859282120, 1.457113859282121, 1.457113859282121, 1.457113859282121],
    # Expected dSdt_ion
    [0.000000000000000, 0.001419546860587, 0.000020300218426, 0.000000278130997, -0.000000048763998, -0.000000012902914, -0.000000002493092, -0.000000000446402, -0.000000000077706, -0.000000000013364, -0.000000000002286],
    # Expected maxnorm_ion
    [0.051952900920716, 0.007185629515416, 0.006765206148094, 0.006733731663757, 0.006731124169232, 0.006730892598625, 0.006730870046731, 0.006730867560211, 0.006730867245706, 0.006730867200927, 0.006730867194010],
    # Expected L2norm_ion
    [0.005794676843594, 0.000519701615831, 0.000486923330227, 0.000484527367738, 0.000484323929945, 0.000484304812463, 0.000484302786265, 0.000484302539742, 0.000484302505690, 0.000484302500530, 0.000484302499703],
    # Expected f_ion
    [0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000000000000008 0.000000000000084 0.000000000000140 0.000000000000051 0.000000000000003 0.000000000000000 0.000000000000000 ;
     0.000000000097012 0.000000001018760 0.000000001686796 0.000000000620538 0.000000000030895 0.000000000000208 0.000000000000000 ;
     0.000000158709589 0.000001666675496 0.000002759572688 0.000001015190058 0.000000050543337 0.000000000340558 0.000000000000000 ;
     0.000035139321288 0.000369012648462 0.000610987099129 0.000224769592590 0.000011190619073 0.000000075401798 0.000000000000000 ;
     0.001052918138669 0.011057131917284 0.018307678565963 0.006735018559993 0.000335316829505 0.000002259347025 0.000000000000000 ;
     0.004269793601022 0.044838880984366 0.074241297513697 0.027311847041181 0.001359776795892 0.000009162103981 0.000000000000000 ;
     0.002343312411961 0.024608099633655 0.040744487954235 0.014989059459421 0.000746261328076 0.000005028269276 0.000000000000000 ;
     0.000174046197710 0.001827731612846 0.003026238912872 0.001113291080119 0.000055427499119 0.000000373467551 0.000000000000000 ;
     0.000001749483791 0.000018372057958 0.000030419256476 0.000011190619073 0.000000557148117 0.000000003754034 0.000000000000000 ;
     0.000000002379942 0.000000024992760 0.000000041381384 0.000000015223361 0.000000000757926 0.000000000005107 0.000000000000000 ;
     0.000000000000438 0.000000000004601 0.000000000007619 0.000000000002803 0.000000000000140 0.000000000000001 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000021930712699 -0.000013238673177 -0.000043435043252 -0.000052943672159 -0.000033025350196 -0.000011901584828 0.000000000000000 ;
     0.001173326164176 0.000834259037267 0.000478908227872 0.000115582756019 -0.000024980777163 -0.000033052422870 0.000000000000000 ;
     0.005210737247431 0.003720788754810 0.002191937609926 0.000695077801893 0.000084971725128 -0.000068947848127 0.000000000000000 ;
     0.016947473732564 0.012212273956969 0.007316853741184 0.002488556072710 0.000502378433655 -0.000076910651409 0.000000000000000 ;
     0.035819582412860 0.026005038757235 0.015787577230171 0.005525211802370 0.001232097749203 -0.000022695888584 0.000000000000000 ;
     0.048705353759474 0.035413982316643 0.021561628812479 0.007594160786292 0.001729288150549 0.000026199353009 0.000000000000000 ;
     0.044086766475203 0.032020295845349 0.019457513238424 0.006827172517398 0.001542886591721 0.000003750691029 0.000000000000000 ;
     0.026509416657996 0.019161953115619 0.011546888789831 0.003983990542005 0.000855543446734 -0.000061585580798 0.000000000000000 ;
     0.010473767161256 0.007530832173393 0.004492329920879 0.001489863671303 0.000255055565916 -0.000083176765682 0.000000000000000 ;
     0.002528963052538 0.001785147987592 0.001018848068744 0.000268283799445 -0.000017679695167 -0.000056979183798 0.000000000000000 ;
     0.000177637622216 0.000079412739820 -0.000009826769428 -0.000063933111361 -0.000050052548241 -0.000022088135456 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000022332188786 -0.000012864162736 -0.000043230468161 -0.000053364598352 -0.000034018413790 -0.000012561228376 0.000000000000000 ;
     0.001170519718204 0.000832615469694 0.000478881044397 0.000117224616036 -0.000023735259699 -0.000032896562706 0.000000000000000 ;
     0.005187351813214 0.003696042074948 0.002170864364787 0.000688450254294 0.000090075061687 -0.000065159627988 0.000000000000000 ;
     0.016994746364708 0.012213814940424 0.007286364876380 0.002461967073380 0.000504819926256 -0.000069914834432 0.000000000000000 ;
     0.036085264956584 0.026128464530942 0.015792945138038 0.005481086379794 0.001225183870501 -0.000015033862909 0.000000000000000 ;
     0.049125777126795 0.035625042097427 0.021594797079459 0.007539526417707 0.001715183175806 0.000033490454504 0.000000000000000 ;
     0.044398864214411 0.032161635282163 0.019457679900271 0.006768862885157 0.001530367987734 0.000011516726125 0.000000000000000 ;
     0.026575441868211 0.019158997968699 0.011495290883141 0.003936762453628 0.000852719796697 -0.000052853057152 0.000000000000000 ;
     0.010426593333829 0.007479898049940 0.004446865327158 0.001470940938674 0.000261604048315 -0.000075411437062 0.000000000000000 ;
     0.002509580830692 0.001771615745095 0.001013142603330 0.000273237730031 -0.000008921477479 -0.000052502269750 0.000000000000000 ;
     0.000180828673336 0.000084136074505 -0.000003656229914 -0.000057448856731 -0.000045874661323 -0.000020768446609 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000022445537680 -0.000012675532493 -0.000042973343374 -0.000053091185356 -0.000033842217842 -0.000012504496909 0.000000000000000 ;
     0.001169757267010 0.000832113985720 0.000478708118311 0.000117458664724 -0.000023389113778 -0.000032726960355 0.000000000000000 ;
     0.005184688842445 0.003693405291817 0.002168652806569 0.000687548394642 0.000090275057779 -0.000064901299453 0.000000000000000 ;
     0.016998400154092 0.012214000252305 0.007284045185558 0.002459699648885 0.000504551228567 -0.000069675414992 0.000000000000000 ;
     0.036106353574567 0.026138968508703 0.015794475914942 0.005478265691953 0.001224369740599 -0.000014882244104 0.000000000000000 ;
     0.049157251611130 0.035641640916541 0.021598580162120 0.007536411767658 0.001714096935174 0.000033633300852 0.000000000000000 ;
     0.044419774184063 0.032171317199068 0.019458070910278 0.006765301416836 0.001529493816696 0.000011800733294 0.000000000000000 ;
     0.026577082805588 0.019157019008045 0.011491035272958 0.003933589743687 0.000852531157301 -0.000052360677880 0.000000000000000 ;
     0.010421031668144 0.007474942197455 0.004443125594451 0.001469693768123 0.000262154852526 -0.000074851182055 0.000000000000000 ;
     0.002507632614880 0.001770402043763 0.001012781189546 0.000273828062979 -0.000008111831511 -0.000052104041010 0.000000000000000 ;
     0.000181109936241 0.000084598019309 -0.000003033190781 -0.000056793260104 -0.000045447895204 -0.000020623965368 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000022483253393 -0.000012634723964 -0.000042930990619 -0.000053054501827 -0.000033820491665 -0.000012497684206 0.000000000000000 ;
     0.001169725318741 0.000832102789100 0.000478721933621 0.000117499881771 -0.000023347158102 -0.000032707999066 0.000000000000000 ;
     0.005184443872669 0.003693176459774 0.002168472101975 0.000687484782189 0.000090301512154 -0.000064874878592 0.000000000000000 ;
     0.016998575854196 0.012213927252526 0.007283803378006 0.002459497469790 0.000504526608473 -0.000069654917397 0.000000000000000 ;
     0.036107949636763 0.026139724627932 0.015794527394846 0.005477997252660 0.001224286622817 -0.000014876027727 0.000000000000000 ;
     0.049159859105654 0.035643003056898 0.021598869673025 0.007536126477645 0.001713986168242 0.000033633625321 0.000000000000000 ;
     0.044421702947958 0.032172245858328 0.019458160624329 0.006765003689616 0.001529403918678 0.000011811686049 0.000000000000000 ;
     0.026577462160301 0.019157018637072 0.011490765918366 0.003933336735545 0.000852503131226 -0.000052330357500 0.000000000000000 ;
     0.010420713788951 0.007474627446712 0.004442863849284 0.001469594258302 0.000262190979103 -0.000074811895975 0.000000000000000 ;
     0.002507510753806 0.001770325783527 0.001012760197075 0.000273872451386 -0.000008051586086 -0.000052074704222 0.000000000000000 ;
     0.000181137478416 0.000084637332817 -0.000002983500477 -0.000056742694436 -0.000045415316965 -0.000020613067179 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000022490290411 -0.000012627813033 -0.000042924508395 -0.000053049549516 -0.000033817834991 -0.000012496913298 0.000000000000000 ;
     0.001169725589436 0.000832105298683 0.000478726831837 0.000117506593159 -0.000023341698888 -0.000032705747310 0.000000000000000 ;
     0.005184412615778 0.003693150772272 0.002168454713912 0.000687480975557 0.000090305862760 -0.000064871551902 0.000000000000000 ;
     0.016998560373001 0.012213899395481 0.007283770448268 0.002459477416039 0.000504525373812 -0.000069652169500 0.000000000000000 ;
     0.036108057164716 0.026139766587700 0.015794516455959 0.005477968239577 0.001224278638037 -0.000014875133105 0.000000000000000 ;
     0.049160090676260 0.035643121716351 0.021598891558678 0.007536097870230 0.001713974988010 0.000033633276574 0.000000000000000 ;
     0.044421915170831 0.032172354615604 0.019458180807900 0.006764978092328 0.001529394585407 0.000011811740385 0.000000000000000 ;
     0.026577542719699 0.019157049352503 0.011490756974414 0.003933315876007 0.000852499123254 -0.000052328828494 0.000000000000000 ;
     0.010420708388524 0.007474613740919 0.004442846523159 0.001469584597236 0.000262192332790 -0.000074809444157 0.000000000000000 ;
     0.002507501873598 0.001770318993683 0.001012756614987 0.000273873957422 -0.000008047812762 -0.000052072693549 0.000000000000000 ;
     0.000181137586197 0.000084638520142 -0.000002981192907 -0.000056739649937 -0.000045413082928 -0.000020612272688 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000022491498105 -0.000012626670357 -0.000042923484602 -0.000053048820570 -0.000033817470663 -0.000012496814438 0.000000000000000 ;
     0.001169725996894 0.000832106007114 0.000478727823011 0.000117507693396 -0.000023340908851 -0.000032705442577 0.000000000000000 ;
     0.005184407932591 0.003693147316413 0.002168452738167 0.000687480868402 0.000090306596749 -0.000064871073189 0.000000000000000 ;
     0.016998553852683 0.012213893236905 0.007283765399582 0.002459475140271 0.000504525425756 -0.000069651742418 0.000000000000000 ;
     0.036108062208810 0.026139766699566 0.015794512974781 0.005477964656732 0.001224277821306 -0.000014874961312 0.000000000000000 ;
     0.049160113228152 0.035643132937084 0.021598893147082 0.007536094651428 0.001713973760245 0.000033633223403 0.000000000000000 ;
     0.044421942227696 0.032172369327192 0.019458184718910 0.006764975790988 0.001529393524202 0.000011811636402 0.000000000000000 ;
     0.026577557784284 0.019157057074256 0.011490758406060 0.003933314103533 0.000852498522969 -0.000052328841805 0.000000000000000 ;
     0.010420711253910 0.007474614495092 0.004442845669402 0.001469583495423 0.000262192176448 -0.000074809359990 0.000000000000000 ;
     0.002507501155432 0.001770318205269 0.001012755911374 0.000273873686910 -0.000008047698061 -0.000052072588473 0.000000000000000 ;
     0.000181137150104 0.000084638212230 -0.000002981340342 -0.000056739597263 -0.000045412971798 -0.000020612221790 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000022491703194 -0.000012626479541 -0.000042923317383 -0.000053048705920 -0.000033817415773 -0.000012496800211 0.000000000000000 ;
     0.001169726092345 0.000832106148041 0.000478728002890 0.000117507876731 -0.000023340785636 -0.000032705396980 0.000000000000000 ;
     0.005184407181270 0.003693146797800 0.002168452478429 0.000687480892880 0.000090306721251 -0.000064870998566 0.000000000000000 ;
     0.016998552424636 0.012213892070397 0.007283764582416 0.002459474843969 0.000504525456247 -0.000069651672533 0.000000000000000 ;
     0.036108061999710 0.026139766152130 0.015794512251542 0.005477964156571 0.001224277727164 -0.000014874929686 0.000000000000000 ;
     0.049160115714670 0.035643134127946 0.021598893247516 0.007536094237894 0.001713973607218 0.000033633215842 0.000000000000000 ;
     0.044421946108882 0.032172371528906 0.019458185424793 0.006764975565935 0.001529393387367 0.000011811610434 0.000000000000000 ;
     0.026577560457333 0.019157058588772 0.011490758886797 0.003933313944850 0.000852498427998 -0.000052328865605 0.000000000000000 ;
     0.010420712041974 0.007474614868367 0.004442845690149 0.001469583350524 0.000262192118711 -0.000074809372293 0.000000000000000 ;
     0.002507501092786 0.001770318097234 0.001012755781683 0.000273873597462 -0.000008047721169 -0.000052072589621 0.000000000000000 ;
     0.000181137037123 0.000084638117076 -0.000002981410060 -0.000056739626230 -0.000045412974631 -0.000020612219898 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000022491738026 -0.000012626447388 -0.000042923289507 -0.000053048687171 -0.000033817407005 -0.000012496797999 0.000000000000000 ;
     0.001169726110609 0.000832106173601 0.000478728034362 0.000117507907602 -0.000023340765572 -0.000032705389723 0.000000000000000 ;
     0.005184407056939 0.003693146715026 0.002168452440313 0.000687480900462 0.000090306742408 -0.000064870986413 0.000000000000000 ;
     0.016998552155831 0.012213891862234 0.007283764446664 0.002459474800855 0.000504525463193 -0.000069651660852 0.000000000000000 ;
     0.036108061878175 0.026139766013348 0.015794512117921 0.005477964080289 0.001224277714785 -0.000014874924091 0.000000000000000 ;
     0.049160116029174 0.035643134272841 0.021598893250987 0.007536094178365 0.001713973585718 0.000033633214701 0.000000000000000 ;
     0.044421946711291 0.032172371879380 0.019458185548216 0.006764975541079 0.001529393367639 0.000011811605371 0.000000000000000 ;
     0.026577560921035 0.019157058862634 0.011490758987679 0.003933313929353 0.000852498412431 -0.000052328871376 0.000000000000000 ;
     0.010420712200161 0.007474614951516 0.004442845706981 0.001469583329268 0.000262192106379 -0.000074809376526 0.000000000000000 ;
     0.002507501086812 0.001770318080866 0.001012755758751 0.000273873578719 -0.000008047728539 -0.000052072591348 0.000000000000000 ;
     0.000181137014719 0.000084638097397 -0.000002981425547 -0.000056739634225 -0.000045412976867 -0.000020612220121 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000022491743947 -0.000012626441942 -0.000042923284810 -0.000053048684042 -0.000033817405559 -0.000012496797639 0.000000000000000 ;
     0.001169726113878 0.000832106178077 0.000478728039787 0.000117507912829 -0.000023340762230 -0.000032705388528 0.000000000000000 ;
     0.005184407036060 0.003693146701377 0.002168452434315 0.000687480902026 0.000090306746007 -0.000064870984388 0.000000000000000 ;
     0.016998552108006 0.012213891826029 0.007283764423826 0.002459474794106 0.000504525464517 -0.000069651658881 0.000000000000000 ;
     0.036108061850570 0.026139765986056 0.015794512094332 0.005477964068018 0.001224277712972 -0.000014874923121 0.000000000000000 ;
     0.049160116073952 0.035643134292851 0.021598893250482 0.007536094169109 0.001713973582426 0.000033633214519 0.000000000000000 ;
     0.044421946809136 0.032172371937077 0.019458185569487 0.006764975537932 0.001529393364569 0.000011811604458 0.000000000000000 ;
     0.026577561000657 0.019157058910537 0.011490759006382 0.003933313927642 0.000852498409829 -0.000052328872497 0.000000000000000 ;
     0.010420712229017 0.007474614967244 0.004442845710914 0.001469583325924 0.000262192104079 -0.000074809377419 0.000000000000000 ;
     0.002507501086169 0.001770318078240 0.001012755754777 0.000273873575245 -0.000008047730070 -0.000052072591765 0.000000000000000 ;
     0.000181137010649 0.000084638093767 -0.000002981428475 -0.000056739635833 -0.000045412977388 -0.000020612220203 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000022491744955 -0.000012626441017 -0.000042923284015 -0.000053048683514 -0.000033817405316 -0.000012496797579 0.000000000000000 ;
     0.001169726114447 0.000832106178848 0.000478728040715 0.000117507913717 -0.000023340761667 -0.000032705388328 0.000000000000000 ;
     0.005184407032529 0.003693146699090 0.002168452433333 0.000687480902315 0.000090306746619 -0.000064870984047 0.000000000000000 ;
     0.016998552099698 0.012213891819804 0.007283764419960 0.002459474793004 0.000504525464754 -0.000069651658547 0.000000000000000 ;
     0.036108061845314 0.026139765981115 0.015794512090249 0.005477964065987 0.001224277712687 -0.000014874922954 0.000000000000000 ;
     0.049160116080867 0.035643134295881 0.021598893250307 0.007536094167604 0.001713973581896 0.000033633214489 0.000000000000000 ;
     0.044421946825410 0.032172371946738 0.019458185573128 0.006764975537484 0.001529393364070 0.000011811604298 0.000000000000000 ;
     0.026577561014263 0.019157058918794 0.011490759009688 0.003933313927425 0.000852498409391 -0.000052328872699 0.000000000000000 ;
     0.010420712234083 0.007474614970048 0.004442845711669 0.001469583325377 0.000262192103671 -0.000074809377584 0.000000000000000 ;
     0.002507501086090 0.001770318077806 0.001012755754095 0.000273873574631 -0.000008047730352 -0.000052072591846 0.000000000000000 ;
     0.000181137009935 0.000084638093126 -0.000002981428996 -0.000056739636127 -0.000045412977488 -0.000020612220221 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ]
   )

const expected_none_bc = 
expected_data(
    # Expected vpa
    [-4.242640687119286, -3.535533905932738, -2.828427124746191, -2.121320343559643, -1.414213562373095, -0.707106781186548, 0.000000000000000, 0.707106781186547, 1.414213562373095, 2.121320343559643, 2.828427124746191, 3.535533905932738, 4.242640687119286],
    # Expected vperp
    [0.219275263435463, 0.912095586463014, 1.414213562373095, 2.121320343559643, 2.828427124746190, 3.535533905932738, 4.242640687119286],
    # Expected phi
    [0.000000000000000, -0.000000000000026, -0.000000000000053, -0.000000000000078, -0.000000000000105, -0.000000000000131, -0.000000000000158, -0.000000000000186, -0.000000000000214, -0.000000000000240, -0.000000000000261],
    # Expected n_ion
    [1.000000000000000, 0.999999999999974, 0.999999999999947, 0.999999999999922, 0.999999999999895, 0.999999999999869, 0.999999999999842, 0.999999999999814, 0.999999999999786, 0.999999999999760, 0.999999999999739],
    # Expected upar_ion
    [0.179871043200947, 0.179871043200947, 0.179871043200947, 0.179871043200949, 0.179871043200950, 0.179871043200951, 0.179871043200952, 0.179871043200952, 0.179871043200952, 0.179871043200954, 0.179871043200950],
    # Expected ppar_ion
    [0.307487392991066, 1.045759094889105, 1.047388189240058, 1.047438096310880, 1.047442817961899, 1.047443213514311, 1.047443243039768, 1.047443245059501, 1.047443245186793, 1.047443245194068, 1.047443245194416],
    # Expected pperp_ion
    [1.438642396802213, 1.069506545853152, 1.068691998677631, 1.068667045142177, 1.068664684316623, 1.068664486540374, 1.068664471777601, 1.068664470767689, 1.068664470703995, 1.068664470700310, 1.068664470700109],
    # Expected qpar_ion
    [-0.026637867950563, -0.002609929318745, -0.003448433445682, -0.003621921958480, -0.003647589019917, -0.003650426216359, -0.003650688762117, -0.003650710303087, -0.003650711915413, -0.003650712026889, -0.003650712034013],
    # Expected v_t_ion
    [1.457114085351702, 1.457114085351702, 1.457114085351701, 1.457114085351700, 1.457114085351700, 1.457114085351699, 1.457114085351698, 1.457114085351697, 1.457114085351696, 1.457114085351694, 1.457114085351696],
    # Expected dSdt_ion
    [0.000000000000000, 0.000482702266298, 0.000009475936585, 0.000000636913743, 0.000000056368643, 0.000000004849148, 0.000000000388188, 0.000000000028943, 0.000000000002017, 0.000000000000131, 0.000000000000008],
    # Expected maxnorm_ion
    [0.051952903218111, 0.000656298800735, 0.000728680073046, 0.000732771540497, 0.000732992343293, 0.000733001503378, 0.000733001644605, 0.000733001619984, 0.000733001616123, 0.000733001615735, 0.000733001615702],
    # Expected L2norm_ion
    [0.005794676226031, 0.000096972609028, 0.000108447514263, 0.000109413877004, 0.000109483476131, 0.000109488334402, 0.000109488657028, 0.000109488677158, 0.000109488678318, 0.000109488678378, 0.000109488678380],
    # Expected f_ion
    [0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000000000000008 0.000000000000084 0.000000000000140 0.000000000000051 0.000000000000003 0.000000000000000 0.000000000000000 ;
     0.000000000097012 0.000000001018760 0.000000001686796 0.000000000620538 0.000000000030895 0.000000000000208 0.000000000000000 ;
     0.000000158709589 0.000001666675496 0.000002759572688 0.000001015190058 0.000000050543337 0.000000000340558 0.000000000000311 ;
     0.000035139321288 0.000369012648462 0.000610987099129 0.000224769592590 0.000011190619073 0.000000075401798 0.000000000068758 ;
     0.001052918138669 0.011057131917284 0.018307678565963 0.006735018559993 0.000335316829505 0.000002259347025 0.000000002060258 ;
     0.004269793601022 0.044838880984366 0.074241297513697 0.027311847041181 0.001359776795892 0.000009162103981 0.000000008354757 ;
     0.002343312411961 0.024608099633655 0.040744487954235 0.014989059459421 0.000746261328076 0.000005028269276 0.000000004585188 ;
     0.000174046197710 0.001827731612846 0.003026238912872 0.001113291080119 0.000055427499119 0.000000373467551 0.000000000340558 ;
     0.000001749483791 0.000018372057958 0.000030419256476 0.000011190619073 0.000000557148117 0.000000003754034 0.000000000003423 ;
     0.000000002379942 0.000000024992760 0.000000041381384 0.000000015223361 0.000000000757926 0.000000000005107 0.000000000000005 ;
     0.000000000000438 0.000000000004601 0.000000000007619 0.000000000002803 0.000000000000140 0.000000000000001 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000070232295458 0.000058772566582 0.000045471789817 0.000024454928873 0.000008900007281 0.000002026894956 0.000000100759762 ;
     0.000048067416600 0.000026353362681 0.000007776425397 0.000000075954448 0.000003579709887 0.000003157103861 0.000001547868786 ;
     0.000981199005168 0.000700970104743 0.000415076464946 0.000135738180871 0.000030588447065 0.000007164328743 0.000008496096334 ;
     0.004408748378942 0.003023338206783 0.001669951027102 0.000493365170795 0.000113153316299 0.000002562172084 0.000028360229349 ;
     0.017014405942011 0.011791889018769 0.006610081950718 0.001982092334503 0.000440878537536 0.000009396813152 0.000060159269239 ;
     0.039611542510898 0.027739613219617 0.015839100433228 0.004878798857312 0.001057526858958 0.000054428569707 0.000091537044387 ;
     0.055544810174214 0.038982051090077 0.022353595026284 0.006935355468396 0.001492066821503 0.000093596156120 0.000109177698422 ;
     0.049468822286022 0.034676469579863 0.019841981746007 0.006138318805032 0.001329159405464 0.000078250948296 0.000103306676577 ;
     0.027754377014311 0.019339791069461 0.010951544821936 0.003344119600173 0.000740905157518 0.000028856808638 0.000077402498586 ;
     0.009665309203638 0.006705930073017 0.003773315648635 0.001144932777317 0.000257017891178 0.000005581926042 0.000042794770989 ;
     0.002071491569644 0.001441730378665 0.000815380647151 0.000246183482524 0.000052438098477 0.000005426974556 0.000016858993643 ;
     0.000170925690048 0.000105617856502 0.000047276481925 0.000009965278092 0.000006890079400 0.000005134489379 0.000004289204300 ;
     0.000136226355748 0.000108898903515 0.000077924635396 0.000037684787631 0.000013918110136 0.000003543774134 -0.000000597817923 ;;;
     0.000070560007968 0.000058873166841 0.000045414193354 0.000024497079501 0.000009261125599 0.000002412248783 0.000000148061635 ;
     0.000054398453695 0.000031791862148 0.000012002390032 0.000002340506144 0.000004429586722 0.000003597460607 0.000001904821256 ;
     0.000988202400702 0.000708149481384 0.000422191505607 0.000141365424179 0.000033468839535 0.000008012752256 0.000008733059156 ;
     0.004380470495821 0.002999935770799 0.001654680906699 0.000491629717993 0.000118210398868 0.000005227975343 0.000028296813794 ;
     0.017012446529212 0.011765803554393 0.006572087377544 0.001959845617792 0.000442974506154 0.000013679665448 0.000060226328109 ;
     0.039798463533994 0.027811994491927 0.015822882255087 0.004837491601822 0.001051842773375 0.000058699409340 0.000092108090592 ;
     0.055909781405747 0.039155225417378 0.022370976946615 0.006886315734123 0.001481084691219 0.000097267320138 0.000110060946125 ;
     0.049773545361319 0.034815410024826 0.019847770324450 0.006091735337635 0.001319926767075 0.000082023625831 0.000104110031905 ;
     0.027842576879601 0.019358659652940 0.010920735658385 0.003310458897188 0.000738700114625 0.000033058345082 0.000077854365919 ;
     0.009644773768284 0.006678572218267 0.003746249523941 0.001133237161051 0.000260462988050 0.000009036750255 0.000042862782531 ;
     0.002066819602812 0.001439094473298 0.000815666532604 0.000250134616652 0.000056696951341 0.000007106935054 0.000016827050386 ;
     0.000177220047629 0.000111793173491 0.000053012810032 0.000014072671578 0.000008756524506 0.000005620454652 0.000004524197635 ;
     0.000138573207307 0.000110669165934 0.000079026222913 0.000037996687708 0.000013949323454 0.000003778876220 -0.000000120580055 ;;;
     0.000070654044197 0.000058950296454 0.000045471610215 0.000024527658294 0.000009273793288 0.000002423075758 0.000000162720840 ;
     0.000054825024937 0.000032196267133 0.000012362147470 0.000002588273330 0.000004549355304 0.000003636470821 0.000001916490765 ;
     0.000988219734757 0.000708309054147 0.000422491290858 0.000141737347131 0.000033739031241 0.000008127550848 0.000008747177033 ;
     0.004377575387373 0.002997644501294 0.001653210200055 0.000491334284450 0.000118507584106 0.000005447919716 0.000028327602246 ;
     0.017010834345596 0.011763162120210 0.006569164223523 0.001958289086252 0.000443031602479 0.000013946429176 0.000060273682540 ;
     0.039809235173399 0.027816085959377 0.015821850644338 0.004835089293668 0.001051512347364 0.000058930162110 0.000092164539279 ;
     0.055932701040639 0.039166460314655 0.022372678965489 0.006883771752744 0.001480538238042 0.000097454812319 0.000110118750692 ;
     0.049793080959666 0.034824736206878 0.019848838309731 0.006089333653498 0.001319474532513 0.000082216580795 0.000104164140623 ;
     0.027848007495691 0.019359914710208 0.010918999691466 0.003308522447628 0.000738564752694 0.000033283972897 0.000077900714143 ;
     0.009642828863851 0.006676393720387 0.003744278848320 0.001132393912320 0.000260620163566 0.000009248454881 0.000042889234097 ;
     0.002065899927053 0.001438449822364 0.000815366552219 0.000250256978294 0.000056952835819 0.000007238484725 0.000016829784414 ;
     0.000177319281309 0.000111965761841 0.000053248911742 0.000014314474302 0.000008901927600 0.000005662226886 0.000004522158512 ;
     0.000138700567160 0.000110783436322 0.000079120685402 0.000038049374552 0.000013960127022 0.000003777347669 -0.000000112827778 ;;;
     0.000070663125135 0.000058957858393 0.000045477283269 0.000024530415163 0.000009274208242 0.000002423120131 0.000000163661991 ;
     0.000054865973710 0.000032234702552 0.000012396009896 0.000002611350974 0.000004560199598 0.000003639276276 0.000001916671297 ;
     0.000988227440123 0.000708328379056 0.000422521605968 0.000141772062953 0.000033763642319 0.000008137781448 0.000008747891849 ;
     0.004377336925401 0.002997462081326 0.001653098977829 0.000491317298966 0.000118534377728 0.000005467214741 0.000028330535392 ;
     0.017010621823678 0.011762906211535 0.006568918963412 0.001958170556003 0.000443038130019 0.000013968797879 0.000060278197981 ;
     0.039809911337432 0.027816306762173 0.015821730624012 0.004834901324557 0.001051487158936 0.000058948138083 0.000092169322899 ;
     0.055934371909664 0.039167272792295 0.022372792806955 0.006883578692851 0.001480495847640 0.000097467635754 0.000110123025440 ;
     0.049794633358010 0.034825496428261 0.019848952184747 0.006089161411513 0.001319438969566 0.000082228354459 0.000104167743985 ;
     0.027848540357460 0.019360093321797 0.010918913288227 0.003308384831684 0.000738551586636 0.000033297553971 0.000077903695361 ;
     0.009642744089092 0.006676268794585 0.003744147573758 0.001132329295732 0.000260627433903 0.000009261474914 0.000042890838234 ;
     0.002065832674340 0.001438399033547 0.000815338228049 0.000250259612293 0.000056968089098 0.000007246716210 0.000016829676807 ;
     0.000177318348627 0.000111971019022 0.000053260108430 0.000014328523796 0.000008910990401 0.000005664609651 0.000004521594917 ;
     0.000138708761785 0.000110790859004 0.000079126877836 0.000038052756764 0.000013960543198 0.000003776815538 -0.000000112656184 ;;;
     0.000070663903725 0.000058958489309 0.000045477730656 0.000024530589243 0.000009274179767 0.000002423089163 0.000000163758933 ;
     0.000054869797442 0.000032238227441 0.000012399043173 0.000002613325730 0.000004561048932 0.000003639434512 0.000001916651579 ;
     0.000988228808964 0.000708330641728 0.000422524655761 0.000141775225093 0.000033765736040 0.000008138576213 0.000008747893290 ;
     0.004377317672092 0.002997447877972 0.001653090855175 0.000491316634141 0.000118536799454 0.000005468825873 0.000028330741449 ;
     0.017010598459797 0.011762882411898 0.006568898613555 0.001958161723731 0.000443038962655 0.000013970701781 0.000060278558745 ;
     0.039809950766740 0.027816315922257 0.015821717949108 0.004834886624189 0.001051485394184 0.000058949650195 0.000092169709979 ;
     0.055934492680209 0.039167330738564 0.022372799833488 0.006883563904878 0.001480492653868 0.000097468625949 0.000110123349049 ;
     0.049794756734957 0.034825558146219 0.019848963204427 0.006089148989556 0.001319436226792 0.000082229122425 0.000104167981760 ;
     0.027848590719359 0.019360113610061 0.010918910277341 0.003308375049658 0.000738550397544 0.000033298357535 0.000077903866191 ;
     0.009642742816317 0.006676262582347 0.003744139039482 0.001132324308141 0.000260627631362 0.000009262225929 0.000042890910172 ;
     0.002065827771817 0.001438395012992 0.000815335609789 0.000250259261594 0.000056968898225 0.000007247183045 0.000016829641982 ;
     0.000177317601049 0.000111970784438 0.000053260406641 0.000014329221652 0.000008911496511 0.000005664725274 0.000004521539409 ;
     0.000138709263014 0.000110791311605 0.000079127250973 0.000038052944451 0.000013960541202 0.000003776762796 -0.000000112649135 ;;;
     0.000070663964917 0.000058958537193 0.000045477762192 0.000024530597730 0.000009274173162 0.000002423085355 0.000000163768937 ;
     0.000054870124189 0.000032238524222 0.000012399293299 0.000002613481306 0.000004561109475 0.000003639441189 0.000001916648533 ;
     0.000988228966178 0.000708330863803 0.000422524930468 0.000141775490127 0.000033765900580 0.000008138632457 0.000008747889154 ;
     0.004377316199849 0.002997446826972 0.001653090291778 0.000491316631637 0.000118537002083 0.000005468950927 0.000028330753623 ;
     0.017010596268446 0.011762880386055 0.006568897020575 0.001958161098018 0.000443039049380 0.000013970854408 0.000060278584730 ;
     0.039809952809353 0.027816316063484 0.015821716784125 0.004834885530142 0.001051485280398 0.000058949772454 0.000092169739278 ;
     0.055934501027998 0.039167334685434 0.022372800229814 0.006883562822829 0.001480492427495 0.000097468702298 0.000110123372749 ;
     0.049794766067581 0.034825562896675 0.019848964162578 0.006089148131313 0.001319436027478 0.000082229172642 0.000104167996978 ;
     0.027848595046958 0.019360115536268 0.010918910295362 0.003308374382643 0.000738550299853 0.000033298402454 0.000077903875024 ;
     0.009642743066533 0.006676262346064 0.003744138511098 0.001132323937923 0.000260627622195 0.000009262265392 0.000042890912144 ;
     0.002065827421012 0.001438394702846 0.000815335382968 0.000250259196932 0.000056968933507 0.000007247206773 0.000016829637876 ;
     0.000177317496165 0.000111970720819 0.000053260388565 0.000014329246691 0.000008911521215 0.000005664729703 0.000004521534782 ;
     0.000138709290397 0.000110791336442 0.000079127271325 0.000038052953600 0.000013960539163 0.000003776758474 -0.000000112648928 ;;;
     0.000070663969373 0.000058958540555 0.000045477764225 0.000024530597983 0.000009274172396 0.000002423085015 0.000000163769856 ;
     0.000054870149819 0.000032238547226 0.000012399312350 0.000002613492672 0.000004561113456 0.000003639441294 0.000001916648238 ;
     0.000988228980888 0.000708330882926 0.000422524952858 0.000141775510597 0.000033765912582 0.000008138636126 0.000008747888570 ;
     0.004377316094219 0.002997446753787 0.001653090255025 0.000491316634554 0.000118537017730 0.000005468959960 0.000028330754219 ;
     0.017010596085896 0.011762880227773 0.006568896903927 0.001958161056273 0.000443039057140 0.000013970865815 0.000060278586449 ;
     0.039809952895678 0.027816316038862 0.015821716688260 0.004834885453483 0.001051485273668 0.000058949781722 0.000092169741349 ;
     0.055934501572696 0.039167334938888 0.022372800249457 0.006883562748124 0.001480492412460 0.000097468707929 0.000110123374396 ;
     0.049794766731781 0.034825563239798 0.019848964238441 0.006089148075288 0.001319436013893 0.000082229175826 0.000104167997904 ;
     0.027848595387201 0.019360115697647 0.010918910311825 0.003308374339653 0.000738550292470 0.000033298404735 0.000077903875410 ;
     0.009642743105654 0.006676262343545 0.003744138480584 0.001132323911924 0.000260627620064 0.000009262267165 0.000042890912076 ;
     0.002065827396964 0.001438394680129 0.000815335364844 0.000250259189889 0.000056968934419 0.000007247207767 0.000016829637498 ;
     0.000177317485504 0.000111970713293 0.000053260384661 0.000014329246727 0.000008911522145 0.000005664729765 0.000004521534428 ;
     0.000138709291659 0.000110791337608 0.000079127272282 0.000038052953948 0.000013960538913 0.000003776758151 -0.000000112648937 ;;;
     0.000070663969675 0.000058958540774 0.000045477764344 0.000024530597975 0.000009274172325 0.000002423084989 0.000000163769933 ;
     0.000054870151681 0.000032238548880 0.000012399313698 0.000002613493444 0.000004561113696 0.000003639441276 0.000001916648214 ;
     0.000988228982100 0.000708330884418 0.000422524954535 0.000141775512064 0.000033765913397 0.000008138636346 0.000008747888511 ;
     0.004377316087131 0.002997446749020 0.001653090252796 0.000491316634950 0.000118537018852 0.000005468960568 0.000028330754240 ;
     0.017010596072031 0.011762880216324 0.006568896895947 0.001958161053674 0.000443039057763 0.000013970866611 0.000060278586553 ;
     0.039809952897653 0.027816316035001 0.015821716681041 0.004834885448453 0.001051485273312 0.000058949782379 0.000092169741485 ;
     0.055934501605839 0.039167334954021 0.022372800250214 0.006883562743291 0.001480492411531 0.000097468708321 0.000110123374504 ;
     0.049794766776046 0.034825563262981 0.019848964243980 0.006089148071874 0.001319436013030 0.000082229176018 0.000104167997956 ;
     0.027848595411928 0.019360115709944 0.010918910313883 0.003308374337071 0.000738550291953 0.000033298404832 0.000077903875421 ;
     0.009642743109607 0.006676262344278 0.003744138478994 0.001132323910211 0.000260627619829 0.000009262267219 0.000042890912059 ;
     0.002065827395408 0.001438394678565 0.000815335363504 0.000250259189262 0.000056968934379 0.000007247207790 0.000016829637468 ;
     0.000177317484584 0.000111970712596 0.000053260384231 0.000014329246618 0.000008911522155 0.000005664729753 0.000004521534403 ;
     0.000138709291698 0.000110791337647 0.000079127272314 0.000038052953953 0.000013960538889 0.000003776758129 -0.000000112648939 ;;;
     0.000070663969694 0.000058958540787 0.000045477764350 0.000024530597972 0.000009274172319 0.000002423084987 0.000000163769938 ;
     0.000054870151807 0.000032238548991 0.000012399313787 0.000002613493493 0.000004561113709 0.000003639441273 0.000001916648212 ;
     0.000988228982191 0.000708330884526 0.000422524954652 0.000141775512161 0.000033765913449 0.000008138636357 0.000008747888506 ;
     0.004377316086689 0.002997446748732 0.001653090252673 0.000491316634989 0.000118537018927 0.000005468960606 0.000028330754239 ;
     0.017010596071058 0.011762880215555 0.006568896895439 0.001958161053526 0.000443039057809 0.000013970866663 0.000060278586559 ;
     0.039809952897520 0.027816316034611 0.015821716680537 0.004834885448147 0.001051485273296 0.000058949782423 0.000092169741493 ;
     0.055934501607677 0.039167334954838 0.022372800250222 0.006883562743001 0.001480492411478 0.000097468708347 0.000110123374510 ;
     0.049794766778785 0.034825563264437 0.019848964244355 0.006089148071684 0.001319436012979 0.000082229176029 0.000104167997959 ;
     0.027848595413596 0.019360115710808 0.010918910314074 0.003308374336930 0.000738550291919 0.000033298404835 0.000077903875420 ;
     0.009642743109942 0.006676262344383 0.003744138478925 0.001132323910106 0.000260627619808 0.000009262267218 0.000042890912057 ;
     0.002065827395315 0.001438394678464 0.000815335363412 0.000250259189212 0.000056968934370 0.000007247207789 0.000016829637465 ;
     0.000177317484512 0.000111970712540 0.000053260384193 0.000014329246604 0.000008911522152 0.000005664729751 0.000004521534401 ;
     0.000138709291698 0.000110791337647 0.000079127272314 0.000038052953952 0.000013960538887 0.000003776758127 -0.000000112648940 ;;;
     0.000070663969695 0.000058958540788 0.000045477764351 0.000024530597972 0.000009274172319 0.000002423084987 0.000000163769939 ;
     0.000054870151815 0.000032238548997 0.000012399313792 0.000002613493496 0.000004561113710 0.000003639441273 0.000001916648212 ;
     0.000988228982197 0.000708330884533 0.000422524954659 0.000141775512167 0.000033765913452 0.000008138636358 0.000008747888506 ;
     0.004377316086664 0.002997446748716 0.001653090252667 0.000491316634992 0.000118537018931 0.000005468960608 0.000028330754239 ;
     0.017010596070994 0.011762880215507 0.006568896895410 0.001958161053518 0.000443039057812 0.000013970866666 0.000060278586559 ;
     0.039809952897493 0.027816316034578 0.015821716680505 0.004834885448130 0.001051485273296 0.000058949782425 0.000092169741494 ;
     0.055934501607764 0.039167334954875 0.022372800250220 0.006883562742986 0.001480492411476 0.000097468708348 0.000110123374511 ;
     0.049794766778938 0.034825563264520 0.019848964244378 0.006089148071675 0.001319436012976 0.000082229176029 0.000104167997959 ;
     0.027848595413700 0.019360115710864 0.010918910314089 0.003308374336923 0.000738550291917 0.000033298404835 0.000077903875420 ;
     0.009642743109967 0.006676262344394 0.003744138478923 0.001132323910100 0.000260627619806 0.000009262267217 0.000042890912057 ;
     0.002065827395309 0.001438394678458 0.000815335363406 0.000250259189209 0.000056968934369 0.000007247207788 0.000016829637465 ;
     0.000177317484507 0.000111970712536 0.000053260384190 0.000014329246603 0.000008911522152 0.000005664729751 0.000004521534401 ;
     0.000138709291698 0.000110791337647 0.000079127272314 0.000038052953951 0.000013960538887 0.000003776758127 -0.000000112648940 ]
   )
###########################################################################################
# to modify the test, with a new expected f, print the new f using the following commands
# in an interative Julia REPL. The path is the path to the .dfns file. 
########################################################################################## 

"""
Function to print data from a moment_kinetics run suitable
for copying into the expected data structure.
"""
function print_output_data_for_test_update(path; write_grid=true, write_pdf=true)
    fid = open_readonly_output_file(path, "dfns")
    input = load_input(fid)
    f_ion_vpavperpzrst = load_pdf_data(fid)
    f_ion = f_ion_vpavperpzrst[:,:,1,1,1,:]
    ntind = size(f_ion,3)
    nvperp = size(f_ion,2)
    nvpa = size(f_ion,1)
    vpa, vpa_spectral = load_coordinate_data(fid, "vpa"; ignore_MPI=true)
    vperp, vperp_spectral = load_coordinate_data(fid, "vperp"; ignore_MPI=true)
    # grid
    function print_grid(coord)
        println("# Expected "*coord.name)
        print("[")
        for k in 1:coord.n
            @printf("%.15f", coord.grid[k])
            if k < coord.n
                print(", ")
            end
        end
        print("],\n")
        return nothing
    end
    # pdf
    function print_pdf(pdf)
        println("# Expected f_ion")
        print("[")
        for k in 1:ntind
            for i in 1:nvpa-1
                for j in 1:nvperp-1
                    @printf("%.15f ", pdf[i,j,k])
                end
                @printf("%.15f ", pdf[i,nvperp,k])
                print(";\n")
            end
            for j in 1:nvperp-1
                @printf("%.15f ", pdf[nvpa,j,k])
            end
            @printf("%.15f ", pdf[nvpa,nvperp,k])
            if k < ntind
                print(";;;\n")
            end
        end
        print("]\n")
        return nothing
    end
    # a moment
    function print_moment(moment,moment_name)
        println("# Expected "*moment_name)
        print("[")
        for k in 1:ntind
            @printf("%.15f", moment[1,1,1,k])
            if k < ntind
                print(", ")
            end
        end
        print("],\n")
        return nothing
    end    
    # a field
    function print_field(field,field_name)
        println("# Expected "*field_name)
        print("[")
        for k in 1:ntind
            @printf("%.15f", field[1,1,k])
            if k < ntind
                print(", ")
            end
        end
        print("],\n")
        return nothing
    end
    # the norms
    function print_norms(pdf)
        L2norm_ion = copy(pdf[1,1,:])
        maxnorm_ion = copy(pdf[1,1,:])
        f_dummy_1 = copy(pdf[:,:,1])
        f_dummy_2 = copy(pdf[:,:,1])
        f_dummy_3 = copy(pdf[:,:,1])
        mass = input["ion_species_1"]["mass"]
        for it in 1:ntind
            @views output = diagnose_F_Maxwellian_serial(pdf[:,:,it],
                                                        f_dummy_1,f_dummy_2,f_dummy_3,
                                                        vpa,vperp,mass)
            maxnorm_ion[it] = output[1]
            L2norm_ion[it] = output[2]
        end
        println("# Expected maxnorm_ion")
        print("[")
        for k in 1:ntind
            @printf("%.15f", maxnorm_ion[k])
            if k < ntind
                print(", ")
            end
        end
        print("],\n")
        println("# Expected L2norm_ion")
        print("[")
        for k in 1:ntind
            @printf("%.15f", L2norm_ion[k])
            if k < ntind
                print(", ")
            end
        end
        print("],\n")
        return nothing
    end
    n_ion_zrst, upar_ion_zrst, p_ion_zrst, ppar_ion_zrst, pperp_ion_zrst, qpar_ion_zrst, v_t_ion_zrst, dSdt_zrst = load_ion_moments_data(fid,extended_moments=true)
    phi_zrt, Er_zrt, Ez_zrt = load_fields_data(fid)
    if write_grid
        print_grid(vpa)
        print_grid(vperp)
    end
    print_field(phi_zrt,"phi")
    print_moment(n_ion_zrst,"n_ion")
    print_moment(upar_ion_zrst,"upar_ion")
    print_moment(ppar_ion_zrst,"ppar_ion")
    print_moment(pperp_ion_zrst,"pperp_ion")
    print_moment(qpar_ion_zrst,"qpar_ion")
    print_moment(v_t_ion_zrst,"v_t_ion")
    print_moment(dSdt_zrst,"dSdt_ion")
    print_norms(f_ion)
    if write_pdf
        print_pdf(f_ion)
    end
    return nothing
end

function diagnose_F_Maxwellian_serial(pdf,pdf_exact,pdf_dummy_1,pdf_dummy_2,vpa,vperp,mass)
    # call this function from a single process
    # construct the local-in-time Maxwellian for this pdf
    dens = get_density(pdf,vpa,vperp)
    upar = get_upar(pdf, dens, vpa, vperp, false)
    pressure = get_p(pdf, dens, upar, vpa, vperp, false, false)
    vth = sqrt(2.0*pressure/(dens*mass))
    for ivperp in 1:vperp.n
        for ivpa in 1:vpa.n
            pdf_exact[ivpa,ivperp] = F_Maxwellian(dens,upar,vth,vpa,vperp,ivpa,ivperp)
        end
    end
    # check how close the pdf is to the Maxwellian with
    # maximum of difference and L2 of difference
    max_err, L2norm = print_test_data(pdf_exact,pdf,pdf_dummy_1,"F",vpa,vperp,pdf_dummy_2;print_to_screen=false)
    return max_err, L2norm
end

# default inputs for tests
test_input_gauss_legendre = OptionsDict("output" => OptionsDict("run_name" => "gausslegendre_pseudospectral",
                                                                "base_directory" => test_output_directory),
                                        "composition" => OptionsDict("n_ion_species" => 1,
                                                                     "n_neutral_species" => 0,
                                                                     "electron_physics" => "boltzmann_electron_response",
                                                                     "T_e" => 1.0),
                                        "ion_species_1" => OptionsDict("initial_density" => 1.0,
                                                                       "initial_temperature" => 1.0,
                                                                       "mass" => 1.0),
                                        "z_IC_ion_species_1" => OptionsDict("initialization_option" => "sinusoid",
                                                                            "density_amplitude" => 0.0,
                                                                            "density_phase" => 0.0,
                                                                            "upar_amplitude" => 0.0,
                                                                            "upar_phase" => 0.0,
                                                                            "temperature_amplitude" => 0.0,
                                                                            "temperature_phase" => 0.0),
                                        "vpa_IC_ion_species_1" => OptionsDict("initialization_option" => "directed-beam",
                                                                              "vpa0" => sqrt(2) * 0.1,
                                                                              "vperp0" => sqrt(2) * 1.0,
                                                                              "vth0" => sqrt(2) * 0.5),
                                        "vpa" => OptionsDict("ngrid" => 3,
                                                             "L" => 8.485281374238571,
                                                             "nelement" => 6,
                                                             "bc" => "zero",
                                                             "discretization" => "gausslegendre_pseudospectral"),
                                        "vperp" => OptionsDict("ngrid" => 3,
                                                               "nelement" => 3,
                                                               "L" => 4.242640687119286,
                                                               "discretization" => "gausslegendre_pseudospectral"),
                                        "reactions" => OptionsDict("ionization_frequency" => 0.0,
                                                                   "charge_exchange_frequency" => 0.0),
                                        "fokker_planck_collisions" => OptionsDict("use_fokker_planck" => true,
                                                                                  "nuii" => 4.0,
                                                                                  "frequency_option" => "manual"),
                                        "evolve_moments" => OptionsDict("pressure" => false,
                                                                        "moments_conservation" => false,
                                                                        "parallel_flow" => false,
                                                                        "density" => false),
                                        "z" => OptionsDict("discretization" => "chebyshev_pseudospectral",
                                                           "ngrid" => 1,
                                                           "nelement_local" => 1,
                                                           "nelement" => 1,
                                                           "bc" => "wall"),
                                        "r" => OptionsDict("discretization" => "chebyshev_pseudospectral",
                                                           "ngrid" => 1,
                                                           "nelement" => 1,
                                                           "nelement_local" => 1),
                                        "timestepping" => OptionsDict("dt" => 0.0070710678118654745,
                                                                      "nstep" => 5000,
                                                                      "nwrite" => 500,
                                                                      "nwrite_dfns" => 500))

"""
Run a test for a single set of parameters
"""
# Note 'name' should not be shared by any two tests in this file
function run_test(test_input, expected, atol, final_atol; args...)
    # by passing keyword arguments to run_test, args becomes a Dict which can be used to
    # update the default inputs

    # Make a copy to make sure nothing modifies the input Dicts defined in this test
    # script.
    input = deepcopy(test_input)
    
    # Convert keyword arguments to a unique name
    function stringify_arg(key, value)
        if isa(value, AbstractDict)
            return string(string(key)[1], (stringify_arg(k, v) for (k, v) in value)...)
        else
            return string(string(key)[1], value)
        end
    end
    name = input["output"]["run_name"]
    if length(args) > 0
        name = string(name[1], "_", (stringify_arg(k, v) for (k, v) in args)...)
    end

    # Provide some progress info
    println("    - testing ", name)

    # Update default inputs with values to be changed
    merge_dict_with_kwargs!(input; args...)
    input["output"]["run_name"] = name
    # Suppress console output while running
    quietoutput() do
        # run simulation
        run_moment_kinetics(input)
    end

    phi = nothing
    n_ion = nothing
    upar_ion = nothing
    ppar_ion = nothing
    pperp_ion = nothing
    qpar_ion = nothing
    v_t_ion = nothing
    dSdt = nothing
    maxnorm_ion = nothing
    L2norm_ion = nothing
    f_ion = nothing
    f_err = nothing
    vpa, vpa_spectral = nothing, nothing
    vperp, vperp_spectral = nothing, nothing

    if global_rank[] == 0
        ntime = 0
        quietoutput() do

            # Load and analyse output
            #########################

            path = joinpath(realpath(input["output"]["base_directory"]), name, name)

            # open the netcdf file containing moments data and give it the handle 'fid'
            fid = open_readonly_output_file(path, "moments")

            # load species, time coordinate data
            n_ion_species, n_neutral_species = load_species_data(fid)
            ntime, time = load_time_data(fid)
            n_ion_species, n_neutral_species = load_species_data(fid)
            
            # load fields data
            phi_zrt, Er_zrt, Ez_zrt = load_fields_data(fid)

            # load velocity moments data
            n_ion_zrst, upar_ion_zrst, p_ion_zrst,  ppar_ion_zrst,
            pperp_ion_zrst, qpar_ion_zrst, v_t_ion_zrst, dSdt_zrst = load_ion_moments_data(fid,extended_moments=true)
            
            close(fid)
            
            # open the netcdf file containing pdf data
            fid = open_readonly_output_file(path, "dfns")
            # load coordinates
            vpa, vpa_spectral = load_coordinate_data(fid, "vpa"; ignore_MPI=true)
            vperp, vperp_spectral = load_coordinate_data(fid, "vperp"; ignore_MPI=true)

            # load particle distribution function (pdf) data
            f_ion_vpavperpzrst = load_pdf_data(fid)
            
            close(fid)
            # select the single z, r, s point
            # keep the two time points in the arrays
            phi = phi_zrt[1,1,:]
            n_ion = n_ion_zrst[1,1,1,:]
            upar_ion = upar_ion_zrst[1,1,1,:]
            ppar_ion = ppar_ion_zrst[1,1,1,:]
            pperp_ion = pperp_ion_zrst[1,1,1,:]
            qpar_ion = qpar_ion_zrst[1,1,1,:]
            v_t_ion = v_t_ion_zrst[1,1,1,:]
            dSdt = dSdt_zrst[1,1,1,:]
            f_ion = f_ion_vpavperpzrst[:,:,1,1,1,:]
            f_dummy_1 = copy(f_ion[:,:,1])
            f_dummy_2 = copy(f_ion[:,:,1])
            f_dummy_3 = copy(f_ion[:,:,1])
            L2norm_ion = copy(phi)
            maxnorm_ion = copy(phi)
            mass = input["ion_species_1"]["mass"]

            for it in 1:ntime
                @views output = diagnose_F_Maxwellian_serial(f_ion[:,:,it],
                                                            f_dummy_1,f_dummy_2,f_dummy_3,
                                                            vpa,vperp,mass)
                maxnorm_ion[it] = output[1]
                L2norm_ion[it] = output[2]
            end
        end
        
        function test_values(tind)
            @testset "tind=$tind" begin
                # Check grids
                #############

                if tind == ntime
                    this_atol = final_atol
                else
                    this_atol = atol
                end
                
                @test isapprox(expected.vpa[:], vpa.grid[:], atol=this_atol)
                @test isapprox(expected.vperp[:], vperp.grid[:], atol=this_atol)
            
                # Check electrostatic potential
                ###############################
                
                @test isapprox(expected.phi[tind], phi[tind], atol=this_atol)

                # Check ion particle moments and f
                ######################################

                @test isapprox(expected.n_ion[tind], n_ion[tind], atol=this_atol)
                @test isapprox(expected.upar_ion[tind], upar_ion[tind], atol=this_atol)
                @test isapprox(expected.ppar_ion[tind], ppar_ion[tind], atol=this_atol)
                @test isapprox(expected.pperp_ion[tind], pperp_ion[tind], atol=this_atol)
                @test isapprox(expected.qpar_ion[tind], qpar_ion[tind], atol=this_atol)
                @test isapprox(expected.v_t_ion[tind], v_t_ion[tind], atol=this_atol)
                @test isapprox(expected.dSdt[tind], dSdt[tind], atol=this_atol)
                @test isapprox(expected.maxnorm_ion[tind], maxnorm_ion[tind], atol=this_atol)
                @test isapprox(expected.L2norm_ion[tind], L2norm_ion[tind], atol=this_atol)
                f_err = @. abs(expected.f_ion[:,:,tind] - f_ion[:,:,tind])
                max_f_err = maximum(f_err)
                @test isapprox(max_f_err, 0.0, atol=this_atol)
                @test isapprox(expected.f_ion[:,:,tind], f_ion[:,:,tind], atol=this_atol)
            end
        end

        for it ∈ 1:ntime
            test_values(it)
        end
    end
end


function runtests()
    @testset "Fokker Planck dFdt = C[F,F] relaxation test" verbose=use_verbose begin
        println("Fokker Planck dFdt = C[F,F] relaxation test")

        # GaussLegendre pseudospectral
        # Benchmark data is taken from this run (GaussLegendre)
        @testset "Gauss Legendre base" begin
            run_name = "gausslegendre_pseudospectral"
            vperp_bc = "zero-impose-regularity"
            run_test(test_input_gauss_legendre,
             expected_zero_impose_regularity, 2.0e-14, 2.0e-14;
             vperp=OptionsDict("bc" => vperp_bc))
        end
        @testset "Gauss Legendre no enforced regularity condition at vperp = 0" begin
            run_name = "gausslegendre_pseudospectral_no_regularity"
            vperp_bc = "zero"
            run_test(test_input_gauss_legendre,
            expected_zero,
             1.0e-14, 2.0e-14; vperp=OptionsDict("bc" => vperp_bc))
        end
        @testset "Gauss Legendre no (explicitly) enforced boundary conditions: explicit timestepping" begin
            run_name = "gausslegendre_pseudospectral_none_bc"
            vperp_bc = "none"
            vpa_bc = "none"
            run_test(test_input_gauss_legendre, expected_none_bc, 1.0e-14, 2.0e-14;
                     vperp=OptionsDict("bc" => vperp_bc), vpa=OptionsDict("bc" => vpa_bc))
        end
        @testset "Gauss Legendre no (explicitly) enforced boundary conditions: IMEX timestepping" begin
            run_name = "gausslegendre_pseudospectral_none_bc"
            vperp_bc = "none"
            vpa_bc = "none"
            run_test(test_input_gauss_legendre, expected_none_bc, 1.0e-5, 5.0e-12;
                     vperp=OptionsDict("bc" => vperp_bc), vpa=OptionsDict("bc" => vpa_bc),
                     fokker_planck_collisions_nonlinear_solver=OptionsDict("rtol" => 0.0,
                                                                           "atol" => 1.0e-14,
                                                                           "nonlinear_max_iterations" => 20,),
                     timestepping=OptionsDict("kinetic_ion_solver" => "implicit_ion_fp_collisions",
                                              "type" => "PareschiRusso3(4,3,3)",))
        end
    end
end

end # FokkerPlanckTimeEvolutionTests


using .FokkerPlanckTimeEvolutionTests

FokkerPlanckTimeEvolutionTests.runtests()
