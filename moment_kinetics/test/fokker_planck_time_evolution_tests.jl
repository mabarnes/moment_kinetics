module FokkerPlanckTimeEvolutionTests
include("setup.jl")

export print_output_data_for_test_update

using Base.Filesystem: tempname
using MPI
using Printf
using moment_kinetics.load_data: open_readonly_output_file, load_coordinate_data,
                                 load_species_data, load_fields_data,
                                 load_ion_moments_data, load_pdf_data,
                                 load_time_data, load_species_data,
                                 load_input
using moment_kinetics.type_definitions: mk_float
using moment_kinetics.utils: merge_dict_with_kwargs!
using moment_kinetics.input_structs: options_to_TOML
using moment_kinetics.fokker_planck_test: F_Maxwellian, print_test_data
using moment_kinetics.velocity_moments: get_density, get_upar, get_p

const analytical_rtol = 3.e-2
const regression_rtol = 2.e-8

# Create a temporary directory for test output
test_output_directory = tempname()
mkpath(test_output_directory)

# The expected output
struct expected_data
    vpa::Array{mk_float, 1}
    vperp::Array{mk_float, 1}
    phi::Array{mk_float, 1} #time
    n_ion::Array{mk_float, 1} #time
    upar_ion::Array{mk_float, 1} # time
    ppar_ion::Array{mk_float, 1} # time
    pperp_ion::Array{mk_float, 1} # time
    qpar_ion::Array{mk_float, 1} # time
    v_t_ion::Array{mk_float, 1} # time
    dSdt::Array{mk_float, 1} # time
    maxnorm_ion::Array{mk_float, 1} # time
    L2norm_ion::Array{mk_float, 1} # time
    f_ion::Array{mk_float, 3} # vpa, vperp, time
end

const expected_zero_impose_regularity =
expected_data(
    # Expected vpa
    [-4.242640687119286, -3.535533905932738, -2.828427124746191, -2.121320343559643, -1.414213562373095, -0.707106781186548, 0.000000000000000, 0.707106781186547, 1.414213562373095, 2.121320343559643, 2.828427124746191, 3.535533905932738, 4.242640687119286],
    # Expected vperp
    [0.219275263435463, 0.912095586463014, 1.414213562373095, 2.121320343559643, 2.828427124746190, 3.535533905932738, 4.242640687119286],
    # Expected phi
    [0.424311210366090, 0.418696773460073, 0.412541600016484, 0.406590963054352, 0.400832037230537, 0.395253154087420, 0.389843673352561, 0.384593866655668, 0.379494817105980, 0.374538332203836, 0.369716868033057],
    # Expected n_ion
    [1.528537216397573, 1.519979386814641, 1.510652384164635, 1.501689733438171, 1.493066467859031, 1.484760016415021, 1.476749920473106, 1.469017583247741, 1.461546054836683, 1.454319846970883, 1.447324772736676],
    # Expected upar_ion
    [0.179871043200945, 0.179863520720943, 0.179848363977717, 0.179833567144390, 0.179819125629888, 0.179805026749567, 0.179791258128955, 0.179777807822487, 0.179764664325337, 0.179751816577034, 0.179739253959215],
    # Expected ppar_ion
    [0.470005923759898, 1.520758387708849, 1.517915612063440, 1.515111832221127, 1.512395142686358, 1.509760710269580, 1.507203992169828, 1.504720810149777, 1.502307312605061, 1.499959941295198, 1.497675402230550],
    # Expected pperp_ion
    [2.158648773471571, 1.628661339704807, 1.624611488209374, 1.620735080740650, 1.616995543669706, 1.613384001344814, 1.609892445238363, 1.606513580768935, 1.603240746269187, 1.600067843051899, 1.596989274737278],
    # Expected qpar_ion
    [-0.040716972527942, -0.019504349092415, -0.019526998393827, -0.019503906184063, -0.019473665497574, -0.019437681666490, -0.019396787414943, -0.019351707304549, -0.019303074121349, -0.019251441221394, -0.019197293056426],
    # Expected v_t_ion
    [1.444980016911830, 1.447645678670214, 1.450444077768904, 1.453154390483465, 1.455781972994547, 1.458331732010636, 1.460808148910697, 1.463215327204138, 1.465557033613838, 1.467836733765182, 1.470057623303134],
    # Expected dSdt_ion
    [0.000000000000000, 0.000609554379145, 0.000554531920233, 0.000540575871009, 0.000528873610397, 0.000519924053972, 0.000515829001327, 0.000529285728471, 0.000491828890030, 0.000476090045795, 0.000465148618005],
    # Expected maxnorm_ion
    [0.076987257755262, 0.018375054360608, 0.018128234099638, 0.017900232580447, 0.017681733904340, 0.017472071945031, 0.017270652894529, 0.017076938773316, 0.016890440732787, 0.016710713331441, 0.016537349615136],
    # Expected L2norm_ion
    [0.008348958646165, 0.001141543703609, 0.001129453247510, 0.001118497701644, 0.001107957297095, 0.001097803835046, 0.001088012538471, 0.001078560938397, 0.001069428591980, 0.001060596843421, 0.001052048619392],
    # Expected f_ion
    [0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000000000000071 0.000000000000126 0.000000000000209 0.000000000000077 0.000000000000004 0.000000000000000 0.000000000000000 ;
     0.000000000855715 0.000000001528140 0.000000002530195 0.000000000930807 0.000000000046342 0.000000000000312 0.000000000000000 ;
     0.000001399936522 0.000002500013243 0.000004139359032 0.000001522785088 0.000000075815005 0.000000000510837 0.000000000000000 ;
     0.000309954928248 0.000553518972694 0.000916480648693 0.000337154388886 0.000016785928610 0.000000113102697 0.000000000000000 ;
     0.009287520480193 0.016585697875925 0.027461517848945 0.010102527839989 0.000502975244258 0.000003389020538 0.000000000000000 ;
     0.037662752743348 0.067258321476549 0.111361946270545 0.040967770561772 0.002039665193838 0.000013743155972 0.000000000000000 ;
     0.020669756952881 0.036912149450483 0.061116731931353 0.022483589189131 0.001119391992114 0.000007542403914 0.000000000000000 ;
     0.001535216809711 0.002741597419270 0.004539358369308 0.001669936620178 0.000083141248679 0.000000560201327 0.000000000000000 ;
     0.000015431747204 0.000027558086936 0.000045628884714 0.000016785928610 0.000000835722175 0.000000005631052 0.000000000000000 ;
     0.000000020992856 0.000000037489141 0.000000062072076 0.000000022835041 0.000000001136890 0.000000000007660 0.000000000000000 ;
     0.000000000003865 0.000000000006902 0.000000000011428 0.000000000004204 0.000000000000209 0.000000000000001 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000013817720908 -0.000025851240844 -0.000043783717593 -0.000041669590969 -0.000019806714802 -0.000006199299009 0.000000000000000 ;
     0.001178879453964 0.000934221217660 0.000569628965558 0.000159016594774 0.000005010579927 -0.000018093775500 0.000000000000000 ;
     0.006059588513259 0.004776152367476 0.002863562454744 0.000818912407239 0.000088792392733 -0.000066171793774 0.000000000000000 ;
     0.022335163161649 0.017833053995170 0.011123964021263 0.003582291069693 0.000594804934106 -0.000107177294658 0.000000000000000 ;
     0.049542784273327 0.039921547275491 0.025583879686402 0.008774467294535 0.001643132812452 -0.000072761639069 0.000000000000000 ;
     0.068212953569277 0.055115330275229 0.035597115617447 0.012428216830444 0.002399195364620 -0.000025688689876 0.000000000000000 ;
     0.061393196809047 0.049547398985758 0.031894667683529 0.011053757705417 0.002111533128154 -0.000048312938661 0.000000000000000 ;
     0.035833325590311 0.028751274921230 0.018197529247445 0.006075041564204 0.001089008462321 -0.000103933823727 0.000000000000000 ;
     0.013145286153022 0.010459802908206 0.006457867804758 0.002010768245650 0.000294756458241 -0.000092825365032 0.000000000000000 ;
     0.002722350072818 0.002134644415228 0.001258839322738 0.000323458015661 0.000004845999313 -0.000042801193142 0.000000000000000 ;
     0.000069340326286 0.000024272554740 -0.000042887907845 -0.000069568322497 -0.000036044521222 -0.000013122565776 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000012092463698 -0.000024450630571 -0.000042866899568 -0.000041433067332 -0.000019879565319 -0.000006259819511 0.000000000000000 ;
     0.001181887997482 0.000936885409948 0.000571780002055 0.000160086547327 0.000005082847529 -0.000018217955212 0.000000000000000 ;
     0.006060825777319 0.004781427636352 0.002874855200458 0.000828888074157 0.000091196675561 -0.000065878668247 0.000000000000000 ;
     0.022188180564096 0.017728241328652 0.011081993425216 0.003589597183989 0.000600317043563 -0.000105456013563 0.000000000000000 ;
     0.049042506331695 0.039542138938032 0.025384592492062 0.008748145477962 0.001649037411912 -0.000069160779225 0.000000000000000 ;
     0.067444190796747 0.054525411378443 0.035273711727133 0.012371765268475 0.002403965143137 -0.000021012511745 0.000000000000000 ;
     0.060726559883811 0.049038018786354 0.031619633094947 0.011009719903474 0.002116860583597 -0.000044009193530 0.000000000000000 ;
     0.035524267806607 0.028521723981575 0.018086460234936 0.006069414428006 0.001095181187415 -0.000101213815265 0.000000000000000 ;
     0.013091614718103 0.010424791347404 0.006450663382726 0.002021033217995 0.000298726883145 -0.000091925906153 0.000000000000000 ;
     0.002729118915503 0.002141521068989 0.001265876637689 0.000327861950038 0.000005637477985 -0.000042873087356 0.000000000000000 ;
     0.000074867513743 0.000028827125978 -0.000039782739427 -0.000068580917533 -0.000036121085975 -0.000013246683351 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000010680040054 -0.000023327309926 -0.000042174403223 -0.000041321196885 -0.000019990299589 -0.000006322474259 0.000000000000000 ;
     0.001184715900110 0.000939342694331 0.000573684987269 0.000160918699347 0.000005020384399 -0.000018377786027 0.000000000000000 ;
     0.006062685641715 0.004787069869166 0.002886133958085 0.000838582511215 0.000093373304132 -0.000065696128442 0.000000000000000 ;
     0.022047209065298 0.017627941159586 0.011042302095349 0.003597157610852 0.000605669604308 -0.000103909047453 0.000000000000000 ;
     0.048559919886419 0.039176405002568 0.025192993383855 0.008723545765914 0.001655036002786 -0.000065752045094 0.000000000000000 ;
     0.066701678247871 0.053955904712770 0.034962020230642 0.012318154456776 0.002409022462686 -0.000016524253544 0.000000000000000 ;
     0.060082531688985 0.048546170265840 0.031354564310200 0.010968027170087 0.002122400060908 -0.000039894909736 0.000000000000000 ;
     0.035226037970070 0.028300437260540 0.017979834946064 0.006064616489672 0.001101310118035 -0.000098681446964 0.000000000000000 ;
     0.013040375872992 0.010391543455641 0.006444225797036 0.002031211257526 0.000302490930091 -0.000091171263808 0.000000000000000 ;
     0.002735923608163 0.002148352315722 0.001272747455575 0.000332015649309 0.000006242561792 -0.000043017194865 0.000000000000000 ;
     0.000080098426161 0.000033106597547 -0.000036921114922 -0.000067761238804 -0.000036275506343 -0.000013389025078 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000009284702930 -0.000022215719120 -0.000041485654135 -0.000041204493816 -0.000020096492646 -0.000006383727522 0.000000000000000 ;
     0.001187502733751 0.000941774091273 0.000575586708740 0.000161766936556 0.000004975823204 -0.000018529601738 0.000000000000000 ;
     0.006063952022848 0.004792079473093 0.002896721751610 0.000847872206023 0.000095521333192 -0.000065499185522 0.000000000000000 ;
     0.021911136547055 0.017530947508662 0.011003544179549 0.003604123111097 0.000610867358453 -0.000102373723312 0.000000000000000 ;
     0.048097514289147 0.038825667288338 0.025008664312070 0.008699362901571 0.001660783087548 -0.000062411582992 0.000000000000000 ;
     0.065991409251077 0.053410725564804 0.034662859694977 0.012266005223204 0.002413808501578 -0.000012142111683 0.000000000000000 ;
     0.059466077300274 0.048075011298103 0.031099926092194 0.010927340843847 0.002127672167805 -0.000035872701107 0.000000000000000 ;
     0.034939456770378 0.028087550833570 0.017876769237010 0.006059535556261 0.001107224807757 -0.000096188127840 0.000000000000000 ;
     0.012990376053434 0.010358942123603 0.006437551872323 0.002040840871387 0.000306170178644 -0.000090409737737 0.000000000000000 ;
     0.002742361036810 0.002154859155376 0.001279357732237 0.000336065260155 0.000006864427447 -0.000043145120255 0.000000000000000 ;
     0.000085194697679 0.000037284152813 -0.000034112640183 -0.000066937337075 -0.000036413565849 -0.000013525529009 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000007905643579 -0.000021115226696 -0.000040800285049 -0.000041082920313 -0.000020198164094 -0.000006443586969 0.000000000000000 ;
     0.001190246857377 0.000944177462698 0.000577482287686 0.000162628956792 0.000004948151394 -0.000018673714637 0.000000000000000 ;
     0.006064683830665 0.004796513510382 0.002906672889819 0.000856784015742 0.000097640646930 -0.000065289103803 0.000000000000000 ;
     0.021779658231482 0.017437062587922 0.010965681327362 0.003610543817903 0.000615917073798 -0.000100850848694 0.000000000000000 ;
     0.047653865932901 0.038488880597678 0.024831123988538 0.008675590820910 0.001666293355710 -0.000059137629490 0.000000000000000 ;
     0.065311059302794 0.052888137798037 0.034375370774356 0.012215246806047 0.002418340977510 -0.000007862360577 0.000000000000000 ;
     0.058875231143935 0.047623083322191 0.030855015435728 0.010887620401134 0.002132693576929 -0.000031939669116 0.000000000000000 ;
     0.034663747050635 0.027882515191371 0.017777052841308 0.006054209471860 0.001112936159254 -0.000093733670425 0.000000000000000 ;
     0.012941567019694 0.010326972805126 0.006430677272933 0.002049963048537 0.000309767028954 -0.000089642850351 0.000000000000000 ;
     0.002748456068036 0.002161062305228 0.001285722001591 0.000340014563051 0.000007500832966 -0.000043257964273 0.000000000000000 ;
     0.000090161587657 0.000041363354758 -0.000031356280190 -0.000066110575290 -0.000036536359196 -0.000013656452798 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000006542752242 -0.000020025826079 -0.000040118443150 -0.000040956740054 -0.000020295444053 -0.000006502076568 0.000000000000000 ;
     0.001192946673380 0.000946550669679 0.000579368778500 0.000163502241925 0.000004936147000 -0.000018810504411 0.000000000000000 ;
     0.006064934986008 0.004800424151476 0.002916036934698 0.000865342359779 0.000099730941280 -0.000065067208264 0.000000000000000 ;
     0.021652499099546 0.017346108068330 0.010928679298193 0.003616465576085 0.000620825134390 -0.000099341272641 0.000000000000000 ;
     0.047227688771294 0.038165100470727 0.024659936989200 0.008652224124891 0.001671580794710 -0.000055928515924 0.000000000000000 ;
     0.064658526453339 0.052386570796868 0.034098774652766 0.012165814486830 0.002422636790404 -0.000003681405654 0.000000000000000 ;
     0.058308211430778 0.047189063381656 0.030619193141683 0.010848828198107 0.002137480217149 -0.000028092961671 0.000000000000000 ;
     0.034398199511572 0.027684828234571 0.017680492431033 0.006048672172302 0.001118454704066 -0.000091317800388 0.000000000000000 ;
     0.012893902360720 0.010295620409170 0.006423633581235 0.002058615311869 0.000313283940711 -0.000088872012005 0.000000000000000 ;
     0.002754231958794 0.002166981230692 0.001291854078864 0.000343867296533 0.000008149695812 -0.000043356799531 0.000000000000000 ;
     0.000095004236006 0.000045347718563 -0.000028650940953 -0.000065282210662 -0.000036644958037 -0.000013782063112 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000005195902936 -0.000018947498994 -0.000039440270676 -0.000040826217555 -0.000020388467935 -0.000006559222456 0.000000000000000 ;
     0.001195601117073 0.000948892099711 0.000581243752314 0.000164384589337 0.000004938680965 -0.000018940332890 0.000000000000000 ;
     0.006064753365157 0.004803857976900 0.002924858535818 0.000873569527107 0.000101792073049 -0.000064834697744 0.000000000000000 ;
     0.021529407493159 0.017257920224751 0.010892505405509 0.003621929483701 0.000625597616656 -0.000097845685461 0.000000000000000 ;
     0.046817818521406 0.037853471059156 0.024494707098166 0.008629256518726 0.001676658343149 -0.000052782563159 0.000000000000000 ;
     0.064031911354797 0.051904604201807 0.033832364764253 0.012117647681743 0.002426711439998 0.000000404221311 0.000000000000000 ;
     0.057763406884184 0.046771754094449 0.030391878618006 0.010810928326415 0.002142046749062 -0.000024329798142 0.000000000000000 ;
     0.034142169466575 0.027494032916411 0.017586910582291 0.006042953392594 0.001123790296355 -0.000088940142857 0.000000000000000 ;
     0.012847337817663 0.010264869524581 0.006416448375210 0.002066831585328 0.000316723359306 -0.000088098465384 0.000000000000000 ;
     0.002759710000771 0.002172633823657 0.001297766789531 0.000347627066767 0.000008809164799 -0.000043442614645 0.000000000000000 ;
     0.000099727548485 0.000049240634958 -0.000025995489452 -0.000064453343078 -0.000036740350594 -0.000013902613564 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000003864953324 -0.000017880213964 -0.000038765901353 -0.000040691613992 -0.000020477373931 -0.000006615052378 0.000000000000000 ;
     0.001198209554489 0.000951200572572 0.000583105214872 0.000165274070751 0.000004954710420 -0.000019063544020 0.000000000000000 ;
     0.006064181582012 0.004806856681578 0.002933178018641 0.000881485907126 0.000103824031461 -0.000064592657542 0.000000000000000 ;
     0.021410152577169 0.017172348398576 0.010857128470620 0.003626972478241 0.000630240296627 -0.000096364640975 0.000000000000000 ;
     0.046423198201909 0.037553214674353 0.024335072831739 0.008606681033512 0.001681537980533 -0.000049698094825 0.000000000000000 ;
     0.063429492869275 0.051440949924007 0.033575498354169 0.012070689624243 0.002430579159914 0.000004397860337 0.000000000000000 ;
     0.057239356338136 0.046370068722496 0.030172543103047 0.010773886564648 0.002146406680800 -0.000020647476230 0.000000000000000 ;
     0.033895069421911 0.027309712131686 0.017496144104636 0.006037079241243 0.001128952157023 -0.000086600242540 0.000000000000000 ;
     0.012801831223951 0.010234704606078 0.006409145780904 0.002074642613620 0.000320087697419 -0.000087323305604 0.000000000000000 ;
     0.002764909713414 0.002178036549734 0.001303472048340 0.000351297342077 0.000009477592330 -0.000043516321274 0.000000000000000 ;
     0.000104336201663 0.000053045366923 -0.000023388769253 -0.000063624934806 -0.000036823448670 -0.000014018344964 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000002549746590 -0.000016823926870 -0.000038095459002 -0.000040553184672 -0.000020562301215 -0.000006669595245 0.000000000000000 ;
     0.001200771697830 0.000953475261706 0.000584951536751 0.000166168995892 0.000004983271730 -0.000019180464226 0.000000000000000 ;
     0.006063257657616 0.004809457679079 0.002941031891470 0.000889110190364 0.000105826913729 -0.000064342071072 0.000000000000000 ;
     0.021294522142442 0.017089253663277 0.010822518773503 0.003631627840227 0.000634758659218 -0.000094898576051 0.000000000000000 ;
     0.046042865719513 0.037263622809044 0.024180703579170 0.008584490207460 0.001686230809569 -0.000046673447983 0.000000000000000 ;
     0.062849707152300 0.050994436710953 0.033327589214626 0.012024887075535 0.002434253038658 0.000008302723196 0.000000000000000 ;
     0.056734731214991 0.045983018337858 0.029960703818392 0.010737670320248 0.002150572473542 -0.000017043376330 0.000000000000000 ;
     0.033656362659984 0.027131484288947 0.017408042577221 0.006031072686820 0.001133948917034 -0.000084297580297 0.000000000000000 ;
     0.012757342428406 0.010205110115639 0.006401746939073 0.002082076325555 0.000323379321942 -0.000086547497648 0.000000000000000 ;
     0.002769849017039 0.002183204581622 0.001308980933469 0.000354881451437 0.000010153510535 -0.000043578760585 0.000000000000000 ;
     0.000108834650577 0.000056765049518 -0.000020829612337 -0.000062797827293 -0.000036895094062 -0.000014129485698 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     -0.000001250113307 -0.000015778581764 -0.000037429056787 -0.000040411177258 -0.000020643388546 -0.000006722880755 0.000000000000000 ;
     0.001203287536870 0.000955715629888 0.000586781395390 0.000167067881475 0.000005023474054 -0.000019291402927 0.000000000000000 ;
     0.006062015592389 0.004811694619810 0.002948453283116 0.000896459544189 0.000107800904839 -0.000064083830233 0.000000000000000 ;
     0.021182320687490 0.017008507654150 0.010788647997385 0.003635925626164 0.000639157909236 -0.000093447827327 0.000000000000000 ;
     0.045675943163205 0.036984048387041 0.024031296256728 0.008562676231640 0.001690747131082 -0.000043706981429 0.000000000000000 ;
     0.062291129649218 0.050563996851458 0.033088101406287 0.011980190058592 0.002437745127899 0.000012121894712 0.000000000000000 ;
     0.056248320432907 0.045609700759344 0.029755918909817 0.010702248565024 0.002154555636586 -0.000013514964130 0.000000000000000 ;
     0.033425557683302 0.026958999470807 0.017322467066803 0.006024953971398 0.001138788658607 -0.000082031586958 0.000000000000000 ;
     0.012713833211966 0.010176070631859 0.006394270401620 0.002089158148799 0.000326600544492 -0.000085771891609 0.000000000000000 ;
     0.002774544387163 0.002188151918805 0.001314303754587 0.000358382585070 0.000010835610479 -0.000043630709192 0.000000000000000 ;
     0.000113227137237 0.000060402691175 -0.000018316848566 -0.000061972755783 -0.000036956064440 -0.000014236252174 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ]
   )
const expected_zero = 
expected_data(
    # Expected vpa
    [-4.242640687119286, -3.535533905932738, -2.828427124746191, -2.121320343559643, -1.414213562373095, -0.707106781186548, 0.000000000000000, 0.707106781186547, 1.414213562373095, 2.121320343559643, 2.828427124746191, 3.535533905932738, 4.242640687119286],
    # Expected vperp
    [0.219275263435463, 0.912095586463014, 1.414213562373095, 2.121320343559643, 2.828427124746190, 3.535533905932738, 4.242640687119286],
    # Expected phi
    [0.405465042760944, 0.405465042760917, 0.405465042760889, 0.405465042760862, 0.405465042760835, 0.405465042760807, 0.405465042760780, 0.405465042760752, 0.405465042760728, 0.405465042760710, 0.405465042760708],
    # Expected n_ion
    [1.499999901979173, 1.499999901979132, 1.499999901979090, 1.499999901979049, 1.499999901979010, 1.499999901978968, 1.499999901978927, 1.499999901978884, 1.499999901978848, 1.499999901978821, 1.499999901978819],
    # Expected upar_ion
    [0.179871043200945, 0.179871043200944, 0.179871043200943, 0.179871043200942, 0.179871043200941, 0.179871043200940, 0.179871043200938, 0.179871043200937, 0.179871043200938, 0.179871043200934, 0.179871043200917],
    # Expected ppar_ion
    [0.461231059346418, 1.591196434165690, 1.591190974913002, 1.591217377312417, 1.591218533005709, 1.591218590583650, 1.591218594054851, 1.591218594285332, 1.591218594301175, 1.591218594302264, 1.591218594302361],
    # Expected pperp_ion
    [2.157962713015878, 1.592980025606181, 1.592982755232462, 1.592969554032695, 1.592968976185989, 1.592968947396958, 1.592968945661297, 1.592968945545994, 1.592968945538014, 1.592968945537442, 1.592968945537425],
    # Expected qpar_ion
    [-0.039956799314801, -0.011496144716002, -0.008707029232013, -0.008697672785525, -0.008701578683712, -0.008701958159737, -0.008701987210495, -0.008701989305132, -0.008701989453450, -0.008701989463891, -0.008701989464613],
    # Expected v_t_ion
    [1.457113859282121, 1.457113859282122, 1.457113859282123, 1.457113859282125, 1.457113859282126, 1.457113859282128, 1.457113859282129, 1.457113859282131, 1.457113859282131, 1.457113859282135, 1.457113859282146],
    # Expected dSdt_ion
    [0.000000000000000, 0.000345775193998, 0.000000629323971, -0.000000061178917, -0.000000005619264, -0.000000000420729, -0.000000000030121, -0.000000000002129, -0.000000000000150, -0.000000000000011, 0.000000000000000],
    # Expected maxnorm_ion
    [0.077929351381074, 0.010280168429650, 0.010100597542494, 0.010096420275231, 0.010096305070219, 0.010096300995955, 0.010096300801391, 0.010096300789820, 0.010096300789055, 0.010096300789002, 0.010096300788998],
    # Expected L2norm_ion
    [0.008692015265392, 0.000740512854218, 0.000726791056159, 0.000726464131967, 0.000726454179413, 0.000726453772698, 0.000726453750796, 0.000726453749410, 0.000726453749316, 0.000726453749309, 0.000726453749309],
    # Expected f_ion
    [0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000000000000012 0.000000000000126 0.000000000000209 0.000000000000077 0.000000000000004 0.000000000000000 0.000000000000000 ;
     0.000000000145518 0.000000001528140 0.000000002530195 0.000000000930807 0.000000000046342 0.000000000000312 0.000000000000000 ;
     0.000000238064383 0.000002500013243 0.000004139359032 0.000001522785088 0.000000075815005 0.000000000510837 0.000000000000000 ;
     0.000052708981932 0.000553518972694 0.000916480648693 0.000337154388886 0.000016785928610 0.000000113102697 0.000000000000000 ;
     0.001579377208004 0.016585697875925 0.027461517848945 0.010102527839989 0.000502975244258 0.000003389020538 0.000000000000000 ;
     0.006404690401533 0.067258321476549 0.111361946270545 0.040967770561772 0.002039665193838 0.000013743155972 0.000000000000000 ;
     0.003514968617941 0.036912149450483 0.061116731931353 0.022483589189131 0.001119391992114 0.000007542403914 0.000000000000000 ;
     0.000261069296566 0.002741597419270 0.004539358369308 0.001669936620178 0.000083141248679 0.000000560201327 0.000000000000000 ;
     0.000002624225687 0.000027558086936 0.000045628884714 0.000016785928610 0.000000835722175 0.000000005631052 0.000000000000000 ;
     0.000000003569913 0.000000037489141 0.000000062072076 0.000000022835041 0.000000001136890 0.000000000007660 0.000000000000000 ;
     0.000000000000657 0.000000000006902 0.000000000011428 0.000000000004204 0.000000000000209 0.000000000000001 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000033546553318 -0.000019540363252 -0.000065354650267 -0.000080639749029 -0.000051353361339 -0.000018911873948 0.000000000000000 ;
     0.001759210960254 0.001251283603215 0.000719352851163 0.000175283021071 -0.000036574343713 -0.000049793008480 0.000000000000000 ;
     0.007792374153113 0.005555125721848 0.003265398660485 0.001036179341220 0.000134129912206 -0.000098814387906 0.000000000000000 ;
     0.025477820463187 0.018320580996237 0.010939423454763 0.003701971506114 0.000757621480448 -0.000106294788076 0.000000000000000 ;
     0.054040794650216 0.039149842831208 0.023683810865468 0.008233364177580 0.001840320283538 -0.000023919613065 0.000000000000000 ;
     0.073556306482686 0.053368333322953 0.032377102361261 0.011322650578295 0.002576647667577 0.000048852670201 0.000000000000000 ;
     0.066508407843059 0.048201092502046 0.029185205163769 0.010168682898597 0.002298805159719 0.000015471893271 0.000000000000000 ;
     0.039854557890926 0.028746264181724 0.017261165827911 0.005918972324855 0.001279699747243 -0.000081695761891 0.000000000000000 ;
     0.015663289415841 0.011241136706211 0.006686749529432 0.002212202507169 0.000390122233619 -0.000115594245117 0.000000000000000 ;
     0.003773558717369 0.002663484836748 0.001522065723849 0.000407855277353 -0.000016660255093 -0.000080431883435 0.000000000000000 ;
     0.000270744695765 0.000124847908620 -0.000007651285338 -0.000088689432607 -0.000070525764146 -0.000031745647473 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000033668302978 -0.000019013302049 -0.000064460017977 -0.000079636780050 -0.000050763327738 -0.000018756745619 0.000000000000000 ;
     0.001754635898987 0.001248170976230 0.000718062174397 0.000176187993895 -0.000035083672841 -0.000049090441345 0.000000000000000 ;
     0.007777033276974 0.005540107947018 0.003252979214628 0.001031322591665 0.000135412584498 -0.000097351950500 0.000000000000000 ;
     0.025497600255277 0.018321000398536 0.010926067792719 0.003689549478731 0.000756826842367 -0.000104513123721 0.000000000000000 ;
     0.054159530362743 0.039208452771129 0.023691713884666 0.008217398546904 0.001836554612631 -0.000022323366715 0.000000000000000 ;
     0.073735877369839 0.053462461352166 0.032397870240950 0.011304617658998 0.002571145405537 0.000050449951396 0.000000000000000 ;
     0.066629661206591 0.048256975759444 0.029187106353197 0.010147952129573 0.002294240727512 0.000017701100357 0.000000000000000 ;
     0.039865624162154 0.028735528486239 0.017236552901693 0.005900384618659 0.001278796737611 -0.000078541016469 0.000000000000000 ;
     0.015631547489359 0.011212413290386 0.006664688391791 0.002204540654834 0.000393232279714 -0.000112276772940 0.000000000000000 ;
     0.003761448923643 0.002655603067655 0.001519171786594 0.000410742095932 -0.000012167746970 -0.000078156061545 0.000000000000000 ;
     0.000271664906268 0.000126897030541 -0.000004549785052 -0.000085189889740 -0.000068171842810 -0.000030935948102 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000033732331630 -0.000018944714413 -0.000064389512715 -0.000079576360434 -0.000050727812499 -0.000018745669272 0.000000000000000 ;
     0.001754587814527 0.001248156497740 0.000718087903831 0.000176256995382 -0.000035014775268 -0.000049059513906 0.000000000000000 ;
     0.007776631820676 0.005539736293221 0.003252688500586 0.001031222482727 0.000135456896538 -0.000097308680014 0.000000000000000 ;
     0.025497851917528 0.018320862950290 0.010925669419164 0.003689223554604 0.000756788294419 -0.000104479406412 0.000000000000000 ;
     0.054162054386690 0.039209639846444 0.023691781397342 0.008216963463985 0.001836420819969 -0.000022313108705 0.000000000000000 ;
     0.073740054637099 0.053464641279452 0.032398330303454 0.011304157388384 0.002570966589785 0.000050450067718 0.000000000000000 ;
     0.066632790592186 0.048258488816994 0.029187261818238 0.010147475919283 0.002294095350377 0.000017717727637 0.000000000000000 ;
     0.039866277179551 0.028735557605557 0.017236135864928 0.005899980839273 0.001278750348004 -0.000078493583915 0.000000000000000 ;
     0.015631060420549 0.011211922921677 0.006664274866610 0.002204380475996 0.000393288365706 -0.000112214843109 0.000000000000000 ;
     0.003761255726509 0.002655481003429 0.001519136585687 0.000410810894879 -0.000012072746633 -0.000078109638962 0.000000000000000 ;
     0.000271706855733 0.000126957853333 -0.000004472167005 -0.000085110259021 -0.000068120283977 -0.000030918656766 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000033737247140 -0.000018940005552 -0.000064385226917 -0.000079573230865 -0.000050726205999 -0.000018745221658 0.000000000000000 ;
     0.001754588995331 0.001248159010658 0.000718091734501 0.000176261540079 -0.000035011363287 -0.000049058163869 0.000000000000000 ;
     0.007776611898949 0.005539720974659 0.003252679107268 0.001031221302598 0.000135459895113 -0.000097306609790 0.000000000000000 ;
     0.025497830779170 0.018320839855467 0.010925648099441 0.003689212710426 0.000756788138630 -0.000104477613633 0.000000000000000 ;
     0.054162093313308 0.039209650049436 0.023691769462244 0.008216946985133 0.001836416731963 -0.000022312441970 0.000000000000000 ;
     0.073740169842109 0.053464699405575 0.032398339720628 0.011304141977169 0.002570960640377 0.000050449835104 0.000000000000000 ;
     0.066632913341262 0.048258553990622 0.029187277078303 0.010147463686491 0.002294090286312 0.000017717454606 0.000000000000000 ;
     0.039866336676190 0.028735585611242 0.017236137609034 0.005899971155303 0.001278747784462 -0.000078493262704 0.000000000000000 ;
     0.015631066880777 0.011211921742591 0.006664268504090 0.002204375243145 0.000393288264680 -0.000112214039982 0.000000000000000 ;
     0.003761251733150 0.002655477307911 0.001519133867072 0.000410810530375 -0.000012071547087 -0.000078108882709 0.000000000000000 ;
     0.000271705725169 0.000126957318356 -0.000004472010503 -0.000085109395889 -0.000068119457696 -0.000030918332684 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000033737591786 -0.000018939685137 -0.000064384946417 -0.000079573038897 -0.000050726114294 -0.000018745197948 0.000000000000000 ;
     0.001754589157720 0.001248159249055 0.000718092037674 0.000176261847910 -0.000035011157062 -0.000049058087716 0.000000000000000 ;
     0.007776610639546 0.005539720108281 0.003252678676589 0.001031221347044 0.000135460104346 -0.000097306484892 0.000000000000000 ;
     0.025497828353985 0.018320837885477 0.010925646729156 0.003689212219472 0.000756788191578 -0.000104477496376 0.000000000000000 ;
     0.054162092878736 0.039209649085192 0.023691768236433 0.008216946153008 0.001836416577251 -0.000022312388608 0.000000000000000 ;
     0.073740173916370 0.053464701351310 0.032398339876264 0.011304141292590 0.002570960387561 0.000050449822537 0.000000000000000 ;
     0.066632919808573 0.048258557667841 0.029187278267937 0.010147463321222 0.002294090059761 0.000017717410336 0.000000000000000 ;
     0.039866341177559 0.028735588172428 0.017236138435498 0.005899970899719 0.001278747625409 -0.000078493304372 0.000000000000000 ;
     0.015631068228638 0.011211922388971 0.006664268551826 0.002204375002890 0.000393288165212 -0.000112214062730 0.000000000000000 ;
     0.003761251632390 0.002655477128279 0.001519133648258 0.000410810376627 -0.000012071589250 -0.000078108886119 0.000000000000000 ;
     0.000271705532199 0.000126957155052 -0.000004472131188 -0.000085109447541 -0.000068119464153 -0.000030918330032 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000033737615921 -0.000018939662913 -0.000064384927215 -0.000079573026063 -0.000050726108338 -0.000018745196459 0.000000000000000 ;
     0.001754589170816 0.001248159267115 0.000718092059680 0.000176261869244 -0.000035011143346 -0.000049058082792 0.000000000000000 ;
     0.007776610554091 0.005539720052067 0.003252678651473 0.001031221353040 0.000135460119010 -0.000097306476582 0.000000000000000 ;
     0.025497828162011 0.018320837739045 0.010925646635740 0.003689212191159 0.000756788196775 -0.000104477488322 0.000000000000000 ;
     0.054162092775860 0.039209648979087 0.023691768141501 0.008216946102029 0.001836416569458 -0.000022312384681 0.000000000000000 ;
     0.073740174110932 0.053464701439280 0.032398339875726 0.011304141253664 0.002570960373640 0.000050449821779 0.000000000000000 ;
     0.066632920213707 0.048258557905617 0.029187278354232 0.010147463306900 0.002294090046854 0.000017717406687 0.000000000000000 ;
     0.039866341500986 0.028735588365807 0.017236138509574 0.005899970891464 0.001278747614744 -0.000078493308745 0.000000000000000 ;
     0.015631068343526 0.011211922450867 0.006664268566371 0.002204374988887 0.000393288156118 -0.000112214066128 0.000000000000000 ;
     0.003761251629254 0.002655477117360 0.001519133632166 0.000410810362868 -0.000012071595104 -0.000078108887647 0.000000000000000 ;
     0.000271705515973 0.000126957140650 -0.000004472142712 -0.000085109453750 -0.000068119466082 -0.000030918330305 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000033737617614 -0.000018939661359 -0.000064384925879 -0.000079573025177 -0.000050726107931 -0.000018745196358 0.000000000000000 ;
     0.001754589171774 0.001248159268413 0.000718092061241 0.000176261870735 -0.000035011142400 -0.000049058082456 0.000000000000000 ;
     0.007776610548158 0.005539720048225 0.003252678649826 0.001031221353526 0.000135460120039 -0.000097306476009 0.000000000000000 ;
     0.025497828148036 0.018320837728578 0.010925646629245 0.003689212189311 0.000756788197174 -0.000104477487761 0.000000000000000 ;
     0.054162092766982 0.039209648970759 0.023691768134632 0.008216946098619 0.001836416568981 -0.000022312384401 0.000000000000000 ;
     0.073740174122501 0.053464701444344 0.032398339875425 0.011304141251140 0.002570960372750 0.000050449821729 0.000000000000000 ;
     0.066632920241032 0.048258557921844 0.029187278360354 0.010147463306153 0.002294090046016 0.000017717406418 0.000000000000000 ;
     0.039866341523861 0.028735588379693 0.017236138515141 0.005899970891105 0.001278747614007 -0.000078493309085 0.000000000000000 ;
     0.015631068352054 0.011211922455589 0.006664268567648 0.002204374987969 0.000393288155432 -0.000112214066407 0.000000000000000 ;
     0.003761251629123 0.002655477116632 0.001519133631019 0.000410810361834 -0.000012071595581 -0.000078108887784 0.000000000000000 ;
     0.000271705514773 0.000126957139571 -0.000004472143591 -0.000085109454245 -0.000068119466252 -0.000030918330334 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000033737617733 -0.000018939661250 -0.000064384925785 -0.000079573025115 -0.000050726107903 -0.000018745196351 0.000000000000000 ;
     0.001754589171842 0.001248159268504 0.000718092061351 0.000176261870840 -0.000035011142334 -0.000049058082433 0.000000000000000 ;
     0.007776610547743 0.005539720047957 0.003252678649713 0.001031221353562 0.000135460120111 -0.000097306475969 0.000000000000000 ;
     0.025497828147043 0.018320837727838 0.010925646628790 0.003689212189185 0.000756788197203 -0.000104477487721 0.000000000000000 ;
     0.054162092766320 0.039209648970154 0.023691768134145 0.008216946098384 0.001836416568949 -0.000022312384381 0.000000000000000 ;
     0.073740174123263 0.053464701444673 0.032398339875397 0.011304141250967 0.002570960372690 0.000050449821725 0.000000000000000 ;
     0.066632920242923 0.048258557922972 0.029187278360785 0.010147463306106 0.002294090045959 0.000017717406399 0.000000000000000 ;
     0.039866341525470 0.028735588380674 0.017236138515540 0.005899970891085 0.001278747613956 -0.000078493309110 0.000000000000000 ;
     0.015631068352662 0.011211922455929 0.006664268567743 0.002204374987906 0.000393288155382 -0.000112214066428 0.000000000000000 ;
     0.003761251629116 0.002655477116582 0.001519133630938 0.000410810361759 -0.000012071595616 -0.000078108887794 0.000000000000000 ;
     0.000271705514687 0.000126957139494 -0.000004472143654 -0.000085109454281 -0.000068119466264 -0.000030918330337 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000033737617741 -0.000018939661243 -0.000064384925778 -0.000079573025110 -0.000050726107901 -0.000018745196351 0.000000000000000 ;
     0.001754589171847 0.001248159268511 0.000718092061359 0.000176261870847 -0.000035011142329 -0.000049058082431 0.000000000000000 ;
     0.007776610547714 0.005539720047938 0.003252678649705 0.001031221353564 0.000135460120116 -0.000097306475966 0.000000000000000 ;
     0.025497828146972 0.018320837727786 0.010925646628758 0.003689212189176 0.000756788197205 -0.000104477487719 0.000000000000000 ;
     0.054162092766272 0.039209648970110 0.023691768134110 0.008216946098367 0.001836416568947 -0.000022312384380 0.000000000000000 ;
     0.073740174123314 0.053464701444694 0.032398339875395 0.011304141250955 0.002570960372686 0.000050449821725 0.000000000000000 ;
     0.066632920243054 0.048258557923050 0.029187278360814 0.010147463306103 0.002294090045955 0.000017717406398 0.000000000000000 ;
     0.039866341525582 0.028735588380742 0.017236138515567 0.005899970891084 0.001278747613952 -0.000078493309112 0.000000000000000 ;
     0.015631068352705 0.011211922455952 0.006664268567750 0.002204374987902 0.000393288155379 -0.000112214066429 0.000000000000000 ;
     0.003761251629115 0.002655477116578 0.001519133630933 0.000410810361754 -0.000012071595619 -0.000078108887795 0.000000000000000 ;
     0.000271705514681 0.000126957139489 -0.000004472143659 -0.000085109454283 -0.000068119466265 -0.000030918330337 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000033737617742 -0.000018939661242 -0.000064384925778 -0.000079573025110 -0.000050726107900 -0.000018745196351 0.000000000000000 ;
     0.001754589171847 0.001248159268511 0.000718092061359 0.000176261870848 -0.000035011142329 -0.000049058082431 0.000000000000000 ;
     0.007776610547712 0.005539720047937 0.003252678649704 0.001031221353564 0.000135460120116 -0.000097306475966 0.000000000000000 ;
     0.025497828146968 0.018320837727783 0.010925646628756 0.003689212189176 0.000756788197205 -0.000104477487718 0.000000000000000 ;
     0.054162092766268 0.039209648970107 0.023691768134108 0.008216946098366 0.001836416568947 -0.000022312384380 0.000000000000000 ;
     0.073740174123316 0.053464701444695 0.032398339875394 0.011304141250954 0.002570960372685 0.000050449821725 0.000000000000000 ;
     0.066632920243061 0.048258557923054 0.029187278360816 0.010147463306102 0.002294090045955 0.000017717406398 0.000000000000000 ;
     0.039866341525588 0.028735588380746 0.017236138515569 0.005899970891084 0.001278747613952 -0.000078493309112 0.000000000000000 ;
     0.015631068352708 0.011211922455954 0.006664268567750 0.002204374987901 0.000393288155379 -0.000112214066430 0.000000000000000 ;
     0.003761251629115 0.002655477116578 0.001519133630932 0.000410810361754 -0.000012071595619 -0.000078108887795 0.000000000000000 ;
     0.000271705514680 0.000126957139488 -0.000004472143659 -0.000085109454284 -0.000068119466265 -0.000030918330337 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ]
   )

const expected_none_bc = 
expected_data(
    # Expected vpa
    [-4.242640687119286, -3.535533905932738, -2.828427124746191, -2.121320343559643, -1.414213562373095, -0.707106781186548, 0.000000000000000, 0.707106781186547, 1.414213562373095, 2.121320343559643, 2.828427124746191, 3.535533905932738, 4.242640687119286],
    # Expected vperp
    [0.219275263435463, 0.912095586463014, 1.414213562373095, 2.121320343559643, 2.828427124746190, 3.535533905932738, 4.242640687119286],
    # Expected phi
    [0.405465108108165, 0.405465108108137, 0.405465108108110, 0.405465108108083, 0.405465108108055, 0.405465108108027, 0.405465108107999, 0.405465108107980, 0.405465108107981, 0.405465108107981, 0.405465108107981],
    # Expected n_ion
    [1.500000000000001, 1.499999999999960, 1.499999999999918, 1.499999999999878, 1.499999999999836, 1.499999999999794, 1.499999999999752, 1.499999999999723, 1.499999999999725, 1.499999999999725, 1.499999999999725],
    # Expected upar_ion
    [0.179871043200947, 0.179871043200946, 0.179871043200947, 0.179871043200948, 0.179871043200948, 0.179871043200948, 0.179871043200947, 0.179871043200946, 0.179871043200932, 0.179871043200932, 0.179871043200932],
    # Expected ppar_ion
    [0.461231089486599, 1.570842430267398, 1.571157145242388, 1.571164691224376, 1.571164864559949, 1.571164867742876, 1.571164867791245, 1.571164867791786, 1.571164867791799, 1.571164867791799, 1.571164867791799],
    # Expected pperp_ion
    [2.157963595203321, 1.603157924812859, 1.603000567325300, 1.602996794334243, 1.602996707666392, 1.602996706074864, 1.602996706050612, 1.602996706050299, 1.602996706050312, 1.602996706050312, 1.602996706050312],
    # Expected qpar_ion
    [-0.039956801925844, -0.004778266787512, -0.005432892272772, -0.005474626626412, -0.005476033146850, -0.005476067364197, -0.005476068040333, -0.005476068051528, -0.005476068051668, -0.005476068051668, -0.005476068051668],
    # Expected v_t_ion
    [1.457114085351702, 1.457114085351703, 1.457114085351704, 1.457114085351704, 1.457114085351705, 1.457114085351706, 1.457114085351705, 1.457114085351706, 1.457114085351711, 1.457114085351711, 1.457114085351711],
    # Expected dSdt_ion
    [0.000000000000000, 0.000119015854264, 0.000001436392989, 0.000000037600272, 0.000000000875588, 0.000000000017381, 0.000000000000296, 0.000000000000005, 0.000000000000000, 0.000000000000000, 0.000000000000000],
    # Expected maxnorm_ion
    [0.077929354827167, 0.001072646567974, 0.001099157297017, 0.001099500249991, 0.001099502466891, 0.001099502425629, 0.001099502423602, 0.001099502423550, 0.001099502423549, 0.001099502423549, 0.001099502423549],
    # Expected L2norm_ion
    [0.008692014339046, 0.000158478494058, 0.000164120823382, 0.000164230996822, 0.000164232985544, 0.000164233017150, 0.000164233017567, 0.000164233017571, 0.000164233017571, 0.000164233017571, 0.000164233017571],
    # Expected f_ion
    [0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;
     0.000000000000012 0.000000000000126 0.000000000000209 0.000000000000077 0.000000000000004 0.000000000000000 0.000000000000000 ;
     0.000000000145518 0.000000001528140 0.000000002530195 0.000000000930807 0.000000000046342 0.000000000000312 0.000000000000000 ;
     0.000000238064383 0.000002500013243 0.000004139359032 0.000001522785088 0.000000075815005 0.000000000510837 0.000000000000466 ;
     0.000052708981932 0.000553518972694 0.000916480648693 0.000337154388886 0.000016785928610 0.000000113102697 0.000000000103136 ;
     0.001579377208004 0.016585697875925 0.027461517848945 0.010102527839989 0.000502975244258 0.000003389020538 0.000000003090387 ;
     0.006404690401533 0.067258321476549 0.111361946270545 0.040967770561772 0.002039665193838 0.000013743155972 0.000000012532136 ;
     0.003514968617941 0.036912149450483 0.061116731931353 0.022483589189131 0.001119391992114 0.000007542403914 0.000000006877782 ;
     0.000261069296566 0.002741597419270 0.004539358369308 0.001669936620178 0.000083141248679 0.000000560201327 0.000000000510837 ;
     0.000002624225687 0.000027558086936 0.000045628884714 0.000016785928610 0.000000835722175 0.000000005631052 0.000000000005135 ;
     0.000000003569913 0.000000037489141 0.000000062072076 0.000000022835041 0.000000001136890 0.000000000007660 0.000000000000007 ;
     0.000000000000657 0.000000000006902 0.000000000011428 0.000000000004204 0.000000000000209 0.000000000000001 0.000000000000000 ;
     0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 0.000000000000000 ;;;
     0.000105548762600 0.000088095378364 0.000067984658058 0.000036675151883 0.000013823619343 0.000003531287336 0.000000147442695 ;
     0.000079841755644 0.000046065804118 0.000016612601236 0.000002620288004 0.000006247879524 0.000005246363811 0.000002772141897 ;
     0.001481860432352 0.001061287895210 0.000631879818887 0.000210499665934 0.000049183309447 0.000011628295613 0.000013038743598 ;
     0.006582334486904 0.004509250617297 0.002488101609699 0.000738627496382 0.000176007818087 0.000006967649353 0.000042375030867 ;
     0.025523007272222 0.017658714028007 0.009870366889929 0.002946553564809 0.000664098864523 0.000019331968178 0.000090203588912 ;
     0.059645815631082 0.041697618196297 0.023738277948296 0.007267124238949 0.001579198264043 0.000086930441632 0.000137940325957 ;
     0.083760114064621 0.058681874607475 0.033549186108371 0.010341480916868 0.002224154817222 0.000144933153883 0.000164826620156 ;
     0.074573797258836 0.052182609508191 0.029768190951210 0.009149168604576 0.001981999375248 0.000122029942827 0.000155913862746 ;
     0.041741471556569 0.029033976483133 0.016390040099043 0.004974816297731 0.001108597783649 0.000048449823978 0.000116586978357 ;
     0.014476531232876 0.010028061861516 0.005628406170031 0.001703571692594 0.000389838791440 0.000012541645539 0.000064200594093 ;
     0.003103843299781 0.002161066513267 0.001224446576648 0.000374401721485 0.000083807919462 0.000010074180653 0.000025232682413 ;
     0.000264893205156 0.000166519514244 0.000078183218817 0.000019920334827 0.000012484230173 0.000008246274879 0.000006761190841 ;
     0.000207217630393 0.000165457227800 0.000118120809573 0.000056791133215 0.000020884842692 0.000005642158602 -0.000000269034707 ;;;
     0.000105981068094 0.000088425446061 0.000068207416193 0.000036791487623 0.000013910689702 0.000003634613537 0.000000244081604 ;
     0.000082237547716 0.000048294409980 0.000018543228926 0.000003882414672 0.000006824034687 0.000005454706379 0.000002874736069 ;
     0.001482329607854 0.001062463588800 0.000633736945266 0.000212606028991 0.000050608551804 0.000012191327875 0.000013120765394 ;
     0.006566363037453 0.004496466721856 0.002479815285068 0.000737001427890 0.000177761382523 0.000008171883311 0.000042491403685 ;
     0.025516251441020 0.017644743114258 0.009853746287386 0.002937433612567 0.000664547406886 0.000020919648422 0.000090410524552 ;
     0.059713852788483 0.041724128925339 0.023732775926394 0.007252633909663 0.001577268518409 0.000088395246928 0.000138246809776 ;
     0.083899051776283 0.058749690571977 0.033559018455711 0.010325657599430 0.002220807351130 0.000146182220731 0.000165178126703 ;
     0.074689621708700 0.052237104450240 0.029773257496667 0.009134000458461 0.001979211793395 0.000123324872392 0.000156246211290 ;
     0.041772011385066 0.029039872133632 0.016378499545861 0.004962783654725 0.001107847126009 0.000049925960115 0.000116851071337 ;
     0.014464243314051 0.010014590581242 0.005616418261003 0.001698590858017 0.000390930244269 0.000013872682870 0.000064333851084 ;
     0.003098849880896 0.002157674724229 0.001223049820715 0.000375385464246 0.000085429253844 0.000010857727369 0.000025244676450 ;
     0.000265978917187 0.000167948639280 0.000079873365646 0.000021471711194 0.000013352891631 0.000008493340304 0.000006783237621 ;
     0.000208050851136 0.000166175154851 0.000118681028400 0.000057074061909 0.000020940190408 0.000005666021370 -0.000000169241670 ;;;
     0.000105995596987 0.000088437527174 0.000068216453323 0.000036795834705 0.000013911286682 0.000003634646777 0.000000245602531 ;
     0.000082303382353 0.000048356137559 0.000018597537907 0.000003919332227 0.000006841301777 0.000005459109139 0.000002874986845 ;
     0.001482342673116 0.001062495135283 0.000633785911379 0.000212661759995 0.000050647908983 0.000012207610877 0.000013121846765 ;
     0.006565982817616 0.004496176409498 0.002479638842766 0.000736975084055 0.000177804374726 0.000008202706818 0.000042496050359 ;
     0.025515906065739 0.017644331782779 0.009853354654275 0.002937245392348 0.000664558131343 0.000020955416428 0.000090417722171 ;
     0.059714914964394 0.041724471878312 0.023732581425050 0.007252334699977 0.001577228633438 0.000088423968996 0.000138254438492 ;
     0.083901701034513 0.058750977985448 0.033559197698545 0.010325350615567 0.002220739996920 0.000146202614737 0.000165184919527 ;
     0.074692094862535 0.052238316942511 0.029773440988767 0.009133727390194 0.001979155221361 0.000123343448503 0.000156251900225 ;
     0.041772868726698 0.029040163096705 0.016378365956989 0.004962565633787 0.001107825998630 0.000049947303480 0.000116855751019 ;
     0.014464114016598 0.010014395478672 0.005616211130526 0.001698488075141 0.000390941425980 0.000013893125494 0.000064336348111 ;
     0.003098743216643 0.002157593838108 0.001223004317627 0.000375389074063 0.000085453129946 0.000010870643356 0.000025244477069 ;
     0.000265976729414 0.000167956333359 0.000079890584207 0.000021493654235 0.000013367104191 0.000008497058144 0.000006782328046 ;
     0.000208063749471 0.000166186836370 0.000118690768807 0.000057079364644 0.000020940816014 0.000005665162089 -0.000000168975448 ;;;
     0.000105995947375 0.000088437805790 0.000068216643288 0.000036795896596 0.000013911259743 0.000003634628032 0.000000245653405 ;
     0.000082305186287 0.000048357786336 0.000018598939951 0.000003920221961 0.000006841664213 0.000005459161784 0.000002874972799 ;
     0.001482343449271 0.001062496295708 0.000633787395705 0.000212663235194 0.000050648850871 0.000012207948686 0.000013121833730 ;
     0.006565974299762 0.004496170240451 0.002479635437664 0.000736974947457 0.000177805503127 0.000008203426392 0.000042496130434 ;
     0.025515894402638 0.017644320579060 0.009853345530848 0.002937241647023 0.000664558574072 0.000020956281613 0.000090417877095 ;
     0.059714929214019 0.041724474095211 0.023732575176173 0.007252328295206 0.001577227920596 0.000088424658683 0.000138254608917 ;
     0.083901751542042 0.058751002028171 0.033559200344722 0.010325344234236 0.002220738641242 0.000146203053448 0.000165185059124 ;
     0.074692149101451 0.052238344345056 0.029773446243880 0.009133722196965 0.001979154041215 0.000123343758964 0.000156251995467 ;
     0.041772892570491 0.029040173304431 0.016378365443052 0.004962561573962 0.001107825449778 0.000049947603681 0.000116855812537 ;
     0.014464114599812 0.010014393519101 0.005616207766647 0.001698485906881 0.000390941433291 0.000013893398088 0.000064336368216 ;
     0.003098741131516 0.002157592054266 0.001223003074449 0.000375388795396 0.000085453400260 0.000010870810160 0.000025244456814 ;
     0.000265976244245 0.000167956081227 0.000079890582846 0.000021493870035 0.000013367281823 0.000008497094554 0.000006782302173 ;
     0.000208063935595 0.000166187004664 0.000118690906987 0.000057079430399 0.000020940808745 0.000005665137712 -0.000000168973392 ;;;
     0.000105995954421 0.000088437811095 0.000068216646482 0.000036795896968 0.000013911258511 0.000003634627492 0.000000245654874 ;
     0.000082305226940 0.000048357822805 0.000018598970130 0.000003920239931 0.000006841670475 0.000005459161923 0.000002874972329 ;
     0.001482343472754 0.001062496326149 0.000633787431273 0.000212663267639 0.000050648869848 0.000012207954455 0.000013121832787 ;
     0.006565974132844 0.004496170124957 0.002479635379840 0.000736974952281 0.000177805527929 0.000008203440668 0.000042496131356 ;
     0.025515894112450 0.017644320328060 0.009853345346359 0.002937241581274 0.000664558586443 0.000020956299672 0.000090417879800 ;
     0.059714929346357 0.041724474053947 0.023732575023848 0.007252328174191 0.001577227910063 0.000088424673365 0.000138254612187 ;
     0.083901752399141 0.058751002426681 0.033559200375163 0.010325344116380 0.002220738617568 0.000146203062361 0.000165185061723 ;
     0.074692150150696 0.052238344887430 0.029773446364239 0.009133722108804 0.001979154019800 0.000123343763971 0.000156251996920 ;
     0.041772893110167 0.029040173561010 0.016378365470084 0.004962561506352 0.001107825438089 0.000049947607226 0.000116855813130 ;
     0.014464114663050 0.010014393516085 0.005616207718917 0.001698485865832 0.000390941429826 0.000013893400820 0.000064336368095 ;
     0.003098741093577 0.002157592018326 0.001223003045677 0.000375388784102 0.000085453401593 0.000010870811684 0.000025244456212 ;
     0.000265976227180 0.000167956069129 0.000079890576498 0.000021493869974 0.000013367283236 0.000008497094635 0.000006782301612 ;
     0.000208063937541 0.000166187006464 0.000118690908465 0.000057079430930 0.000020940808342 0.000005665137200 -0.000000168973408 ;;;
     0.000105995954541 0.000088437811180 0.000068216646525 0.000036795896958 0.000013911258478 0.000003634627481 0.000000245654907 ;
     0.000082305227710 0.000048357823486 0.000018598970681 0.000003920240240 0.000006841670563 0.000005459161909 0.000002874972318 ;
     0.001482343473286 0.001062496326789 0.000633787431978 0.000212663268242 0.000050648870173 0.000012207954536 0.000013121832759 ;
     0.006565974130034 0.004496170123099 0.002479635379009 0.000736974952483 0.000177805528390 0.000008203440909 0.000042496131359 ;
     0.025515894106589 0.017644320323334 0.009853345343160 0.002937241580289 0.000664558586713 0.000020956299994 0.000090417879839 ;
     0.059714929346284 0.041724474051920 0.023732575020808 0.007252328172221 0.001577227909944 0.000088424673634 0.000138254612240 ;
     0.083901752411519 0.058751002432260 0.033559200375336 0.010325344114503 0.002220738617218 0.000146203062520 0.000165185061765 ;
     0.074692150168181 0.052238344896658 0.029773446366534 0.009133722107527 0.001979154019469 0.000123343764043 0.000156251996938 ;
     0.041772893120397 0.029040173566214 0.016378365471112 0.004962561505395 0.001107825437879 0.000049947607252 0.000116855813130 ;
     0.014464114664914 0.010014393516576 0.005616207718388 0.001698485865159 0.000390941429712 0.000013893400827 0.000064336368085 ;
     0.003098741092972 0.002157592017696 0.001223003045117 0.000375388783819 0.000085453401555 0.000010870811683 0.000025244456198 ;
     0.000265976226768 0.000167956068810 0.000079890576290 0.000021493869906 0.000013367283228 0.000008497094627 0.000006782301602 ;
     0.000208063937547 0.000166187006471 0.000118690908471 0.000057079430927 0.000020940808331 0.000005665137191 -0.000000168973409 ;;;
     0.000105995954543 0.000088437811181 0.000068216646526 0.000036795896958 0.000013911258478 0.000003634627480 0.000000245654908 ;
     0.000082305227722 0.000048357823497 0.000018598970689 0.000003920240244 0.000006841670564 0.000005459161909 0.000002874972318 ;
     0.001482343473296 0.001062496326800 0.000633787431990 0.000212663268251 0.000050648870178 0.000012207954537 0.000013121832759 ;
     0.006565974129995 0.004496170123074 0.002479635379000 0.000736974952488 0.000177805528397 0.000008203440913 0.000042496131359 ;
     0.025515894106489 0.017644320323259 0.009853345343113 0.002937241580277 0.000664558586718 0.000020956299999 0.000090417879839 ;
     0.059714929346240 0.041724474051867 0.023732575020756 0.007252328172195 0.001577227909944 0.000088424673638 0.000138254612241 ;
     0.083901752411654 0.058751002432317 0.033559200375331 0.010325344114479 0.002220738617214 0.000146203062523 0.000165185061766 ;
     0.074692150168421 0.052238344896788 0.029773446366570 0.009133722107513 0.001979154019465 0.000123343764044 0.000156251996938 ;
     0.041772893120559 0.029040173566302 0.016378365471137 0.004962561505385 0.001107825437876 0.000049947607252 0.000116855813130 ;
     0.014464114664954 0.010014393516592 0.005616207718385 0.001698485865150 0.000390941429710 0.000013893400826 0.000064336368085 ;
     0.003098741092964 0.002157592017687 0.001223003045108 0.000375388783813 0.000085453401553 0.000010870811682 0.000025244456198 ;
     0.000265976226760 0.000167956068803 0.000079890576285 0.000021493869904 0.000013367283228 0.000008497094627 0.000006782301602 ;
     0.000208063937546 0.000166187006470 0.000118690908471 0.000057079430927 0.000020940808331 0.000005665137191 -0.000000168973409 ;;;
     0.000105995954543 0.000088437811181 0.000068216646526 0.000036795896958 0.000013911258478 0.000003634627480 0.000000245654908 ;
     0.000082305227723 0.000048357823497 0.000018598970689 0.000003920240244 0.000006841670564 0.000005459161909 0.000002874972318 ;
     0.001482343473296 0.001062496326800 0.000633787431990 0.000212663268252 0.000050648870178 0.000012207954537 0.000013121832759 ;
     0.006565974129995 0.004496170123074 0.002479635379000 0.000736974952488 0.000177805528397 0.000008203440913 0.000042496131359 ;
     0.025515894106488 0.017644320323258 0.009853345343113 0.002937241580277 0.000664558586719 0.000020956299999 0.000090417879839 ;
     0.059714929346240 0.041724474051866 0.023732575020756 0.007252328172195 0.001577227909944 0.000088424673638 0.000138254612241 ;
     0.083901752411654 0.058751002432317 0.033559200375331 0.010325344114478 0.002220738617214 0.000146203062523 0.000165185061766 ;
     0.074692150168422 0.052238344896788 0.029773446366570 0.009133722107513 0.001979154019465 0.000123343764044 0.000156251996938 ;
     0.041772893120560 0.029040173566302 0.016378365471137 0.004962561505385 0.001107825437876 0.000049947607252 0.000116855813130 ;
     0.014464114664954 0.010014393516592 0.005616207718385 0.001698485865150 0.000390941429710 0.000013893400826 0.000064336368085 ;
     0.003098741092964 0.002157592017687 0.001223003045108 0.000375388783813 0.000085453401553 0.000010870811682 0.000025244456198 ;
     0.000265976226760 0.000167956068803 0.000079890576285 0.000021493869904 0.000013367283228 0.000008497094627 0.000006782301602 ;
     0.000208063937546 0.000166187006470 0.000118690908471 0.000057079430927 0.000020940808331 0.000005665137191 -0.000000168973409 ;;;
     0.000105995954543 0.000088437811181 0.000068216646526 0.000036795896958 0.000013911258478 0.000003634627480 0.000000245654908 ;
     0.000082305227723 0.000048357823497 0.000018598970689 0.000003920240244 0.000006841670564 0.000005459161909 0.000002874972318 ;
     0.001482343473296 0.001062496326800 0.000633787431990 0.000212663268252 0.000050648870178 0.000012207954537 0.000013121832759 ;
     0.006565974129995 0.004496170123074 0.002479635379000 0.000736974952488 0.000177805528397 0.000008203440913 0.000042496131359 ;
     0.025515894106488 0.017644320323258 0.009853345343113 0.002937241580277 0.000664558586719 0.000020956299999 0.000090417879839 ;
     0.059714929346240 0.041724474051866 0.023732575020756 0.007252328172195 0.001577227909944 0.000088424673638 0.000138254612241 ;
     0.083901752411654 0.058751002432317 0.033559200375331 0.010325344114478 0.002220738617214 0.000146203062523 0.000165185061766 ;
     0.074692150168422 0.052238344896788 0.029773446366570 0.009133722107513 0.001979154019465 0.000123343764044 0.000156251996938 ;
     0.041772893120560 0.029040173566302 0.016378365471137 0.004962561505385 0.001107825437876 0.000049947607252 0.000116855813130 ;
     0.014464114664954 0.010014393516592 0.005616207718385 0.001698485865150 0.000390941429710 0.000013893400826 0.000064336368085 ;
     0.003098741092964 0.002157592017687 0.001223003045108 0.000375388783813 0.000085453401553 0.000010870811682 0.000025244456198 ;
     0.000265976226760 0.000167956068803 0.000079890576285 0.000021493869904 0.000013367283228 0.000008497094627 0.000006782301602 ;
     0.000208063937546 0.000166187006470 0.000118690908471 0.000057079430927 0.000020940808331 0.000005665137191 -0.000000168973409 ;;;
     0.000105995954543 0.000088437811181 0.000068216646526 0.000036795896958 0.000013911258478 0.000003634627480 0.000000245654908 ;
     0.000082305227723 0.000048357823497 0.000018598970689 0.000003920240244 0.000006841670564 0.000005459161909 0.000002874972318 ;
     0.001482343473296 0.001062496326800 0.000633787431990 0.000212663268252 0.000050648870178 0.000012207954537 0.000013121832759 ;
     0.006565974129995 0.004496170123074 0.002479635379000 0.000736974952488 0.000177805528397 0.000008203440913 0.000042496131359 ;
     0.025515894106488 0.017644320323258 0.009853345343113 0.002937241580277 0.000664558586719 0.000020956299999 0.000090417879839 ;
     0.059714929346240 0.041724474051866 0.023732575020756 0.007252328172195 0.001577227909944 0.000088424673638 0.000138254612241 ;
     0.083901752411654 0.058751002432317 0.033559200375331 0.010325344114478 0.002220738617214 0.000146203062523 0.000165185061766 ;
     0.074692150168422 0.052238344896788 0.029773446366570 0.009133722107513 0.001979154019465 0.000123343764044 0.000156251996938 ;
     0.041772893120560 0.029040173566302 0.016378365471137 0.004962561505385 0.001107825437876 0.000049947607252 0.000116855813130 ;
     0.014464114664954 0.010014393516592 0.005616207718385 0.001698485865150 0.000390941429710 0.000013893400826 0.000064336368085 ;
     0.003098741092964 0.002157592017687 0.001223003045108 0.000375388783813 0.000085453401553 0.000010870811682 0.000025244456198 ;
     0.000265976226760 0.000167956068803 0.000079890576285 0.000021493869904 0.000013367283228 0.000008497094627 0.000006782301602 ;
     0.000208063937546 0.000166187006470 0.000118690908471 0.000057079430927 0.000020940808331 0.000005665137191 -0.000000168973409 ]
   )
###########################################################################################
# to modify the test, with a new expected f, print the new f using the following commands
# in an interative Julia REPL. The path is the path to the .dfns file. 
########################################################################################## 

"""
Function to print data from a moment_kinetics run suitable
for copying into the expected data structure.
"""
function print_output_data_for_test_update(path; write_grid=true, write_pdf=true)
    fid = open_readonly_output_file(path, "dfns")
    input = load_input(fid)
    f_ion_vpavperpzrst = load_pdf_data(fid)
    f_ion = f_ion_vpavperpzrst[:,:,1,1,1,:]
    ntind = size(f_ion,3)
    nvperp = size(f_ion,2)
    nvpa = size(f_ion,1)
    vpa, vpa_spectral = load_coordinate_data(fid, "vpa"; ignore_MPI=true)
    vperp, vperp_spectral = load_coordinate_data(fid, "vperp"; ignore_MPI=true)
    # grid
    function print_grid(coord)
        println("# Expected "*coord.name)
        print("[")
        for k in 1:coord.n
            @printf("%.15f", coord.grid[k])
            if k < coord.n
                print(", ")
            end
        end
        print("],\n")
        return nothing
    end
    # pdf
    function print_pdf(pdf)
        println("# Expected f_ion")
        print("[")
        for k in 1:ntind
            for i in 1:nvpa-1
                for j in 1:nvperp-1
                    @printf("%.15f ", pdf[i,j,k])
                end
                @printf("%.15f ", pdf[i,nvperp,k])
                print(";\n")
            end
            for j in 1:nvperp-1
                @printf("%.15f ", pdf[nvpa,j,k])
            end
            @printf("%.15f ", pdf[nvpa,nvperp,k])
            if k < ntind
                print(";;;\n")
            end
        end
        print("]\n")
        return nothing
    end
    # a moment
    function print_moment(moment,moment_name)
        println("# Expected "*moment_name)
        print("[")
        for k in 1:ntind
            @printf("%.15f", moment[1,1,1,k])
            if k < ntind
                print(", ")
            end
        end
        print("],\n")
        return nothing
    end    
    # a field
    function print_field(field,field_name)
        println("# Expected "*field_name)
        print("[")
        for k in 1:ntind
            @printf("%.15f", field[1,1,k])
            if k < ntind
                print(", ")
            end
        end
        print("],\n")
        return nothing
    end
    # the norms
    function print_norms(pdf)
        L2norm_ion = copy(pdf[1,1,:])
        maxnorm_ion = copy(pdf[1,1,:])
        f_dummy_1 = copy(pdf[:,:,1])
        f_dummy_2 = copy(pdf[:,:,1])
        f_dummy_3 = copy(pdf[:,:,1])
        mass = input["ion_species_1"]["mass"]
        for it in 1:ntind
            @views output = diagnose_F_Maxwellian_serial(pdf[:,:,it],
                                                        f_dummy_1,f_dummy_2,f_dummy_3,
                                                        vpa,vperp,mass)
            maxnorm_ion[it] = output[1]
            L2norm_ion[it] = output[2]
        end
        println("# Expected maxnorm_ion")
        print("[")
        for k in 1:ntind
            @printf("%.15f", maxnorm_ion[k])
            if k < ntind
                print(", ")
            end
        end
        print("],\n")
        println("# Expected L2norm_ion")
        print("[")
        for k in 1:ntind
            @printf("%.15f", L2norm_ion[k])
            if k < ntind
                print(", ")
            end
        end
        print("],\n")
        return nothing
    end
    n_ion_zrst, upar_ion_zrst, p_ion_zrst, ppar_ion_zrst, pperp_ion_zrst, qpar_ion_zrst, v_t_ion_zrst, dSdt_zrst = load_ion_moments_data(fid,extended_moments=true)
    phi_zrt, Er_zrt, Ez_zrt = load_fields_data(fid)
    if write_grid
        print_grid(vpa)
        print_grid(vperp)
    end
    print_field(phi_zrt,"phi")
    print_moment(n_ion_zrst,"n_ion")
    print_moment(upar_ion_zrst,"upar_ion")
    print_moment(ppar_ion_zrst,"ppar_ion")
    print_moment(pperp_ion_zrst,"pperp_ion")
    print_moment(qpar_ion_zrst,"qpar_ion")
    print_moment(v_t_ion_zrst,"v_t_ion")
    print_moment(dSdt_zrst,"dSdt_ion")
    print_norms(f_ion)
    if write_pdf
        print_pdf(f_ion)
    end
    return nothing
end

function diagnose_F_Maxwellian_serial(pdf,pdf_exact,pdf_dummy_1,pdf_dummy_2,vpa,vperp,mass)
    # call this function from a single process
    # construct the local-in-time Maxwellian for this pdf
    dens = get_density(pdf,vpa,vperp)
    upar = get_upar(pdf, dens, vpa, vperp, false)
    pressure = get_p(pdf, dens, upar, vpa, vperp, false, false)
    vth = sqrt(2.0*pressure/(dens*mass))
    for ivperp in 1:vperp.n
        for ivpa in 1:vpa.n
            pdf_exact[ivpa,ivperp] = F_Maxwellian(dens,upar,vth,vpa,vperp,ivpa,ivperp)
        end
    end
    # check how close the pdf is to the Maxwellian with
    # maximum of difference and L2 of difference
    max_err, L2norm = print_test_data(pdf_exact,pdf,pdf_dummy_1,"F",vpa,vperp,pdf_dummy_2;print_to_screen=false)
    return max_err, L2norm
end

# default inputs for tests
test_input_gauss_legendre = OptionsDict("output" => OptionsDict("run_name" => "gausslegendre_pseudospectral",
                                                                "base_directory" => test_output_directory),
                                        "composition" => OptionsDict("n_ion_species" => 1,
                                                                     "n_neutral_species" => 0,
                                                                     "electron_physics" => "boltzmann_electron_response",
                                                                     "T_e" => 1.0),
                                        "ion_species_1" => OptionsDict("initial_density" => 1.5,
                                                                       "initial_temperature" => 1.0,
                                                                       "mass" => 1.0),
                                        "z_IC_ion_species_1" => OptionsDict("initialization_option" => "sinusoid",
                                                                            "density_amplitude" => 0.0,
                                                                            "density_phase" => 0.0,
                                                                            "upar_amplitude" => 0.0,
                                                                            "upar_phase" => 0.0,
                                                                            "temperature_amplitude" => 0.0,
                                                                            "temperature_phase" => 0.0),
                                        "vpa_IC_ion_species_1" => OptionsDict("initialization_option" => "directed-beam",
                                                                              "vpa0" => sqrt(2) * 0.1,
                                                                              "vperp0" => sqrt(2) * 1.0,
                                                                              "vth0" => sqrt(2) * 0.5),
                                        "vpa" => OptionsDict("ngrid" => 3,
                                                             "L" => 8.485281374238571,
                                                             "nelement" => 6,
                                                             "bc" => "zero",
                                                             "discretization" => "gausslegendre_pseudospectral"),
                                        "vperp" => OptionsDict("ngrid" => 3,
                                                               "nelement" => 3,
                                                               "L" => 4.242640687119286,
                                                               "discretization" => "gausslegendre_pseudospectral"),
                                        "reactions" => OptionsDict("ionization_frequency" => 0.0,
                                                                   "charge_exchange_frequency" => 0.0),
                                        "fokker_planck_collisions" => OptionsDict("use_fokker_planck" => true,
                                                                                  "nuii" => 4.0,
                                                                                  "frequency_option" => "manual"),
                                        "evolve_moments" => OptionsDict("pressure" => false,
                                                                        "moments_conservation" => false,
                                                                        "parallel_flow" => false,
                                                                        "density" => false),
                                        "z" => OptionsDict("discretization" => "chebyshev_pseudospectral",
                                                           "ngrid" => 1,
                                                           "nelement_local" => 1,
                                                           "nelement" => 1,
                                                           "bc" => "wall"),
                                        "r" => OptionsDict("discretization" => "chebyshev_pseudospectral",
                                                           "ngrid" => 1,
                                                           "nelement" => 1,
                                                           "nelement_local" => 1),
                                        "timestepping" => OptionsDict("dt" => 0.0070710678118654745,
                                                                      "nstep" => 5000,
                                                                      "nwrite" => 500,
                                                                      "nwrite_dfns" => 500))

"""
Run a test for a single set of parameters
"""
# Note 'name' should not be shared by any two tests in this file
function run_test(test_input, expected, atol, final_atol; args...)
    # by passing keyword arguments to run_test, args becomes a Dict which can be used to
    # update the default inputs

    # Make a copy to make sure nothing modifies the input Dicts defined in this test
    # script.
    input = deepcopy(test_input)
    
    # Convert keyword arguments to a unique name
    function stringify_arg(key, value)
        if isa(value, AbstractDict)
            return string(string(key)[1], (stringify_arg(k, v) for (k, v) in value)...)
        else
            return string(string(key)[1], value)
        end
    end
    name = input["output"]["run_name"]
    if length(args) > 0
        name = string(name[1], "_", (stringify_arg(k, v) for (k, v) in args)...)
    end

    # Provide some progress info
    println("    - testing ", name)

    # Update default inputs with values to be changed
    merge_dict_with_kwargs!(input; args...)
    input["output"]["run_name"] = name
    # Suppress console output while running
    quietoutput() do
        # run simulation
        run_moment_kinetics(input)
    end

    phi = nothing
    n_ion = nothing
    upar_ion = nothing
    ppar_ion = nothing
    pperp_ion = nothing
    qpar_ion = nothing
    v_t_ion = nothing
    dSdt = nothing
    maxnorm_ion = nothing
    L2norm_ion = nothing
    f_ion = nothing
    f_err = nothing
    vpa, vpa_spectral = nothing, nothing
    vperp, vperp_spectral = nothing, nothing

    if global_rank[] == 0
        ntime = 0
        quietoutput() do

            # Load and analyse output
            #########################

            path = joinpath(realpath(input["output"]["base_directory"]), name, name)

            # open the netcdf file containing moments data and give it the handle 'fid'
            fid = open_readonly_output_file(path, "moments")

            # load species, time coordinate data
            n_ion_species, n_neutral_species = load_species_data(fid)
            ntime, time = load_time_data(fid)
            n_ion_species, n_neutral_species = load_species_data(fid)
            
            # load fields data
            phi_zrt, Er_zrt, Ez_zrt = load_fields_data(fid)

            # load velocity moments data
            n_ion_zrst, upar_ion_zrst, p_ion_zrst,  ppar_ion_zrst,
            pperp_ion_zrst, qpar_ion_zrst, v_t_ion_zrst, dSdt_zrst = load_ion_moments_data(fid,extended_moments=true)
            
            close(fid)
            
            # open the netcdf file containing pdf data
            fid = open_readonly_output_file(path, "dfns")
            # load coordinates
            vpa, vpa_spectral = load_coordinate_data(fid, "vpa"; ignore_MPI=true)
            vperp, vperp_spectral = load_coordinate_data(fid, "vperp"; ignore_MPI=true)

            # load particle distribution function (pdf) data
            f_ion_vpavperpzrst = load_pdf_data(fid)
            
            close(fid)
            # select the single z, r, s point
            # keep the two time points in the arrays
            phi = phi_zrt[1,1,:]
            n_ion = n_ion_zrst[1,1,1,:]
            upar_ion = upar_ion_zrst[1,1,1,:]
            ppar_ion = ppar_ion_zrst[1,1,1,:]
            pperp_ion = pperp_ion_zrst[1,1,1,:]
            qpar_ion = qpar_ion_zrst[1,1,1,:]
            v_t_ion = v_t_ion_zrst[1,1,1,:]
            dSdt = dSdt_zrst[1,1,1,:]
            f_ion = f_ion_vpavperpzrst[:,:,1,1,1,:]
            f_dummy_1 = copy(f_ion[:,:,1])
            f_dummy_2 = copy(f_ion[:,:,1])
            f_dummy_3 = copy(f_ion[:,:,1])
            L2norm_ion = copy(phi)
            maxnorm_ion = copy(phi)
            mass = input["ion_species_1"]["mass"]

            for it in 1:ntime
                @views output = diagnose_F_Maxwellian_serial(f_ion[:,:,it],
                                                            f_dummy_1,f_dummy_2,f_dummy_3,
                                                            vpa,vperp,mass)
                maxnorm_ion[it] = output[1]
                L2norm_ion[it] = output[2]
            end
        end
        
        function test_values(tind)
            @testset "tind=$tind" begin
                # Check grids
                #############

                if tind == ntime
                    this_atol = final_atol
                else
                    this_atol = atol
                end
                
                @test isapprox(expected.vpa[:], vpa.grid[:], atol=this_atol)
                @test isapprox(expected.vperp[:], vperp.grid[:], atol=this_atol)
            
                # Check electrostatic potential
                ###############################
                
                @test isapprox(expected.phi[tind], phi[tind], atol=this_atol)

                # Check ion particle moments and f
                ######################################

                @test isapprox(expected.n_ion[tind], n_ion[tind], atol=this_atol)
                @test isapprox(expected.upar_ion[tind], upar_ion[tind], atol=this_atol)
                @test isapprox(expected.ppar_ion[tind], ppar_ion[tind], atol=this_atol)
                @test isapprox(expected.pperp_ion[tind], pperp_ion[tind], atol=this_atol)
                @test isapprox(expected.qpar_ion[tind], qpar_ion[tind], atol=this_atol)
                @test isapprox(expected.v_t_ion[tind], v_t_ion[tind], atol=this_atol)
                @test isapprox(expected.dSdt[tind], dSdt[tind], atol=this_atol)
                @test isapprox(expected.maxnorm_ion[tind], maxnorm_ion[tind], atol=this_atol)
                @test isapprox(expected.L2norm_ion[tind], L2norm_ion[tind], atol=this_atol)
                f_err = @. abs(expected.f_ion[:,:,tind] - f_ion[:,:,tind])
                max_f_err = maximum(f_err)
                @test isapprox(max_f_err, 0.0, atol=this_atol)
                @test isapprox(expected.f_ion[:,:,tind], f_ion[:,:,tind], atol=this_atol)
            end
        end

        for it ∈ 1:ntime
            test_values(it)
        end
    end
end


function runtests()
    @testset "Fokker Planck dFdt = C[F,F] relaxation test" verbose=use_verbose begin
        println("Fokker Planck dFdt = C[F,F] relaxation test")

        # GaussLegendre pseudospectral
        # Benchmark data is taken from this run (GaussLegendre)
        @testset "Gauss Legendre base" begin
            run_name = "gausslegendre_pseudospectral"
            vperp_bc = "zero-impose-regularity"
            run_test(test_input_gauss_legendre,
             expected_zero_impose_regularity, 2.0e-14, 2.0e-14;
             vperp=OptionsDict("bc" => vperp_bc))
        end
        @testset "Gauss Legendre no enforced regularity condition at vperp = 0" begin
            run_name = "gausslegendre_pseudospectral_no_regularity"
            vperp_bc = "zero"
            run_test(test_input_gauss_legendre,
            expected_zero,
             1.0e-14, 2.0e-14; vperp=OptionsDict("bc" => vperp_bc))
        end
        @testset "Gauss Legendre no (explicitly) enforced boundary conditions: explicit timestepping" begin
            run_name = "gausslegendre_pseudospectral_none_bc"
            vperp_bc = "none"
            vpa_bc = "none"
            run_test(test_input_gauss_legendre, expected_none_bc, 1.0e-14, 2.0e-14;
                     vperp=OptionsDict("bc" => vperp_bc), vpa=OptionsDict("bc" => vpa_bc))
        end
        @testset "Gauss Legendre no (explicitly) enforced boundary conditions: IMEX timestepping" begin
            run_name = "gausslegendre_pseudospectral_none_bc"
            vperp_bc = "none"
            vpa_bc = "none"
            run_test(test_input_gauss_legendre, expected_none_bc, 1.0e-5, 5.0e-12;
                     vperp=OptionsDict("bc" => vperp_bc), vpa=OptionsDict("bc" => vpa_bc),
                     fokker_planck_collisions_nonlinear_solver=OptionsDict("rtol" => 0.0,
                                                                           "atol" => 1.0e-14,
                                                                           "nonlinear_max_iterations" => 20,),
                     timestepping=OptionsDict("kinetic_ion_solver" => "implicit_ion_fp_collisions",
                                              "type" => "PareschiRusso3(4,3,3)",))
        end
    end
end

end # FokkerPlanckTimeEvolutionTests


using .FokkerPlanckTimeEvolutionTests

FokkerPlanckTimeEvolutionTests.runtests()
