<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Setup for moment_kinetics on known clusters · moment_kinetics</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">moment_kinetics</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../constraints_on_normalized_distribution_function/">Constraints on normalized distribution function</a></li><li><a class="tocitem" href="../debugging-hints/">Debugging</a></li><li><a class="tocitem" href="../developing/">Developing</a></li><li><a class="tocitem" href="../external_sources_notes/">External sources</a></li><li><a class="tocitem" href="../getting_started/">Getting started</a></li><li><a class="tocitem" href="../input_options/">Input Options</a></li><li><a class="tocitem" href="../moment_kinetic_equations/">Moment kinetic equations</a></li><li><a class="tocitem" href="../post_processing_notes/">Post processing</a></li><li class="is-active"><a class="tocitem" href>Setup for <code>moment_kinetics</code> on known clusters</a><ul class="internal"><li><a class="tocitem" href="#Quickstart"><span>Quickstart</span></a></li><li><a class="tocitem" href="#After-editing-source-code"><span>After editing source code</span></a></li><li><a class="tocitem" href="#Running-and-restarting-simulations"><span>Running and restarting simulations</span></a></li><li><a class="tocitem" href="#Advanced-usage"><span>Advanced usage</span></a></li><li><a class="tocitem" href="#API-documentation"><span>API documentation</span></a></li></ul></li><li><a class="tocitem" href="../shared_memory_debugging/">Shared memory debugging</a></li><li><a class="tocitem" href="../wall_boundary_conditions/">Wall boundary conditions with moment constraints</a></li><li><a class="tocitem" href="../zz_advection/"><code>advection</code></a></li><li><a class="tocitem" href="../zz_analysis/"><code>analysis</code></a></li><li><a class="tocitem" href="../zz_array_allocation/"><code>array_allocation</code></a></li><li><a class="tocitem" href="../zz_bgk/"><code>bgk</code></a></li><li><a class="tocitem" href="../zz_calculus/"><code>calculus</code></a></li><li><a class="tocitem" href="../zz_charge_exchange/"><code>charge_exchange</code></a></li><li><a class="tocitem" href="../zz_chebyshev/"><code>chebyshev</code></a></li><li><a class="tocitem" href="../zz_clenshaw_curtis/"><code>clenshaw_curtis</code></a></li><li><a class="tocitem" href="../zz_command_line_options/"><code>command_line_options</code></a></li><li><a class="tocitem" href="../zz_communication/"><code>communication</code></a></li><li><a class="tocitem" href="../zz_constants/"><code>constants</code></a></li><li><a class="tocitem" href="../zz_continuity/"><code>continuity</code></a></li><li><a class="tocitem" href="../zz_coordinates/"><code>coordinates</code></a></li><li><a class="tocitem" href="../zz_debugging/"><code>debugging</code></a></li><li><a class="tocitem" href="../zz_derivatives/"><code>derivatives</code></a></li><li><a class="tocitem" href="../zz_em_fields/"><code>em_fields</code></a></li><li><a class="tocitem" href="../zz_energy_equation/"><code>energy_equation</code></a></li><li><a class="tocitem" href="../zz_external_sources/"><code>external_sources</code></a></li><li><a class="tocitem" href="../zz_file_io/"><code>file_io</code></a></li><li><a class="tocitem" href="../zz_finite_differences/"><code>finite_differences</code></a></li><li><a class="tocitem" href="../zz_force_balance/"><code>force_balance</code></a></li><li><a class="tocitem" href="../zz_initial_conditions/"><code>initial_conditions</code></a></li><li><a class="tocitem" href="../zz_input_structs/"><code>input_structs</code></a></li><li><a class="tocitem" href="../zz_interpolation/"><code>interpolation</code></a></li><li><a class="tocitem" href="../zz_ionization/"><code>ionization</code></a></li><li><a class="tocitem" href="../zz_krook_collisions/"><code>krook_collisions</code></a></li><li><a class="tocitem" href="../zz_load_data/"><code>load_data</code></a></li><li><a class="tocitem" href="../zz_looping/"><code>looping</code></a></li><li><a class="tocitem" href="../zz_makie_post_processing/"><code>makie_post_processing</code></a></li><li><a class="tocitem" href="../zz_manufactured_solns/"><code>manufactured_solns</code></a></li><li><a class="tocitem" href="../zz_moment_constraints/"><code>moment_kinetics</code></a></li><li><a class="tocitem" href="../zz_moment_kinetics/"><code>moment_kinetics</code></a></li><li><a class="tocitem" href="../zz_moment_kinetics_input/"><code>moment_kinetics_input</code></a></li><li><a class="tocitem" href="../zz_moment_kinetics_structs/"><code>moment_kinetics_structs</code></a></li><li><a class="tocitem" href="../zz_neutral_r_advection/"><code>neutral_r_advection</code></a></li><li><a class="tocitem" href="../zz_neutral_vz_advection/"><code>neutral_vz_advection</code></a></li><li><a class="tocitem" href="../zz_neutral_z_advection/"><code>neutral_z_advection</code></a></li><li><a class="tocitem" href="../zz_numerical_dissipation/"><code>numerical_dissipation</code></a></li><li><a class="tocitem" href="../zz_plot_MMS_sequence/"><code>plot_MMS_sequence</code></a></li><li><a class="tocitem" href="../zz_plot_sequence/"><code>plot_sequence</code></a></li><li><a class="tocitem" href="../zz_post_processing/"><code>post_processing</code></a></li><li><a class="tocitem" href="../zz_post_processing_input/"><code>post_processing_input</code></a></li><li><a class="tocitem" href="../zz_quadrature/"><code>quadrature</code></a></li><li><a class="tocitem" href="../zz_r_advection/"><code>r_advection</code></a></li><li><a class="tocitem" href="../zz_reference_parameters/"><code>reference_parameters</code></a></li><li><a class="tocitem" href="../zz_scan_input/"><code>scan_input</code></a></li><li><a class="tocitem" href="../zz_source_terms/"><code>source_terms</code></a></li><li><a class="tocitem" href="../zz_time_advance/"><code>time_advance</code></a></li><li><a class="tocitem" href="../zz_type_definitions/"><code>type_definitions</code></a></li><li><a class="tocitem" href="../zz_utils/"><code>utils</code></a></li><li><a class="tocitem" href="../zz_velocity_grid_transforms/"><code>velocity_grid_transforms</code></a></li><li><a class="tocitem" href="../zz_velocity_moments/"><code>velocity_moments</code></a></li><li><a class="tocitem" href="../zz_vpa_advection/"><code>vpa_advection</code></a></li><li><a class="tocitem" href="../zz_z_advection/"><code>z_advection</code></a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Setup for <code>moment_kinetics</code> on known clusters</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Setup for <code>moment_kinetics</code> on known clusters</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/mabarnes/moment_kinetics/blob/master/machines/README.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Setup-for-moment_kinetics-on-known-clusters"><a class="docs-heading-anchor" href="#Setup-for-moment_kinetics-on-known-clusters">Setup for <code>moment_kinetics</code> on known clusters</a><a id="Setup-for-moment_kinetics-on-known-clusters-1"></a><a class="docs-heading-anchor-permalink" href="#Setup-for-moment_kinetics-on-known-clusters" title="Permalink"></a></h1><p>This subdirectory provides scripts to set up Julia and <code>moment_kinetics</code> to run on some known clusters.</p><p>Currently supported:</p><ul><li>&quot;archer&quot; (<a href="https://www.archer2.ac.uk/">ARCHER2</a>)</li><li>&quot;marconi&quot; (the EUROfusion supercomputer   <a href="https://wiki.u-gov.it/confluence/display/SCAIUS/UG3.1%3A+MARCONI+UserGuide">Marconi</a>)</li></ul><h2 id="Quickstart"><a class="docs-heading-anchor" href="#Quickstart">Quickstart</a><a id="Quickstart-1"></a><a class="docs-heading-anchor-permalink" href="#Quickstart" title="Permalink"></a></h2><p>From the top-level of the <code>moment_kinetics</code> repo, run</p><pre><code class="language-shell hljs">$ machines/machine_setup.sh [&lt;path-to-Julia-executable&gt;]</code></pre><p>If you omit the <code>&lt;path-to-Julia-executable&gt;</code> argument, you will be prompted to enter it, with a default taken from your <code>$PATH</code>. If there is no <code>julia</code> in your <code>$PATH</code> you will be asked if you want the script to download Julia for you, or you can force the download by passing the <code>-d</code> flag (and do not pass a <code>&lt;path-to-Julia-executable&gt;</code>).</p><p>The script will prompt you for several settings, with sensible defaults (where possible). Note that some settings are needed on all machines - if a setting is not needed it will be ignored.</p><p>You will be prompted to enter a location for your <code>.julia</code> directory. If you are installing on a cluster which allows access to your home directory from compute nodes, it is fine to leave this as the default. If not (e.g. on ARCHER2), you need to set a path which is accessible from the compute nodes. If you want to create a completely self-contained install (e.g. for reproducibility or for debugging some dependency conflicts), you might want to put <code>.julia</code> within the <code>moment_kinetics</code> directory (e.g. enter <code>.</code> at the prompt).</p><h2 id="After-editing-source-code"><a class="docs-heading-anchor" href="#After-editing-source-code">After editing source code</a><a id="After-editing-source-code-1"></a><a class="docs-heading-anchor-permalink" href="#After-editing-source-code" title="Permalink"></a></h2><p>If you use the precompiled <code>moment_kinetics.so</code> system image, you need to recompile it after editing source code (otherwise simulations will continue to use the old source code).</p><p>To do this, run</p><pre><code class="language-shell hljs">$ ./precompile-submit.sh</code></pre><p>and wait for the resulting job to complete.</p><p>This step is required if you use the <code>sumbit-run.sh</code> or <code>submit-restart.sh</code> scripts, as these both use the <code>moment_kinetics.so</code> system image.</p><h2 id="Running-and-restarting-simulations"><a class="docs-heading-anchor" href="#Running-and-restarting-simulations">Running and restarting simulations</a><a id="Running-and-restarting-simulations-1"></a><a class="docs-heading-anchor-permalink" href="#Running-and-restarting-simulations" title="Permalink"></a></h2><p>Convenience scripts are provided to submit jobs running and post-processing a simulation run or restart.</p><pre><code class="language-shell hljs">$ ./submit-run.sh &lt;path to input file&gt;.toml</code></pre><p>will submit a job to run a simulation using that input file and (by default) a linked job that will run the post-processing routines (in the serial queue) when the run finishes.</p><p>Similarly</p><pre><code class="language-shell hljs">$ ./submit-restart.sh &lt;path to input file&gt;.toml</code></pre><p>will submit a job to run and post-process a restart using input file. The simulation will restart from the last time point of the previous run (<code>run_moment_kinetics.jl</code> supports more flexibility, but for now you would need to write your own submission script to pass the options needed for that).</p><p>Default parameters for the runs (number of nodes, time limit, etc.) were set up by <code>machines/machine_setup.sh</code> are stored in <code>LocalPreferences.toml</code> (which can be edited to change them). The parameters can be altered for a particular job (and you can disable the post-processing job) using command line flags described by the help text</p><pre><code class="language-shell hljs">$ ./submit-run.sh -h</code></pre><p>or</p><pre><code class="language-shell hljs">$ ./submit-restart.sh -h</code></pre><h2 id="Advanced-usage"><a class="docs-heading-anchor" href="#Advanced-usage">Advanced usage</a><a id="Advanced-usage-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-usage" title="Permalink"></a></h2><p>The convenience script <code>machine_setup.sh</code> is provide because the actual setup happens in multiple stages, with Julia being restarted in between (as this is required on some machines):</p><ol><li>Start Julia (using the Julia executable you want to use in the end for simulations) from the top level of the <code>moment_kinetics</code> repo, but not requiring the <code>--project</code> flag; run <code>include(&quot;machines/shared/machine_setup.jl&quot;)</code>; call the <a href="#moment_kinetics.machine_setup.machine_setup_moment_kinetics-NTuple{9, String}"><code>moment_kinetics.machine_setup_moment_kinetics</code></a> function with appropriate settings as arguments (see the docstring).<ul><li>This function requires no packages outside the base Julia system image (because on some machines it is desirable not to have to install any packages before setting <code>JULIA_DEPOT_PATH</code>, which can be done by this function).</li><li>It saves some settings into <code>LocalPreferences.toml</code>; makes a symlink at <code>bin/julia</code> to the Julia executable being used; saves environment setup  into the <code>julia.env</code> file (which can include setting the  <code>JULIA_DEPOT_PATH</code> environment variable to ensure the <code>.julia</code>  directory is accessible on compute nodes); and if necessary symlinks a  machine-specific file from  <code>machines/shared/machine_setup_stage_two.jl</code>.</li><li>Usually Julia needs to be restarted after running this function, so it will call <code>exit()</code> to stop Julia. This can be avoided by passing the <code>no_force_exit=true</code> argument if that is useful.</li></ul></li><li>Run <code>source julia.env</code> in each terminal session where you want to use <code>moment_kinetics</code>, or add it to your <code>.bashrc</code> (if this does not conflict with any other projects).<ul><li>Note that <code>julia.env</code> runs <code>module purge</code> to remove any already loaded modules (to get a clean environment). It is therefore very likely to interfere with other projects.</li></ul></li><li>If it is necessary to run a second stage of setup, for example after Julia is restarted with a special <code>JULIA_DEPOT_PATH</code>, start Julia again, this time with the <code>--project</code> flag. A symlink has been created, so you can use<pre><code class="language-shell hljs">$ bin/julia --project</code></pre>and run <code>include(&quot;machines/shared/machine_setup_stage_two.jl&quot;)</code>.<ul><li>This script sets up MPI and HDF5.</li><li>It exits Julia when it is finished, as Julia must be restarted when <code>MPIPreferences</code> settings are changed.</li></ul></li><li>If you want to build a precompiled system image (to speed up startup of simulation runs), run<pre><code class="language-shell hljs">$ precompile-submit.sh</code></pre>which will submit a serial or debug job that runs <code>precompile.jl</code> to create the <code>moment_kinetics.so</code> image.<ul><li>This is required if using the <code>submit-run.sh</code> script, unless you edit the jobscript templates in the appropriate subdirectory <code>machines/&lt;your-machine&gt;</code>.</li></ul></li></ol><h2 id="API-documentation"><a class="docs-heading-anchor" href="#API-documentation">API documentation</a><a id="API-documentation-1"></a><a class="docs-heading-anchor-permalink" href="#API-documentation" title="Permalink"></a></h2><article class="docstring"><header><a class="docstring-binding" id="moment_kinetics.machine_setup" href="#moment_kinetics.machine_setup"><code>moment_kinetics.machine_setup</code></a> — <span class="docstring-category">Module</span></header><section><div><p>Functions to help setting up on known machines</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/mabarnes/moment_kinetics/blob/9cc5aa336a4cbff93bfac8ea0f1ddace8043acae/machines/shared/machine_setup.jl#L1-L3">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="moment_kinetics.machine_setup.machine_setup_moment_kinetics-NTuple{9, String}" href="#moment_kinetics.machine_setup.machine_setup_moment_kinetics-NTuple{9, String}"><code>moment_kinetics.machine_setup.machine_setup_moment_kinetics</code></a> — <span class="docstring-category">Method</span></header><section><div><pre><code class="language-julia hljs">machine_setup_moment_kinetics(machine::String,
                              account::String,
                              julia_directory::String,
                              default_run_time::String,
                              default_nodes::String,
                              default_postproc_time::String,
                              default_postproc_memory::String,
                              default_partition::String;
                              default_qos::String;
                              no_force_exit::Bool=false,
                              interactive::Bool=true)</code></pre><p>Do setup for a known <code>machine</code>:</p><ul><li><p>On clusters that use a module system, provide <code>julia.env</code> at the top level of the moment_kinetics repo.</p><p>Call</p><pre><code class="language-shell hljs">source julia.env</code></pre><p>to get the correct modules for running moment_kinetics, either on the command line (to get them for the current session) or in your <code>.bashrc</code> (to get them by default). Note that this calls <code>module purge</code> so will remove any currently loaded modules when it is run.</p></li><li><p>Run setup commands for MPI and HDF5 which ensure the correct, system-provided libraries are used.</p></li><li><p>Makes a symlink to the Julia exeutable used to run this command at <code>bin/julia</code> under the moment_kinetics repo, so that setup and job submission scripts can use a known relative path.</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>If you change the Julia executable, e.g. to update to a new verison, you will need to either replace the symlink <code>&lt;moment_kinetics&gt;/bin/julia</code> by hand, or re-run this function using the new executable.</p></div></div></li></ul><p><code>julia_directory</code> gives the location of the directory (usually called <code>.julia</code>) where Julia installs files, saves settings, etc. <code>julia_directory</code> must be passed if this directory should be in a non-default location (i.e. not <code>$HOME/.julia/</code>). The value is used to set <code>JULIA_DEPOT_PATH</code> in the <code>julia.env</code> file, so that this setting is propagated to the environment on the compute nodes.</p><p>Usually it is necessary for Julia to be restarted after running this function to ensure the correct MPI is linked, etc. so the function will force Julia to exit. If for some reason this is not desired (e.g. when debugging), pass <code>no_force_exit=true</code>.</p><p>The <code>interactive</code> argument exists so that when this function is called from another script, terminal output with instructions for the next step can be disabled.</p><p>The remaining arguments can be used to change the default settings for jobs submitted using the provided <code>submit-run.sh</code> script. These settings are read by the scripts from <code>LocalPreferences.toml</code> and the values can safely be edited in that file without re-running this function (if you want to). The arguments are:</p><ul><li><code>default_run_time</code> is the maximum run time for the simulation, in the format expected by <code>sbatch --time</code>, e.g. <code>&quot;24:00:00&quot;</code> for 24 hours, 0 minutes, 0 seconds.</li><li><code>default_nodes</code> is the default number of nodes to use for a simulation run. Note that post-processing always runs in serial (using a serial or debug queue if available).</li><li><code>default_postproc_time</code> is the maximum run time for the post-processing job, in the format expected by <code>sbatch --time</code>, e.g. <code>&quot;1:00:00&quot;</code> for 1 hours, 0 minutes, 0 seconds.</li><li><code>default_postproc_memory</code> is the memory requested for the post-processing job, in the format expected by <code>sbatch --mem</code>, e.g. <code>&quot;64G&quot;</code> for 64GB.</li><li><code>default_partition</code> is the default &#39;partition&#39; passed to <code>sbatch --partition</code>. See your cluster&#39;s documentation for possible values. The default will be the standard queue, which charges towards the budget of your allocation. You might sometimes want, for example, to change this to a debug queue if one is available.</li><li><code>default_qos</code> is the default &#39;quality of service&#39; passed to <code>sbatch --qos</code>. See your cluster&#39;s documentation for possible values. The default will be the standard queue, which charges towards the budget of your allocation. You might want, for example, to change this to a free, low-priority queue if one is available.</li></ul><p>Currently supported machines:</p><ul><li><code>&quot;archer&quot;</code> - the UK supercomputer <a href="https://www.archer2.ac.uk/">ARCHER2</a></li><li><code>&quot;marconi&quot;</code> - the EUROfusion supercomputer   <a href="https://wiki.u-gov.it/confluence/display/SCAIUS/UG3.1%3A+MARCONI+UserGuide">Marconi</a></li></ul><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>The settings created by this function are saved in LocalPreferences.toml (using the <code>Preferences.jl</code> package). It might sometimes be useful to edit these by hand (e.g. the <code>account</code> setting if this needs to be changed.): it is fine to do this.</p></div></div></div><a class="docs-sourcelink" target="_blank" href="https://github.com/mabarnes/moment_kinetics/blob/9cc5aa336a4cbff93bfac8ea0f1ddace8043acae/machines/shared/machine_setup.jl#L27-L106">source</a></section></article></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../post_processing_notes/">« Post processing</a><a class="docs-footer-nextpage" href="../shared_memory_debugging/">Shared memory debugging »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Tuesday 14 November 2023 22:15">Tuesday 14 November 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
