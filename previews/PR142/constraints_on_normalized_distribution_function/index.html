<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Constraints on normalized distribution function · moment_kinetics</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">moment_kinetics</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Constraints on normalized distribution function</a><ul class="internal"><li><a class="tocitem" href="#Constraints"><span>Constraints</span></a></li><li><a class="tocitem" href="#Old-algorithm"><span>Old algorithm</span></a></li><li><a class="tocitem" href="#Current-algorithm"><span>Current algorithm</span></a></li></ul></li><li><a class="tocitem" href="../debugging-hints/">Debugging</a></li><li><a class="tocitem" href="../developing/">Developing</a></li><li><a class="tocitem" href="../external_sources_notes/">External sources</a></li><li><a class="tocitem" href="../getting_started/">Getting started</a></li><li><a class="tocitem" href="../input_options/">Input Options</a></li><li><a class="tocitem" href="../moment_kinetic_equations/">Moment kinetic equations</a></li><li><a class="tocitem" href="../post_processing_notes/">Post processing</a></li><li><a class="tocitem" href="../setup_for_moment_kinetics/">Setup for <code>moment_kinetics</code> on known clusters</a></li><li><a class="tocitem" href="../shared_memory_debugging/">Shared memory debugging</a></li><li><a class="tocitem" href="../wall_boundary_conditions/">Wall boundary conditions with moment constraints</a></li><li><a class="tocitem" href="../zz_advection/"><code>advection</code></a></li><li><a class="tocitem" href="../zz_analysis/"><code>analysis</code></a></li><li><a class="tocitem" href="../zz_array_allocation/"><code>array_allocation</code></a></li><li><a class="tocitem" href="../zz_bgk/"><code>bgk</code></a></li><li><a class="tocitem" href="../zz_calculus/"><code>calculus</code></a></li><li><a class="tocitem" href="../zz_charge_exchange/"><code>charge_exchange</code></a></li><li><a class="tocitem" href="../zz_chebyshev/"><code>chebyshev</code></a></li><li><a class="tocitem" href="../zz_clenshaw_curtis/"><code>clenshaw_curtis</code></a></li><li><a class="tocitem" href="../zz_command_line_options/"><code>command_line_options</code></a></li><li><a class="tocitem" href="../zz_communication/"><code>communication</code></a></li><li><a class="tocitem" href="../zz_constants/"><code>constants</code></a></li><li><a class="tocitem" href="../zz_continuity/"><code>continuity</code></a></li><li><a class="tocitem" href="../zz_coordinates/"><code>coordinates</code></a></li><li><a class="tocitem" href="../zz_debugging/"><code>debugging</code></a></li><li><a class="tocitem" href="../zz_derivatives/"><code>derivatives</code></a></li><li><a class="tocitem" href="../zz_em_fields/"><code>em_fields</code></a></li><li><a class="tocitem" href="../zz_energy_equation/"><code>energy_equation</code></a></li><li><a class="tocitem" href="../zz_external_sources/"><code>external_sources</code></a></li><li><a class="tocitem" href="../zz_file_io/"><code>file_io</code></a></li><li><a class="tocitem" href="../zz_finite_differences/"><code>finite_differences</code></a></li><li><a class="tocitem" href="../zz_force_balance/"><code>force_balance</code></a></li><li><a class="tocitem" href="../zz_initial_conditions/"><code>initial_conditions</code></a></li><li><a class="tocitem" href="../zz_input_structs/"><code>input_structs</code></a></li><li><a class="tocitem" href="../zz_interpolation/"><code>interpolation</code></a></li><li><a class="tocitem" href="../zz_ionization/"><code>ionization</code></a></li><li><a class="tocitem" href="../zz_krook_collisions/"><code>krook_collisions</code></a></li><li><a class="tocitem" href="../zz_load_data/"><code>load_data</code></a></li><li><a class="tocitem" href="../zz_looping/"><code>looping</code></a></li><li><a class="tocitem" href="../zz_makie_post_processing/"><code>makie_post_processing</code></a></li><li><a class="tocitem" href="../zz_manufactured_solns/"><code>manufactured_solns</code></a></li><li><a class="tocitem" href="../zz_moment_constraints/"><code>moment_kinetics</code></a></li><li><a class="tocitem" href="../zz_moment_kinetics/"><code>moment_kinetics</code></a></li><li><a class="tocitem" href="../zz_moment_kinetics_input/"><code>moment_kinetics_input</code></a></li><li><a class="tocitem" href="../zz_moment_kinetics_structs/"><code>moment_kinetics_structs</code></a></li><li><a class="tocitem" href="../zz_neutral_r_advection/"><code>neutral_r_advection</code></a></li><li><a class="tocitem" href="../zz_neutral_vz_advection/"><code>neutral_vz_advection</code></a></li><li><a class="tocitem" href="../zz_neutral_z_advection/"><code>neutral_z_advection</code></a></li><li><a class="tocitem" href="../zz_numerical_dissipation/"><code>numerical_dissipation</code></a></li><li><a class="tocitem" href="../zz_plot_MMS_sequence/"><code>plot_MMS_sequence</code></a></li><li><a class="tocitem" href="../zz_plot_sequence/"><code>plot_sequence</code></a></li><li><a class="tocitem" href="../zz_post_processing/"><code>post_processing</code></a></li><li><a class="tocitem" href="../zz_post_processing_input/"><code>post_processing_input</code></a></li><li><a class="tocitem" href="../zz_quadrature/"><code>quadrature</code></a></li><li><a class="tocitem" href="../zz_r_advection/"><code>r_advection</code></a></li><li><a class="tocitem" href="../zz_reference_parameters/"><code>reference_parameters</code></a></li><li><a class="tocitem" href="../zz_scan_input/"><code>scan_input</code></a></li><li><a class="tocitem" href="../zz_source_terms/"><code>source_terms</code></a></li><li><a class="tocitem" href="../zz_time_advance/"><code>time_advance</code></a></li><li><a class="tocitem" href="../zz_type_definitions/"><code>type_definitions</code></a></li><li><a class="tocitem" href="../zz_utils/"><code>utils</code></a></li><li><a class="tocitem" href="../zz_velocity_grid_transforms/"><code>velocity_grid_transforms</code></a></li><li><a class="tocitem" href="../zz_velocity_moments/"><code>velocity_moments</code></a></li><li><a class="tocitem" href="../zz_vpa_advection/"><code>vpa_advection</code></a></li><li><a class="tocitem" href="../zz_z_advection/"><code>z_advection</code></a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Constraints on normalized distribution function</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Constraints on normalized distribution function</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/mabarnes/moment_kinetics/blob/master/docs/src/constraints_on_normalized_distribution_function.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Constraints-on-normalized-distribution-function"><a class="docs-heading-anchor" href="#Constraints-on-normalized-distribution-function">Constraints on normalized distribution function</a><a id="Constraints-on-normalized-distribution-function-1"></a><a class="docs-heading-anchor-permalink" href="#Constraints-on-normalized-distribution-function" title="Permalink"></a></h1><blockquote><p>Note: Equation references give the Excalibur/Neptune report number and equation number, e.g. (TN-04;1) is equation (1) from report TN-04.pdf.</p></blockquote><h2 id="Constraints"><a class="docs-heading-anchor" href="#Constraints">Constraints</a><a id="Constraints-1"></a><a class="docs-heading-anchor-permalink" href="#Constraints" title="Permalink"></a></h2><p>The normalized particle distribution function that is evolved when using the moment-kinetic approach has to satisfy integral constraints related to particle number, momentum and energy conservation (TN-04;70-72)</p><p class="math-container">\[\begin{align}
  \frac{1}{\sqrt{\pi}}\int dw_{\|}\tilde{g}_{s} &amp; =1\\
  \frac{1}{\sqrt{\pi}}\int dw_{\|}w_{\|}\tilde{g}_{s} &amp; =0\\
  \frac{1}{\sqrt{\pi}}\int dw_{\|}w_{\|}^{2}\tilde{g}_{s} &amp; =\frac{1}{2}
\end{align}\]</p><h2 id="Old-algorithm"><a class="docs-heading-anchor" href="#Old-algorithm">Old algorithm</a><a id="Old-algorithm-1"></a><a class="docs-heading-anchor-permalink" href="#Old-algorithm" title="Permalink"></a></h2><p>The algorithm described in TN-04 used the distribution function from the previous time step and also made use of a symmetrized distribution function <span>$\tilde{g}_{E}(w_{\|})=\frac{1}{2}\left(\tilde{g}(w_{\|})+\tilde{g}(-w_{\|})\right)$</span>. These choices caused problems when in combination with the boundary conditions as: applying the boundary condition at the new timestep (with an updated <span>$\tilde{u}_{\|}$</span>) to the old <span>$\tilde{g}_{s}$</span> could mean that it no longer satisfied the moment constraints (e.g. if a grid point that was previously non-zero is now set to zero by the ion sheath boundary condition); the symmetrized <span>$\tilde{g}_{E}$</span> will be non-zero at places where the boundary condition forces <span>$\tilde{g}_{s}$</span> to be zero. It is possible to extend the algorithm to allow the constraints to be enforced using only the initial guess of the distribution function at the new timestep, as described below.</p><h2 id="Current-algorithm"><a class="docs-heading-anchor" href="#Current-algorithm">Current algorithm</a><a id="Current-algorithm-1"></a><a class="docs-heading-anchor-permalink" href="#Current-algorithm" title="Permalink"></a></h2><p>After the time advance updates the distribution function, it will in general not obey the constraints, but the errors will be small, with the size depending on the accuracy of the spatial and temporal discretizations. We can take this updated value <span>$\hat{g}_{s}$</span> as an initial guess, to be corrected to give the actual updated value <span>$\tilde{g}_{s}$</span>, which does obey the constraints to machine precision.</p><p>We define the corrected distribution function as</p><p class="math-container">\[\begin{align}
  \tilde{g}_{s}=A\hat{g}_{s}+Bw_{\|}\hat{g}_{s}+Cw_{\|}^{2}\hat{g}_{s}
\end{align}\]</p><p>and define the moments of <span>$\hat{g}_{s}$</span></p><p class="math-container">\[\begin{align}
  I_{n}=\frac{1}{\sqrt{\pi}}\int dw_{\|}w_{\|}^{n}\hat{g}_{s}.
\end{align}\]</p><p>Then the moments of <span>$\tilde{g}_{s}$</span> are</p><p class="math-container">\[\begin{align}
  \frac{1}{\sqrt{\pi}}\int dw_{\|}\tilde{g}_{s}=1 &amp; =\frac{1}{\sqrt{\pi}}\int dw_{\|}\left(A\hat{g}_{s}+Bw_{\|}\hat{g}_{s}+Cw_{\|}^{2}\hat{g}_{s}\right)=AI_{0}+BI_{1}+CI_{2}\\
  \frac{1}{\sqrt{\pi}}\int dw_{\|}w_{\|}\tilde{g}_{s}=0 &amp; =\frac{1}{\sqrt{\pi}}\int dw_{\|}\left(Aw_{\|}\hat{g}_{s}+Bw_{\|}^{2}\hat{g}_{s}+Cw_{\|}^{3}\hat{g}_{s}\right)=AI_{1}+BI_{2}+CI_{3}\\
  \frac{1}{\sqrt{\pi}}\int dw_{\|}w_{\|}^{2}\tilde{g}_{s}=\frac{1}{2} &amp; =\frac{1}{\sqrt{\pi}}\int dw_{\|}\left(Aw_{\|}^{2}\hat{g}_{s}+Bw_{\|}^{3}\hat{g}_{s}+Cw_{\|}^{4}\hat{g}_{s}\right)=AI_{2}+BI_{3}+CI_{4}.
\end{align}\]</p><p>Solving the simultaneous equations for <span>$A$</span>, <span>$B$</span>, <span>$C$</span> gives</p><p class="math-container">\[\begin{align}
  C &amp; =\frac{\frac{1}{2}-AI_{2}-BI_{3}}{I_{4}}\\
  B &amp; =\frac{\left(I_{2}I_{3}-I_{1}I_{4}\right)A-\frac{I_{3}}{2}}{I_{2}I_{4}-I_{3}^{2}}\\
  A &amp; =\frac{I_{2}I_{4}-\frac{I_{2}^{2}}{2}+I_{3}\left(\frac{I_{1}}{2}-I_{3}\right)}{I_{0}\left(I_{2}I_{4}-I_{3}^{2}\right)+I_{1}\left(I_{2}I_{3}-I_{1}I_{4}\right)+I_{2}\left(I_{1}I_{3}-I_{2}^{2}\right)}.
\end{align}\]</p><p>Note that there is no guarantee that <span>$\tilde{g}_{s}$</span> is <span>$\geq0$</span> even if <span>$\hat{g}_{s}\geq0$</span>, although if the violations of the integral constraints are small, it should be true that <span>$A\approx1$</span> while <span>$B$</span> and <span>$C$</span> are small.</p><h3 id="Evolving-u_\\parallel"><a class="docs-heading-anchor" href="#Evolving-u_\\parallel">Evolving <span>$u_\parallel$</span></a><a id="Evolving-u_\\parallel-1"></a><a class="docs-heading-anchor-permalink" href="#Evolving-u_\\parallel" title="Permalink"></a></h3><p>When evolving fewer moments separately, the constraints become simpler. When evolving <span>$n$</span> and <span>$u_\parallel$</span>, only the first two constraints are needed. This corresponds to <span>$C=0$</span> so that</p><p class="math-container">\[\begin{align}
  1 &amp;= AI_0 + BI_1 \\
  0 &amp;= AI_1 + BI_2 \\
  \Rightarrow B &amp;= -\frac{AI_1}{I_2} \\
  AI_0 &amp;= 1 - BI_1 = 1 + \frac{AI_1^2}{I_2} \\
  A &amp;= \frac{1}{I_0 - I_1^2/I_2}
\end{align}\]</p><h3 id="Evolving-n"><a class="docs-heading-anchor" href="#Evolving-n">Evolving <span>$n$</span></a><a id="Evolving-n-1"></a><a class="docs-heading-anchor-permalink" href="#Evolving-n" title="Permalink"></a></h3><p>When evolving only <span>$n$</span> separately, we only need one constraint and the correction is just a re-scaling. This corresponds to <span>$B=0,C=0$</span> so that</p><p class="math-container">\[\begin{align}
  1 &amp;= AI_0 \\
  A &amp;= \frac{1}{I_0}
\end{align}\]</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../debugging-hints/">Debugging »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Wednesday 15 November 2023 14:05">Wednesday 15 November 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
