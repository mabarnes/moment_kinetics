<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>External sources · moment_kinetics</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">moment_kinetics</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../constraints_on_normalized_distribution_function/">Constraints on normalized distribution function</a></li><li><a class="tocitem" href="../debugging-hints/">Debugging</a></li><li><a class="tocitem" href="../developing/">Developing</a></li><li class="is-active"><a class="tocitem" href>External sources</a><ul class="internal"><li><a class="tocitem" href="#Amplitude"><span>Amplitude</span></a></li><li><a class="tocitem" href="#API"><span>API</span></a></li></ul></li><li><a class="tocitem" href="../geometry/">Magnetic Geometry</a></li><li><a class="tocitem" href="../getting_started/">Getting started</a></li><li><a class="tocitem" href="../input_options/">Input Options</a></li><li><a class="tocitem" href="../machine_setup_notes/"><code>machine_setup</code> notes</a></li><li><a class="tocitem" href="../manual_setup/">Manual setup</a></li><li><a class="tocitem" href="../moment_kinetic_equations/">Moment kinetic equations</a></li><li><a class="tocitem" href="../parameter_scans/">Parameter scans</a></li><li><a class="tocitem" href="../post_processing_notes/">Post processing</a></li><li><a class="tocitem" href="../shared_memory_debugging/">Shared memory debugging</a></li><li><a class="tocitem" href="../timestepping/">Timestepping</a></li><li><a class="tocitem" href="../wall_boundary_conditions/">Wall boundary conditions with moment constraints</a></li><li><a class="tocitem" href="../zz_advection/"><code>advection</code></a></li><li><a class="tocitem" href="../zz_analysis/"><code>analysis</code></a></li><li><a class="tocitem" href="../zz_array_allocation/"><code>array_allocation</code></a></li><li><a class="tocitem" href="../zz_bgk/"><code>bgk</code></a></li><li><a class="tocitem" href="../zz_calculus/"><code>calculus</code></a></li><li><a class="tocitem" href="../zz_charge_exchange/"><code>charge_exchange</code></a></li><li><a class="tocitem" href="../zz_chebyshev/"><code>chebyshev</code></a></li><li><a class="tocitem" href="../zz_clenshaw_curtis/"><code>clenshaw_curtis</code></a></li><li><a class="tocitem" href="../zz_command_line_options/"><code>command_line_options</code></a></li><li><a class="tocitem" href="../zz_communication/"><code>communication</code></a></li><li><a class="tocitem" href="../zz_constants/"><code>constants</code></a></li><li><a class="tocitem" href="../zz_continuity/"><code>continuity</code></a></li><li><a class="tocitem" href="../zz_coordinates/"><code>coordinates</code></a></li><li><a class="tocitem" href="../zz_debugging/"><code>debugging</code></a></li><li><a class="tocitem" href="../zz_derivatives/"><code>derivatives</code></a></li><li><a class="tocitem" href="../zz_em_fields/"><code>em_fields</code></a></li><li><a class="tocitem" href="../zz_energy_equation/"><code>energy_equation</code></a></li><li><a class="tocitem" href="../zz_external_sources/"><code>external_sources</code></a></li><li><a class="tocitem" href="../zz_file_io/"><code>file_io</code></a></li><li><a class="tocitem" href="../zz_finite_differences/"><code>finite_differences</code></a></li><li><a class="tocitem" href="../zz_fokker_planck/"><code>fokker_planck</code></a></li><li><a class="tocitem" href="../zz_fokker_planck_calculus/"><code>fokker_planck_calculus</code></a></li><li><a class="tocitem" href="../zz_fokker_planck_test/"><code>fokker_planck_test</code></a></li><li><a class="tocitem" href="../zz_force_balance/"><code>force_balance</code></a></li><li><a class="tocitem" href="../zz_gauss_legendre/"><code>gauss_legendre</code></a></li><li><a class="tocitem" href="../zz_geo/"><code>geo</code></a></li><li><a class="tocitem" href="../zz_initial_conditions/"><code>initial_conditions</code></a></li><li><a class="tocitem" href="../zz_input_structs/"><code>input_structs</code></a></li><li><a class="tocitem" href="../zz_interpolation/"><code>interpolation</code></a></li><li><a class="tocitem" href="../zz_ionization/"><code>ionization</code></a></li><li><a class="tocitem" href="../zz_krook_collisions/"><code>krook_collisions</code></a></li><li><a class="tocitem" href="../zz_load_data/"><code>load_data</code></a></li><li><a class="tocitem" href="../zz_looping/"><code>looping</code></a></li><li><a class="tocitem" href="../zz_makie_post_processing/"><code>makie_post_processing</code></a></li><li><a class="tocitem" href="../zz_manufactured_solns/"><code>manufactured_solns</code></a></li><li><a class="tocitem" href="../zz_moment_constraints/"><code>moment_constraints</code></a></li><li><a class="tocitem" href="../zz_moment_kinetics/"><code>moment_kinetics</code></a></li><li><a class="tocitem" href="../zz_moment_kinetics_input/"><code>moment_kinetics_input</code></a></li><li><a class="tocitem" href="../zz_moment_kinetics_structs/"><code>moment_kinetics_structs</code></a></li><li><a class="tocitem" href="../zz_neutral_r_advection/"><code>neutral_r_advection</code></a></li><li><a class="tocitem" href="../zz_neutral_vz_advection/"><code>neutral_vz_advection</code></a></li><li><a class="tocitem" href="../zz_neutral_z_advection/"><code>neutral_z_advection</code></a></li><li><a class="tocitem" href="../zz_numerical_dissipation/"><code>numerical_dissipation</code></a></li><li><a class="tocitem" href="../zz_plot_MMS_sequence/"><code>plot_MMS_sequence</code></a></li><li><a class="tocitem" href="../zz_plot_sequence/"><code>plot_sequence</code></a></li><li><a class="tocitem" href="../zz_plots_post_processing/"><code>plots_post_processing</code></a></li><li><a class="tocitem" href="../zz_quadrature/"><code>quadrature</code></a></li><li><a class="tocitem" href="../zz_r_advection/"><code>r_advection</code></a></li><li><a class="tocitem" href="../zz_reference_parameters/"><code>reference_parameters</code></a></li><li><a class="tocitem" href="../zz_runge_kutta/"><code>runge_kutta</code></a></li><li><a class="tocitem" href="../zz_source_terms/"><code>source_terms</code></a></li><li><a class="tocitem" href="../zz_time_advance/"><code>time_advance</code></a></li><li><a class="tocitem" href="../zz_type_definitions/"><code>type_definitions</code></a></li><li><a class="tocitem" href="../zz_utils/"><code>utils</code></a></li><li><a class="tocitem" href="../zz_velocity_grid_transforms/"><code>velocity_grid_transforms</code></a></li><li><a class="tocitem" href="../zz_velocity_moments/"><code>velocity_moments</code></a></li><li><a class="tocitem" href="../zz_vpa_advection/"><code>vpa_advection</code></a></li><li><a class="tocitem" href="../zz_z_advection/"><code>z_advection</code></a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>External sources</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>External sources</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/mabarnes/moment_kinetics/blob/master/docs/src/external_sources_notes.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="External-sources"><a class="docs-heading-anchor" href="#External-sources">External sources</a><a id="External-sources-1"></a><a class="docs-heading-anchor-permalink" href="#External-sources" title="Permalink"></a></h1><p>Sometimes it is useful to have a source term for the plasma or neutrals (the <span>$S_i$</span> and <span>$S_n$</span> of <a href="../moment_kinetic_equations/#Moment-kinetic-equations">Moment kinetic equations</a>). The currently-implemented source term has the form of a Maxwellian with constant temperature and spatially-varying amplitude</p><p class="math-container">\[\begin{align}
S_i &amp;= A_i(r,z) \frac{1}{(\pi)^{3/2} (2 T_{\mathrm{source},i} / m_i)^{3/2}} \exp\left( -\frac{(v_\perp^2 + v_\parallel^2)}{T_{\mathrm{source},i}} \right) \\
S_n &amp;= A_n(r,z) \frac{1}{(\pi)^{3/2} (2 T_{\mathrm{source},n} / m_n)^{3/2}} \exp\left( -\frac{(v_\zeta^2 + v_r^2 + v_z^2)}{T_{\mathrm{source},n}} \right)
\end{align}\]</p><p>or in 1V simulations that do not include <span>$v_\perp$</span>, <span>$v_\zeta$</span>, <span>$v_r$</span> dimensions</p><p class="math-container">\[\begin{align}
S_i &amp;= A_i(r,z) \frac{1}{sqrt{\pi} \sqrt{2 T_{\mathrm{source},i} / m_i}} \exp\left( -\frac{v_\perp^2}{T_{\mathrm{source},i}} \right) \\
S_n &amp;= A_n(r,z) \frac{1}{sqrt{\pi} \sqrt{2 T_{\mathrm{source},n} / m_n}} \exp\left( -\frac{v_z^2}{T_{\mathrm{source},n}} \right)
\end{align}\]</p><p>The sources are controlled by options in the <code>[ion_source]</code> and <code>[neutral_source]</code> sections of the input file. The source terms are enabled by setting <code>active = true</code>. The constant temperature is set with the <code>source_T</code> option (default is 1 for ions and <span>$T_\mathrm{wall}$</span> for neutrals). The amplitude can be set or controlled in various ways depending on the <code>source_type</code> setting, as explained in the following subsection.</p><p>Note that all the settings mentioned below have values given in normalised units (in the same way as the settings for initial profiles, etc.).</p><h2 id="Amplitude"><a class="docs-heading-anchor" href="#Amplitude">Amplitude</a><a id="Amplitude-1"></a><a class="docs-heading-anchor-permalink" href="#Amplitude" title="Permalink"></a></h2><h3 id="Fixed-amplitude-(default)"><a class="docs-heading-anchor" href="#Fixed-amplitude-(default)">Fixed amplitude (default)</a><a id="Fixed-amplitude-(default)-1"></a><a class="docs-heading-anchor-permalink" href="#Fixed-amplitude-(default)" title="Permalink"></a></h3><p>When <code>source_type = &quot;Maxwellian&quot;</code> (the default), the amplitude of the source is fixed in time and controled by the profile options. The profile has the form</p><p class="math-container">\[A(r,z) = A_0 R(r) Z(z)\]</p><p>where <span>$A_0$</span> is given by the <code>source_strength</code> option. <span>$R(r)$</span> and <span>$Z(z)$</span> are controlled by the <code>r_profile</code> and <code>z_profile</code> options respectively. The available options for either are the same, so letting <code>x</code> stand for either of <code>r</code> or <code>z</code>, and <code>X</code> for the corresponding <code>R</code> or <code>Z</code>:</p><ul><li><code>x_profile = &quot;constant&quot;</code> (the default) means <span>$X(x)=1$</span>.</li><li><code>x_profile = &quot;gaussian&quot;</code> means   <span>$X(x) = (1 - X_\mathrm{min}) \exp\left( -\left(\frac{x}{w}\right)^2 \right) + X_\mathrm{min}$</span>   where <span>$X_\mathrm{min}$</span> is set by <code>x_relative_minimum</code> and <span>$w$</span> is set by   <code>x_width</code>.</li><li><code>x_profile = &quot;parabolic&quot;</code> means   <span>$P(x) = \left( 1 - \left(\frac{2x}{w}\right)^2 \right)$</span>,    <span>$X(x) = (1 - X_\mathrm{min}) H(P(x)) P(x) + X_\mathrm{min}$</span>   where <span>$X_\mathrm{min}$</span> is set by <code>x_relative_minimum</code> and <span>$w$</span> is set by   <code>x_width</code>. The effect of the step function <span>$H$</span> is to let the profile be a   quadratic in the range <span>$-w/2 &lt; x &lt; w/2$</span>, but equal to a floor (by default   0, so that the source is just not allowed to become negative) outside that   range.</li></ul><h3 id="Midpoint-density-controller"><a class="docs-heading-anchor" href="#Midpoint-density-controller">Midpoint density controller</a><a id="Midpoint-density-controller-1"></a><a class="docs-heading-anchor-permalink" href="#Midpoint-density-controller" title="Permalink"></a></h3><p>When <code>source_type = &quot;density_midpoint_control&quot;</code> a PI controller (<a href="https://en.wikipedia.org/wiki/Proportional%E2%80%93integral%E2%80%93derivative_controller">Wikipedia</a>) is used to control the ion/neutral density. The &#39;midpoint&#39; for the purposes of this controller is the point on the grid where <span>$r=0$</span> and <span>$z=0$</span> (there must be a grid point there).</p><p>The spatial profile of the source (<span>$R(r)$</span> and <span>$Z(z)$</span>) is set in the same way as for the &#39;Fixed amplitude&#39; source (see above), but now the prefactor changes with time</p><p class="math-container">\[A(r,z) = A_0(t) R(r) Z(z).\]</p><p>The prefactor <span>$A_0(t)$</span> is controlled to set the midpoint density to some value <span>$n(r=0,z=0)\rightarrow n_\mathrm{PI}$</span> where <span>$n_\mathrm{PI}$</span> is set by <code>PI_density_target_amplitude</code>. Specifically,</p><p class="math-container">\[\begin{align}
  A_0(t) &amp;= \mathtt{max}\left(P(n_\mathrm{PI} - n(r=0,z=0)) + \iota(t), 0\right) \\
  \frac{\partial \iota}{\partial t} &amp;= I(n_\mathrm{PI} - n(r=0,z=0)).
\end{align}\]</p><p>The &#39;proportional&#39; coefficient <span>$P$</span> is set by <code>PI_density_controller_P</code> and the &#39;integral&#39; coefficient <span>$I$</span> is set by <code>PI_density_controller_I</code>. The <span>$\mathrm{max}(\ldots,0)$</span> is to ensure that the &#39;source term&#39; is never negative (i.e. a sink), to avoid the possibility of driving the system towards negative density.</p><h3 id="Density-profile-controller"><a class="docs-heading-anchor" href="#Density-profile-controller">Density profile controller</a><a id="Density-profile-controller-1"></a><a class="docs-heading-anchor-permalink" href="#Density-profile-controller" title="Permalink"></a></h3><p>When <code>source_type = &quot;density_profile_control&quot;</code> a PI controller (<a href="https://en.wikipedia.org/wiki/Proportional%E2%80%93integral%E2%80%93derivative_controller">Wikipedia</a>) is used to control the ion/neutral density profile.</p><p>The target profile is</p><p class="math-container">\[n_\mathrm{PI}(r,z) = n_{\mathrm{PI},0} R(r) Z(z)\]</p><p>where <span>$n_{\mathrm{PI},0}$</span> is set by <code>PI_density_target_amplitude</code> and <span>$R(r)$</span> and <span>$Z(z)$</span> are set as described in <a href="#Fixed-amplitude-(default)">Fixed amplitude (default)</a>.</p><p>The source amplitude <span>$A(r,z)$</span> is controlled to set the density profile to <span>$n(r,z)\rightarrow n_\mathrm{PI}(r,z)$</span>. Specifically,</p><p class="math-container">\[\begin{align}
  A(r,z) &amp;= \mathtt{max}\left(P(n_\mathrm{PI}(r,z) - n(r,z)) + \iota(t,r,z), 0\right) \\
  \frac{\partial \iota(t,r,z)}{\partial t} &amp;= I(n_\mathrm{PI}(r,z) - n(r,z)).
\end{align}\]</p><p>The &#39;proportional&#39; coefficient <span>$P$</span> is set by <code>PI_density_controller_P</code> and the &#39;integral&#39; coefficient <span>$I$</span> is set by <code>PI_density_controller_I</code>. The <span>$\mathrm{max}(\ldots,0)$</span> is to ensure that the &#39;source term&#39; is never negative (i.e. a sink), to avoid the possibility of driving the system towards negative density.</p><h3 id="Recycling"><a class="docs-heading-anchor" href="#Recycling">Recycling</a><a id="Recycling-1"></a><a class="docs-heading-anchor-permalink" href="#Recycling" title="Permalink"></a></h3><p>The source of neutrals can be set so that some fraction of the flux of ions to the walls is recycled into the volume of the domain as neutrals by using the <code>source_type = &quot;recycling&quot;</code> option.</p><p>The profile is set up whose spatial integral is 1</p><p class="math-container">\[A(r,z) = A_0 R(r) Z(z)\]</p><p>where <span>$A_0 = \left[\int dr\,dz\, R(r) Z(z)\right]^{-1}$</span> and <span>$R(r)$</span> and <span>$Z(z)$</span> are set as described in <a href="#Fixed-amplitude-(default)">Fixed amplitude (default)</a>. The source is</p><p class="math-container">\[S_n(t,r,z) = F(t) A(r,z)\]</p><p>where <span>$F(t)$</span> is the sum of the integrated ion flux to the lower and upper targets.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>The target flux calculated for this controller does not account for magnetic field lines that are not perpendicular to the wall, or for drifts to the target, so needs updating (within <a href="../zz_external_sources/#moment_kinetics.external_sources.external_neutral_source_controller!-NTuple{6, Any}"><code>moment_kinetics.external_sources.external_neutral_source_controller!</code></a>) to be used in 2D simulations.</p></div></div><h3 id="Energy-source"><a class="docs-heading-anchor" href="#Energy-source">Energy source</a><a id="Energy-source-1"></a><a class="docs-heading-anchor-permalink" href="#Energy-source" title="Permalink"></a></h3><p>When <code>source_type = &quot;energy&quot;</code>, rather than just adding particles with temperature <span>$T_\mathrm{source},s$</span>, the existing plasma or neutrals in the domain are swapped with plasma/neutrals from a Maxwellian with <span>$T_\mathrm{source},s$</span>, so that the density is unchanged, but energy is added (or potentially removed if the plasma/neutrals are hotter than <span>$T_\mathrm{source},s$</span>).</p><p class="math-container">\[\begin{align}
S_i &amp;= A_i(r,z) \left[ \frac{1}{(\pi)^{3/2} (2 T_{\mathrm{source},i} / m_i)^{3/2}} \exp\left( -\frac{(v_\perp^2 + v_\parallel^2)}{T_{\mathrm{source},i}} - f_i(v_\perp, v_\parallel) \right) \right] \\
S_n &amp;= A_n(r,z) \left[ \frac{1}{(\pi)^{3/2} (2 T_{\mathrm{source},n} / m_n)^{3/2}} \exp\left( -\frac{(v_\zeta^2 + v_r^2 + v_z^2)}{T_{\mathrm{source},n}} - f_n(v_\zeta, v_r, v_z) \right) \right]
\end{align}\]</p><p>or in 1V simulations</p><p class="math-container">\[\begin{align}
S_i &amp;= A_i(r,z) \left[ \frac{1}{sqrt{\pi} \sqrt{2 T_{\mathrm{source},i} / m_i}} \exp\left( -\frac{v_\perp^2}{T_{\mathrm{source},i}} - f_i(v_\parallel) \right) \right] \\
S_n &amp;= A_n(r,z) \left[ \frac{1}{sqrt{\pi} \sqrt{2 T_{\mathrm{source},n} / m_n}} \exp\left( -\frac{v_z^2}{T_{\mathrm{source},n}} - f_n(v_z) \right) \right]
\end{align}\]</p><p>Note that this source does not give a fixed power input (although that might be a nice feature to have), it just swaps plasma/neutral particles at a constant rate.</p><h2 id="API"><a class="docs-heading-anchor" href="#API">API</a><a id="API-1"></a><a class="docs-heading-anchor-permalink" href="#API" title="Permalink"></a></h2><p>See <a href="../zz_external_sources/#external_sources">external_sources</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../developing/">« Developing</a><a class="docs-footer-nextpage" href="../geometry/">Magnetic Geometry »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Thursday 25 April 2024 14:51">Thursday 25 April 2024</span>. Using Julia version 1.10.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
